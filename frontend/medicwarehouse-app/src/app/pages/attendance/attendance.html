<app-navbar></app-navbar>

<div class="attendance-container">
  <div class="page-header">
    <div>
      <h1>Atendimento ao Paciente</h1>
      <p>Registro de consulta e prontuário médico</p>
    </div>
    <button class="btn btn-secondary" routerLink="/appointments">Voltar para Agenda</button>
  </div>

  @if (errorMessage()) {
    <div class="alert alert-error">{{ errorMessage() }}</div>
  }
  @if (successMessage()) {
    <div class="alert alert-success">{{ successMessage() }}</div>
  }

  @if (isLoading()) {
    <div class="loading">Carregando...</div>
  } @else {
    <div class="attendance-layout">
      <!-- Left Panel - Patient Info and Timer -->
      <div class="left-panel">
        <!-- Patient Info Card -->
        <div class="card patient-info">
          <h3>Informações do Paciente</h3>
          @if (patient()) {
            <div class="patient-details">
              <div class="detail-row">
                <span class="label">Nome:</span>
                <span class="value">{{ patient()!.name }}</span>
              </div>
              <div class="detail-row">
                <span class="label">Idade:</span>
                <span class="value">{{ patient()!.age }} anos</span>
              </div>
              <div class="detail-row">
                <span class="label">CPF:</span>
                <span class="value">{{ patient()!.document }}</span>
              </div>
              <div class="detail-row">
                <span class="label">Telefone:</span>
                <span class="value">{{ patient()!.phone }}</span>
              </div>
              @if (patient()!.allergies) {
                <div class="detail-row highlight">
                  <span class="label">Alergias:</span>
                  <span class="value">{{ patient()!.allergies }}</span>
                </div>
              }
            </div>
          } @else {
            <p class="text-muted">Carregando informações do paciente...</p>
          }
        </div>

        <!-- Timer Card -->
        <div class="card timer-card">
          <h3>Tempo de Consulta</h3>
          <div class="timer-display">
            {{ formatTime(elapsedSeconds()) }}
          </div>
          <p class="timer-info">
            @if (medicalRecord()?.consultationEndTime) {
              Consulta finalizada
            } @else {
              Consulta em andamento
            }
          </p>
        </div>

        <!-- Patient History Card -->
        <div class="card patient-history">
          <h3>Histórico de Consultas</h3>
          @if (patientHistory().length > 0) {
            <div class="history-list">
              @for (record of patientHistory(); track record.id) {
                <div class="history-item">
                  <div class="history-date">
                    {{ record.consultationStartTime | date: 'dd/MM/yyyy' }}
                  </div>
                  <div class="history-info">
                    <p><strong>Diagnóstico:</strong> {{ record.diagnosis || 'N/A' }}</p>
                    <p><strong>Duração:</strong> {{ record.consultationDurationMinutes }} min</p>
                  </div>
                </div>
              }
            </div>
          } @else {
            <p class="text-muted">Nenhum histórico de consultas</p>
          }
        </div>
      </div>

      <!-- Right Panel - Medical Record Form -->
      <div class="right-panel">
        <form [formGroup]="attendanceForm" class="medical-record-form">
          <div class="card">
            <h3>Prontuário Médico</h3>
            
            <div class="form-group">
              <label for="diagnosis">Diagnóstico</label>
              <textarea 
                id="diagnosis" 
                formControlName="diagnosis" 
                class="form-control" 
                rows="4"
                placeholder="Descreva o diagnóstico do paciente..."
              ></textarea>
            </div>

            <div class="form-group">
              <label for="prescription">Prescrição Médica</label>
              <textarea 
                id="prescription" 
                formControlName="prescription" 
                class="form-control prescription-area" 
                rows="8"
                placeholder="Receite medicamentos, dosagens, e instruções de uso..."
              ></textarea>
              <button type="button" class="btn btn-outline btn-print" (click)="onPrint()">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="6 9 6 2 18 2 18 9"></polyline>
                  <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path>
                  <rect x="6" y="14" width="12" height="8"></rect>
                </svg>
                Imprimir Receita
              </button>
            </div>

            <div class="form-group">
              <label for="notes">Observações</label>
              <textarea 
                id="notes" 
                formControlName="notes" 
                class="form-control" 
                rows="4"
                placeholder="Anotações adicionais sobre a consulta..."
              ></textarea>
            </div>
          </div>

          <div class="form-actions">
            <button type="button" class="btn btn-secondary" (click)="onSave()" [disabled]="isLoading()">
              Salvar Prontuário
            </button>
            <button type="button" class="btn btn-primary" (click)="onComplete()" [disabled]="isLoading() || medicalRecord()?.consultationEndTime">
              {{ medicalRecord()?.consultationEndTime ? 'Consulta Finalizada' : 'Finalizar Atendimento' }}
            </button>
          </div>
        </form>
      </div>
    </div>
  }
</div>

<!-- Print-only section -->
<div class="print-only">
  @if (patient() && medicalRecord()) {
    <div class="prescription-print">
      <h2>Prescrição Médica</h2>
      <div class="prescription-header">
        <p><strong>Paciente:</strong> {{ patient()!.name }}</p>
        <p><strong>Data:</strong> {{ medicalRecord()!.consultationStartTime | date: 'dd/MM/yyyy HH:mm' }}</p>
      </div>
      <div class="prescription-content">
        {{ attendanceForm.get('prescription')?.value }}
      </div>
    </div>
  }
</div>
