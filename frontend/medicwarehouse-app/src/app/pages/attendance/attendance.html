<app-navbar></app-navbar>

<div class="attendance-container">
  <div class="page-header">
    <div>
      <h1>Atendimento ao Paciente</h1>
      <p>Registro de consulta e prontu√°rio m√©dico</p>
    </div>
    <button class="btn btn-secondary" routerLink="/appointments">Voltar para Agenda</button>
  </div>

  @if (errorMessage()) {
    <div class="alert alert-error">{{ errorMessage() }}</div>
  }
  @if (successMessage()) {
    <div class="alert alert-success">{{ successMessage() }}</div>
  }

  @if (isLoading()) {
    <div class="loading">Carregando...</div>
  } @else {
    <div class="attendance-layout">
      <!-- Left Panel - Patient Info and Timer -->
      <div class="left-panel">
        <!-- Patient Info Card -->
        <div class="card patient-info">
          <h3>Informa√ß√µes do Paciente</h3>
          @if (patient()) {
            <div class="patient-details">
              <div class="detail-row">
                <span class="label">Nome:</span>
                <span class="value">{{ patient()!.name }}</span>
              </div>
              <div class="detail-row">
                <span class="label">Idade:</span>
                <span class="value">{{ patient()!.age }} anos</span>
              </div>
              <div class="detail-row">
                <span class="label">CPF:</span>
                <span class="value">{{ patient()!.document }}</span>
              </div>
              <div class="detail-row">
                <span class="label">Telefone:</span>
                <span class="value">{{ patient()!.phone }}</span>
              </div>
              @if (patient()!.allergies) {
                <div class="detail-row highlight">
                  <span class="label">Alergias:</span>
                  <span class="value">{{ patient()!.allergies }}</span>
                </div>
              }
              @if (appointment()) {
                <div class="detail-row" [class.highlight]="!appointment()!.isPaid">
                  <span class="label">Status de Pagamento:</span>
                  <span class="value">
                    @if (appointment()!.isPaid) {
                      <span class="badge badge-success">‚úì Pago</span>
                      @if (appointment()!.paymentReceivedBy) {
                        <small>({{ appointment()!.paymentReceivedBy }})</small>
                      }
                    } @else {
                      <span class="badge badge-warning">‚ö†Ô∏è Pendente</span>
                    }
                  </span>
                </div>
              }
            </div>
          } @else {
            <p class="text-muted">Carregando informa√ß√µes do paciente...</p>
          }
          
          <!-- Payment Action Button -->
          @if (appointment() && !appointment()!.isPaid) {
            <button type="button" class="btn btn-sm btn-outline-primary mt-2" (click)="showPaymentDialog.set(true)">
              Registrar Pagamento
            </button>
          }
        </div>

        <!-- Timer Card -->
        <div class="card timer-card">
          <h3>Tempo de Consulta</h3>
          <div class="timer-display">
            {{ formatTime(elapsedSeconds()) }}
          </div>
          <p class="timer-info">
            @if (medicalRecord()?.consultationEndTime) {
              Consulta finalizada
            } @else {
              Consulta em andamento
            }
          </p>
        </div>

        <!-- Patient History Card -->
        <div class="card patient-history">
          <h3>Hist√≥rico de Consultas</h3>
          @if (patientHistory().length > 0) {
            <div class="history-list">
              @for (record of patientHistory(); track record.id) {
                <div class="history-item">
                  <div class="history-date">
                    {{ record.consultationStartTime | date: 'dd/MM/yyyy' }}
                  </div>
                  <div class="history-info">
                    <p><strong>Diagn√≥stico:</strong> {{ record.diagnosis || 'N/A' }}</p>
                    <p><strong>Dura√ß√£o:</strong> {{ record.consultationDurationMinutes }} min</p>
                  </div>
                </div>
              }
            </div>
          } @else {
            <p class="text-muted">Nenhum hist√≥rico de consultas</p>
          }
        </div>
      </div>

      <!-- Right Panel - Medical Record Form -->
      <div class="right-panel">
        <form [formGroup]="attendanceForm" class="medical-record-form">
          <!-- CFM 1.821 - Anamnese (Required Fields) -->
          <div class="card">
            <h3>Anamnese - CFM 1.821 <span class="required-badge">Obrigat√≥rio</span></h3>
            
            <div class="form-group">
              <label for="chiefComplaint">Queixa Principal <span class="required">*</span></label>
              <textarea 
                id="chiefComplaint" 
                formControlName="chiefComplaint" 
                class="form-control"
                rows="2"
                placeholder="Descreva a queixa principal do paciente (m√≠nimo 10 caracteres)..."
              ></textarea>
              @if (attendanceForm.get('chiefComplaint')?.invalid && attendanceForm.get('chiefComplaint')?.touched) {
                <div class="error-message">Queixa principal √© obrigat√≥ria (m√≠nimo 10 caracteres)</div>
              }
            </div>

            <div class="form-group">
              <label for="historyOfPresentIllness">Hist√≥ria da Doen√ßa Atual (HDA) <span class="required">*</span></label>
              <textarea 
                id="historyOfPresentIllness" 
                formControlName="historyOfPresentIllness" 
                class="form-control"
                rows="4"
                placeholder="Descreva a hist√≥ria da doen√ßa atual do paciente (m√≠nimo 50 caracteres)..."
              ></textarea>
              @if (attendanceForm.get('historyOfPresentIllness')?.invalid && attendanceForm.get('historyOfPresentIllness')?.touched) {
                <div class="error-message">Hist√≥ria da doen√ßa atual √© obrigat√≥ria (m√≠nimo 50 caracteres)</div>
              }
            </div>

            <div class="form-group">
              <label for="pastMedicalHistory">Hist√≥ria Patol√≥gica Pregressa (HPP)</label>
              <textarea 
                id="pastMedicalHistory" 
                formControlName="pastMedicalHistory" 
                class="form-control"
                rows="3"
                placeholder="Doen√ßas anteriores, cirurgias, interna√ß√µes..."
              ></textarea>
            </div>

            <div class="form-group">
              <label for="familyHistory">Hist√≥ria Familiar</label>
              <textarea 
                id="familyHistory" 
                formControlName="familyHistory" 
                class="form-control"
                rows="2"
                placeholder="Hist√≥rico de doen√ßas na fam√≠lia..."
              ></textarea>
            </div>

            <div class="form-group">
              <label for="lifestyleHabits">H√°bitos de Vida</label>
              <textarea 
                id="lifestyleHabits" 
                formControlName="lifestyleHabits" 
                class="form-control"
                rows="2"
                placeholder="Tabagismo, etilismo, atividade f√≠sica, alimenta√ß√£o..."
              ></textarea>
            </div>

            <div class="form-group">
              <label for="currentMedications">Medica√ß√µes em Uso</label>
              <textarea 
                id="currentMedications" 
                formControlName="currentMedications" 
                class="form-control"
                rows="2"
                placeholder="Medicamentos que o paciente est√° utilizando atualmente..."
              ></textarea>
            </div>
          </div>

          <!-- CFM 1.821 - Clinical Examination -->
          <div class="card">
            <div class="card-header-flex">
              <h3>Exame Cl√≠nico - CFM 1.821 <span class="required-badge">Obrigat√≥rio</span></h3>
              <button type="button" class="btn btn-outline" (click)="toggleAddClinicalExamination()">
                {{ showAddClinicalExamination() ? 'Cancelar' : '+ Adicionar Exame Cl√≠nico' }}
              </button>
            </div>

            @if (showAddClinicalExamination()) {
              <form [formGroup]="clinicalExaminationForm" class="add-form">
                <div class="form-group">
                  <label for="systematicExamination">Exame F√≠sico Sistem√°tico <span class="required">*</span></label>
                  <textarea 
                    id="systematicExamination" 
                    formControlName="systematicExamination" 
                    class="form-control"
                    rows="4"
                    placeholder="Descreva o exame f√≠sico do paciente por sistemas (m√≠nimo 20 caracteres)..."
                  ></textarea>
                  @if (clinicalExaminationForm.get('systematicExamination')?.invalid && clinicalExaminationForm.get('systematicExamination')?.touched) {
                    <div class="error-message">Exame f√≠sico √© obrigat√≥rio (m√≠nimo 20 caracteres)</div>
                  }
                </div>

                <div class="vital-signs-grid">
                  <div class="form-group">
                    <label for="bloodPressureSystolic">PA Sist√≥lica (mmHg)</label>
                    <input 
                      type="number" 
                      id="bloodPressureSystolic" 
                      formControlName="bloodPressureSystolic" 
                      class="form-control"
                      placeholder="120"
                      min="50"
                      max="300"
                    />
                  </div>
                  <div class="form-group">
                    <label for="bloodPressureDiastolic">PA Diast√≥lica (mmHg)</label>
                    <input 
                      type="number" 
                      id="bloodPressureDiastolic" 
                      formControlName="bloodPressureDiastolic" 
                      class="form-control"
                      placeholder="80"
                      min="30"
                      max="200"
                    />
                  </div>
                  <div class="form-group">
                    <label for="heartRate">FC (bpm)</label>
                    <input 
                      type="number" 
                      id="heartRate" 
                      formControlName="heartRate" 
                      class="form-control"
                      placeholder="72"
                      min="30"
                      max="220"
                    />
                  </div>
                  <div class="form-group">
                    <label for="respiratoryRate">FR (irpm)</label>
                    <input 
                      type="number" 
                      id="respiratoryRate" 
                      formControlName="respiratoryRate" 
                      class="form-control"
                      placeholder="16"
                      min="8"
                      max="60"
                    />
                  </div>
                  <div class="form-group">
                    <label for="temperature">Temperatura (¬∞C)</label>
                    <input 
                      type="number" 
                      id="temperature" 
                      formControlName="temperature" 
                      class="form-control"
                      placeholder="36.5"
                      step="0.1"
                      min="32"
                      max="45"
                    />
                  </div>
                  <div class="form-group">
                    <label for="oxygenSaturation">SatO2 (%)</label>
                    <input 
                      type="number" 
                      id="oxygenSaturation" 
                      formControlName="oxygenSaturation" 
                      class="form-control"
                      placeholder="98"
                      min="0"
                      max="100"
                    />
                  </div>
                </div>

                <div class="form-group">
                  <label for="generalState">Estado Geral</label>
                  <input 
                    type="text" 
                    id="generalState" 
                    formControlName="generalState" 
                    class="form-control"
                    placeholder="Paciente em bom estado geral, consciente, orientado..."
                  />
                </div>

                <button type="button" class="btn btn-primary" (click)="onAddClinicalExamination()" [disabled]="!clinicalExaminationForm.valid">
                  Adicionar Exame Cl√≠nico
                </button>
              </form>
            }

            @if (clinicalExaminations().length > 0) {
              <div class="examinations-list">
                @for (exam of clinicalExaminations(); track exam.id) {
                  <div class="examination-item">
                    <div class="exam-vital-signs">
                      @if (exam.bloodPressureSystolic && exam.bloodPressureDiastolic) {
                        <span class="vital-sign">PA: {{ exam.bloodPressureSystolic }}/{{ exam.bloodPressureDiastolic }} mmHg</span>
                      }
                      @if (exam.heartRate) {
                        <span class="vital-sign">FC: {{ exam.heartRate }} bpm</span>
                      }
                      @if (exam.respiratoryRate) {
                        <span class="vital-sign">FR: {{ exam.respiratoryRate }} irpm</span>
                      }
                      @if (exam.temperature) {
                        <span class="vital-sign">T: {{ exam.temperature }}¬∞C</span>
                      }
                      @if (exam.oxygenSaturation) {
                        <span class="vital-sign">SatO2: {{ exam.oxygenSaturation }}%</span>
                      }
                    </div>
                    @if (exam.generalState) {
                      <div class="exam-general"><strong>Estado Geral:</strong> {{ exam.generalState }}</div>
                    }
                    <div class="exam-systematic"><strong>Exame F√≠sico:</strong> {{ exam.systematicExamination }}</div>
                    <div class="exam-date">{{ exam.createdAt | date: 'dd/MM/yyyy HH:mm' }}</div>
                  </div>
                }
              </div>
            } @else {
              <p class="text-muted">Nenhum exame cl√≠nico registrado. √â obrigat√≥rio adicionar pelo menos um exame cl√≠nico.</p>
            }
          </div>

          <!-- CFM 1.821 - Diagnostic Hypotheses -->
          <div class="card">
            <div class="card-header-flex">
              <h3>Hip√≥teses Diagn√≥sticas - CFM 1.821 <span class="required-badge">Obrigat√≥rio</span></h3>
              <button type="button" class="btn btn-outline" (click)="toggleAddDiagnosis()">
                {{ showAddDiagnosis() ? 'Cancelar' : '+ Adicionar Diagn√≥stico' }}
              </button>
            </div>

            @if (showAddDiagnosis()) {
              <form [formGroup]="diagnosticForm" class="add-form">
                <div class="form-group">
                  <label for="description">Descri√ß√£o do Diagn√≥stico <span class="required">*</span></label>
                  <input 
                    type="text" 
                    id="description" 
                    formControlName="description" 
                    class="form-control"
                    placeholder="Ex: Hipertens√£o Arterial Essencial"
                  />
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label for="icd10Code">C√≥digo CID-10 <span class="required">*</span></label>
                    <input 
                      type="text" 
                      id="icd10Code" 
                      formControlName="icd10Code" 
                      class="form-control"
                      placeholder="Ex: I10, J20.9, Z99.01"
                      maxlength="10"
                    />
                    @if (diagnosticForm.get('icd10Code')?.invalid && diagnosticForm.get('icd10Code')?.touched) {
                      <div class="error-message">Formato CID-10 inv√°lido (Ex: A00, J20.9)</div>
                    }
                  </div>
                  <div class="form-group">
                    <label for="type">Tipo</label>
                    <select id="type" formControlName="type" class="form-control">
                      @for (type of diagnosisTypes; track type) {
                        <option [value]="type">{{ diagnosisTypeLabels[type] }}</option>
                      }
                    </select>
                  </div>
                </div>

                <button type="button" class="btn btn-primary" (click)="onAddDiagnosis()" [disabled]="!diagnosticForm.valid">
                  Adicionar Diagn√≥stico
                </button>
              </form>
            }

            @if (diagnosticHypotheses().length > 0) {
              <div class="diagnoses-list">
                @for (diagnosis of diagnosticHypotheses(); track diagnosis.id) {
                  <div class="diagnosis-item">
                    <div class="diagnosis-header">
                      <strong>{{ diagnosis.description }}</strong>
                      <span class="diagnosis-code">CID-10: {{ diagnosis.icd10Code }}</span>
                      <span class="diagnosis-type-badge type-{{ diagnosis.type }}">{{ diagnosisTypeLabels[diagnosis.type] }}</span>
                      <button type="button" class="btn-remove" (click)="removeDiagnosis(diagnosis)" title="Remover">
                        ‚úï
                      </button>
                    </div>
                    <div class="diagnosis-date">{{ diagnosis.diagnosedAt | date: 'dd/MM/yyyy HH:mm' }}</div>
                  </div>
                }
              </div>
            } @else {
              <p class="text-muted">Nenhuma hip√≥tese diagn√≥stica registrada. √â obrigat√≥rio adicionar pelo menos um diagn√≥stico com CID-10.</p>
            }
          </div>

          <!-- CFM 1.821 - Informed Consent -->
          <div class="card">
            <div class="card-header-flex">
              <h3>Consentimento Informado - CFM 1.821 <span class="required-badge">Obrigat√≥rio</span></h3>
            </div>
            
            @if (medicalRecord()?.id && patient()?.id) {
              <app-informed-consent-form 
                [medicalRecordId]="medicalRecord()!.id"
                [patientId]="patient()!.id"
                (consentCreated)="onConsentCreated($event)"
              ></app-informed-consent-form>
            } @else {
              <p class="text-muted">
                ‚ö†Ô∏è Salve o prontu√°rio primeiro para registrar o consentimento informado.
              </p>
            }
          </div>

          <!-- CFM 1.821 - Therapeutic Plan -->
          <div class="card">
            <div class="card-header-flex">
              <h3>Plano Terap√™utico - CFM 1.821 <span class="required-badge">Obrigat√≥rio</span></h3>
              <button type="button" class="btn btn-outline" (click)="toggleAddTherapeuticPlan()">
                {{ showAddTherapeuticPlan() ? 'Cancelar' : '+ Adicionar Plano Terap√™utico' }}
              </button>
            </div>

            @if (showAddTherapeuticPlan()) {
              <form [formGroup]="therapeuticPlanForm" class="add-form">
                <div class="form-group">
                  <label for="treatment">Tratamento/Conduta <span class="required">*</span></label>
                  <textarea 
                    id="treatment" 
                    formControlName="treatment" 
                    class="form-control"
                    rows="3"
                    placeholder="Descreva o tratamento e conduta para o paciente (m√≠nimo 20 caracteres)..."
                  ></textarea>
                  @if (therapeuticPlanForm.get('treatment')?.invalid && therapeuticPlanForm.get('treatment')?.touched) {
                    <div class="error-message">Tratamento √© obrigat√≥rio (m√≠nimo 20 caracteres)</div>
                  }
                </div>

                <div class="form-group">
                  <label for="medicationPrescription">Prescri√ß√£o Medicamentosa</label>
                  <textarea 
                    id="medicationPrescription" 
                    formControlName="medicationPrescription" 
                    class="form-control"
                    rows="3"
                    placeholder="Medicamentos prescritos, dosagens e instru√ß√µes..."
                  ></textarea>
                </div>

                <div class="form-group">
                  <label for="examRequests">Solicita√ß√£o de Exames</label>
                  <textarea 
                    id="examRequests" 
                    formControlName="examRequests" 
                    class="form-control"
                    rows="2"
                    placeholder="Exames solicitados..."
                  ></textarea>
                </div>

                <div class="form-group">
                  <label for="referrals">Encaminhamentos</label>
                  <textarea 
                    id="referrals" 
                    formControlName="referrals" 
                    class="form-control"
                    rows="2"
                    placeholder="Encaminhamentos para especialistas..."
                  ></textarea>
                </div>

                <div class="form-group">
                  <label for="patientGuidance">Orienta√ß√µes ao Paciente</label>
                  <textarea 
                    id="patientGuidance" 
                    formControlName="patientGuidance" 
                    class="form-control"
                    rows="2"
                    placeholder="Orienta√ß√µes e recomenda√ß√µes..."
                  ></textarea>
                </div>

                <div class="form-group">
                  <label for="returnDate">Data de Retorno</label>
                  <input 
                    type="date" 
                    id="returnDate" 
                    formControlName="returnDate" 
                    class="form-control"
                  />
                </div>

                <button type="button" class="btn btn-primary" (click)="onAddTherapeuticPlan()" [disabled]="!therapeuticPlanForm.valid">
                  Adicionar Plano Terap√™utico
                </button>
              </form>
            }

            @if (therapeuticPlans().length > 0) {
              <div class="plans-list">
                @for (plan of therapeuticPlans(); track plan.id) {
                  <div class="plan-item">
                    <div class="plan-treatment"><strong>Tratamento:</strong> {{ plan.treatment }}</div>
                    @if (plan.medicationPrescription) {
                      <div class="plan-medication"><strong>Prescri√ß√£o:</strong> {{ plan.medicationPrescription }}</div>
                    }
                    @if (plan.examRequests) {
                      <div class="plan-exams"><strong>Exames:</strong> {{ plan.examRequests }}</div>
                    }
                    @if (plan.referrals) {
                      <div class="plan-referrals"><strong>Encaminhamentos:</strong> {{ plan.referrals }}</div>
                    }
                    @if (plan.patientGuidance) {
                      <div class="plan-guidance"><strong>Orienta√ß√µes:</strong> {{ plan.patientGuidance }}</div>
                    }
                    @if (plan.returnDate) {
                      <div class="plan-return"><strong>Retorno:</strong> {{ plan.returnDate | date: 'dd/MM/yyyy' }}</div>
                    }
                    <div class="plan-date">{{ plan.createdAt | date: 'dd/MM/yyyy HH:mm' }}</div>
                  </div>
                }
              </div>
            } @else {
              <p class="text-muted">Nenhum plano terap√™utico registrado. √â obrigat√≥rio adicionar pelo menos um plano terap√™utico.</p>
            }
          </div>

          <!-- Legacy Fields (Optional - kept for backward compatibility) -->
          <div class="card legacy-fields">
            <h3>Campos Adicionais (Opcional)</h3>
            <p class="info-text">Estes campos s√£o mantidos para compatibilidade, mas os campos CFM 1.821 acima s√£o obrigat√≥rios.</p>
            
            <div class="form-group">
              <app-rich-text-editor
                formControlName="diagnosis"
                id="diagnosis"
                label="Diagn√≥stico (Legacy)"
                placeholder="Campo legado - use Hip√≥teses Diagn√≥sticas CFM acima"
                [rows]="3"
                [enableMedicationAutocomplete]="false"
                [enableExamAutocomplete]="false"
              ></app-rich-text-editor>
            </div>

            <div class="form-group">
              <app-rich-text-editor
                formControlName="prescription"
                id="prescription"
                label="Prescri√ß√£o M√©dica (Legacy)"
                placeholder="Campo legado - use Plano Terap√™utico CFM acima"
                [rows]="4"
                [enableMedicationAutocomplete]="true"
                [enableExamAutocomplete]="false"
                (medicationSelected)="onMedicationSelected($event)"
              ></app-rich-text-editor>
              <button type="button" class="btn btn-outline btn-print" (click)="onPrint()">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="6 9 6 2 18 2 18 9"></polyline>
                  <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path>
                  <rect x="6" y="14" width="12" height="8"></rect>
                </svg>
                Imprimir Receita
              </button>
            </div>

            <div class="form-group">
              <app-rich-text-editor
                formControlName="notes"
                id="notes"
                label="Observa√ß√µes Cl√≠nicas (Legacy)"
                placeholder="Campo legado para anota√ß√µes adicionais"
                [rows]="3"
                [enableMedicationAutocomplete]="true"
                [enableExamAutocomplete]="true"
                (medicationSelected)="onMedicationSelected($event)"
                (examSelected)="onExamSelected($event)"
              ></app-rich-text-editor>
            </div>
          </div>

          <!-- Procedures Section -->
          <div class="card">
            <div class="card-header-flex">
              <h3>Procedimentos Realizados</h3>
              <button type="button" class="btn btn-outline" (click)="toggleAddProcedure()">
                {{ showAddProcedure() ? 'Cancelar' : '+ Adicionar Procedimento' }}
              </button>
            </div>
            
            @if (showAddProcedure()) {
              <form [formGroup]="procedureForm" class="add-form">
                <div class="form-group">
                  <label for="procedure">Procedimento</label>
                  <select id="procedure" formControlName="procedureId" class="form-control">
                    <option value="">Selecione um procedimento</option>
                    @for (proc of availableProcedures(); track proc.id) {
                      <option [value]="proc.id">{{ proc.name }} - R$ {{ proc.price }}</option>
                    }
                  </select>
                </div>
                <div class="form-row">
                  <div class="form-group">
                    <label for="customPrice">Pre√ßo Personalizado (opcional)</label>
                    <input 
                      type="number" 
                      id="customPrice" 
                      formControlName="customPrice" 
                      class="form-control" 
                      placeholder="Deixe vazio para usar pre√ßo padr√£o"
                      step="0.01"
                    />
                  </div>
                  <div class="form-group">
                    <label for="procedureNotes">Observa√ß√µes</label>
                    <input 
                      type="text" 
                      id="procedureNotes" 
                      formControlName="notes" 
                      class="form-control" 
                      placeholder="Observa√ß√µes sobre o procedimento"
                    />
                  </div>
                </div>
                <button type="button" class="btn btn-primary" (click)="onAddProcedure()" [disabled]="!procedureForm.valid">
                  Adicionar
                </button>
              </form>
            }

            @if (appointmentProcedures().length > 0) {
              <div class="procedures-list">
                @for (proc of appointmentProcedures(); track proc.id) {
                  <div class="procedure-item">
                    <div class="procedure-info">
                      <strong>{{ proc.procedureName }}</strong>
                      <span class="procedure-code">{{ proc.procedureCode }}</span>
                    </div>
                    <div class="procedure-price">R$ {{ proc.priceCharged }}</div>
                    @if (proc.notes) {
                      <div class="procedure-notes">{{ proc.notes }}</div>
                    }
                  </div>
                }
                <div class="procedures-total">
                  <strong>Total:</strong> <span>R$ {{ getTotalProceduresCost() }}</span>
                </div>
              </div>
            } @else {
              <p class="text-muted">Nenhum procedimento adicionado</p>
            }
          </div>

          <!-- Exam Requests Section -->
          <div class="card">
            <div class="card-header-flex">
              <h3>Pedidos de Exames</h3>
              <button type="button" class="btn btn-outline" (click)="toggleAddExam()">
                {{ showAddExam() ? 'Cancelar' : '+ Solicitar Exame' }}
              </button>
            </div>
            
            @if (showAddExam()) {
              <form [formGroup]="examForm" class="add-form">
                <div class="form-row">
                  <div class="form-group">
                    <label for="examType">Tipo de Exame</label>
                    <select id="examType" formControlName="examType" class="form-control">
                      @for (type of examTypes; track type) {
                        <option [value]="type">{{ examTypeLabels[type] }}</option>
                      }
                    </select>
                  </div>
                  <div class="form-group">
                    <label for="urgency">Urg√™ncia</label>
                    <select id="urgency" formControlName="urgency" class="form-control">
                      @for (urgency of examUrgencies; track urgency) {
                        <option [value]="urgency">{{ examUrgencyLabels[urgency] }}</option>
                      }
                    </select>
                  </div>
                </div>
                <div class="form-group">
                  <label for="examName">Nome do Exame</label>
                  <input 
                    type="text" 
                    id="examName" 
                    formControlName="examName" 
                    class="form-control" 
                    placeholder="Ex: Hemograma Completo, Raio-X de T√≥rax"
                  />
                </div>
                <div class="form-group">
                  <label for="description">Descri√ß√£o / Justificativa</label>
                  <textarea 
                    id="description" 
                    formControlName="description" 
                    class="form-control" 
                    rows="2"
                    placeholder="Motivo da solicita√ß√£o do exame..."
                  ></textarea>
                </div>
                <div class="form-group">
                  <label for="examNotes">Observa√ß√µes Adicionais</label>
                  <input 
                    type="text" 
                    id="examNotes" 
                    formControlName="notes" 
                    class="form-control" 
                    placeholder="Instru√ß√µes especiais, preparo, etc."
                  />
                </div>
                <button type="button" class="btn btn-primary" (click)="onAddExamRequest()" [disabled]="!examForm.valid">
                  Adicionar Pedido
                </button>
              </form>
            }

            @if (examRequests().length > 0) {
              <div class="exams-list">
                @for (exam of examRequests(); track exam.id) {
                  <div class="exam-item">
                    <div class="exam-header">
                      <strong>{{ exam.examName }}</strong>
                      <span class="exam-type-badge">{{ examTypeLabels[exam.examType] }}</span>
                      <span class="exam-urgency-badge urgency-{{ exam.urgency }}">{{ examUrgencyLabels[exam.urgency] }}</span>
                      <button type="button" class="btn-remove" (click)="removeExamRequest(exam)" title="Remover">
                        ‚úï
                      </button>
                    </div>
                    <div class="exam-description">{{ exam.description }}</div>
                    @if (exam.notes) {
                      <div class="exam-notes"><em>Obs: {{ exam.notes }}</em></div>
                    }
                  </div>
                }
              </div>
            } @else {
              <p class="text-muted">Nenhum pedido de exame adicionado</p>
            }
          </div>

          <!-- Digital Prescriptions Section - CFM 1.643/2002 + ANVISA -->
          <div class="card">
            <div class="card-header-flex">
              <h3>Receitas M√©dicas Digitais - CFM 1.643/2002 + ANVISA</h3>
              @if (medicalRecord()?.id) {
                <button 
                  type="button" 
                  class="btn btn-primary" 
                  [routerLink]="['/prescriptions/new', medicalRecord()!.id]"
                  title="Criar nova receita digital conforme CFM e ANVISA"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="12" y1="18" x2="12" y2="12"></line>
                    <line x1="9" y1="15" x2="15" y2="15"></line>
                  </svg>
                  Nova Receita Digital
                </button>
              }
            </div>
            <div class="prescription-info">
              <p class="info-text">
                <strong>Sistema de Receitas Digitais:</strong> Crie receitas em conformidade com CFM 1.643/2002 e ANVISA 344/1998.
                Suporta receitas simples, controladas (A, B, C1) e antimicrobianas com rastreamento SNGPC.
              </p>
              @if (!medicalRecord()?.id) {
                <p class="text-warning">
                  ‚ö†Ô∏è Salve o prontu√°rio primeiro para habilitar a cria√ß√£o de receitas digitais.
                </p>
              }
            </div>
          </div>

          <div class="form-actions">
            <button type="button" class="btn btn-secondary" (click)="onSave()" [disabled]="isLoading()">
              üíæ Salvar Prontu√°rio
            </button>
            
            @if (!medicalRecord()?.consultationEndTime) {
              <!-- Show payment option checkbox if appointment is not paid yet -->
              @if (appointment() && !appointment()!.isPaid) {
                <div class="form-check mt-2 mb-2">
                  <input 
                    type="checkbox" 
                    class="form-check-input" 
                    id="registerPayment"
                    [checked]="registerPaymentOnComplete()"
                    (change)="togglePaymentRegistration()">
                  <label class="form-check-label" for="registerPayment">
                    Registrar que recebi o pagamento
                  </label>
                </div>
              }
              
              <button type="button" class="btn btn-secondary" (click)="callNextPatient()" [disabled]="isLoading()" style="margin-right: 1rem;">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 0.5rem;">
                  <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                </svg>
                Chamar Pr√≥ximo Paciente
              </button>
              
              <button type="button" class="btn btn-primary" (click)="onComplete()" [disabled]="isLoading()">
                ‚úì Finalizar Atendimento
              </button>
            } @else {
              <div class="completion-notice">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                  <polyline points="22 4 12 14.01 9 11.01"></polyline>
                </svg>
                Atendimento Finalizado
              </div>
            }
          </div>
        </form>
      </div>
    </div>
  }
</div>

<!-- Payment Dialog -->
@if (showPaymentDialog()) {
  <div class="modal-overlay" (click)="showPaymentDialog.set(false)">
    <div class="modal-dialog" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Registrar Pagamento</h3>
        <button type="button" class="btn-close" (click)="showPaymentDialog.set(false)">√ó</button>
      </div>
      <div class="modal-body">
        <p>Quem est√° recebendo o pagamento desta consulta?</p>
        <div class="payment-options">
          <button type="button" class="btn btn-outline-primary btn-block" (click)="markAppointmentAsPaid('Doctor')">
            üë®‚Äç‚öïÔ∏è M√©dico
          </button>
          <button type="button" class="btn btn-outline-primary btn-block" (click)="markAppointmentAsPaid('Secretary')">
            üíº Secret√°ria/Recep√ß√£o
          </button>
          <button type="button" class="btn btn-outline-primary btn-block" (click)="markAppointmentAsPaid('Other')">
            üë§ Outro Funcion√°rio
          </button>
        </div>
      </div>
    </div>
  </div>
}

<!-- Print-only section -->
<div class="print-only">
  @if (patient() && medicalRecord()) {
    <div class="prescription-print">
      <h2>Prescri√ß√£o M√©dica</h2>
      <div class="prescription-header">
        <p><strong>Paciente:</strong> {{ patient()!.name }}</p>
        <p><strong>Data:</strong> {{ medicalRecord()!.consultationStartTime | date: 'dd/MM/yyyy HH:mm' }}</p>
      </div>
      <div class="prescription-content">
        {{ attendanceForm.get('prescription')?.value }}
      </div>
    </div>
  }
</div>

<!-- Notification Modal for Call Next Patient -->
<app-notification-modal #notificationModal (confirmed)="onNotificationConfirmed($event)"></app-notification-modal>
