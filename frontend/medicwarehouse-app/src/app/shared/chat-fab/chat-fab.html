<!-- Floating Action Button -->
<button class="chat-fab" (click)="toggleWidget()" title="Chat">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
  </svg>
  @if (hasUnread) {
    <span class="notification-badge">{{ totalUnreadCount }}</span>
  }
</button>

<!-- Chat Widget -->
@if (showWidget()) {
  <div class="chat-widget" [class.minimized]="isMinimized()">
    <!-- Widget Header -->
    <div class="widget-header">
      <div class="header-left">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
        </svg>
        <h3>Chat</h3>
        @if (!isConnected()) {
          <span class="connection-status offline" title="Desconectado">●</span>
        } @else {
          <span class="connection-status online" title="Conectado">●</span>
        }
      </div>
      <div class="header-actions">
        @if (!isMinimized()) {
          <button class="btn-icon" (click)="minimizeWidget()" title="Minimizar">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="5" y1="12" x2="19" y2="12"/>
            </svg>
          </button>
        } @else {
          <button class="btn-icon" (click)="maximizeWidget()" title="Expandir">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
            </svg>
          </button>
        }
        <button class="btn-icon" (click)="closeWidget()" title="Fechar">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>
    </div>

    <!-- Widget Content -->
    @if (!isMinimized()) {
      <div class="widget-content">
        <!-- Conversation List View -->
        @if (!selectedConversation()) {
          <div class="conversations-view">
            <div class="conversations-header">
              <input
                type="text"
                placeholder="Buscar conversas..."
                class="search-input"
              />
              <button class="btn-new-chat" (click)="toggleUserList()" title="Nova conversa">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="12" y1="5" x2="12" y2="19"/>
                  <line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
              </button>
            </div>

            <div class="conversations-list">
              @if (isLoadingConversations()) {
                <div class="loading">
                  <div class="spinner"></div>
                  <p>Carregando...</p>
                </div>
              } @else if (sortedConversations().length === 0) {
                <div class="empty-state">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                  </svg>
                  <p>Nenhuma conversa</p>
                  <button class="btn-primary-small" (click)="toggleUserList()">Iniciar chat</button>
                </div>
              } @else {
                @for (conversation of sortedConversations(); track conversation.id) {
                  <div
                    class="conversation-item"
                    [class.unread]="conversation.unreadCount > 0"
                    (click)="selectConversation(conversation)">
                    <div class="conversation-avatar">
                      {{ getConversationTitle(conversation).charAt(0).toUpperCase() }}
                    </div>
                    <div class="conversation-info">
                      <div class="conversation-header">
                        <h4>{{ getConversationTitle(conversation) }}</h4>
                        <span class="time">{{ formatTime(conversation.lastMessageAt || conversation.createdAt) }}</span>
                      </div>
                      <div class="conversation-preview">
                        <p>{{ getLastMessagePreview(conversation) }}</p>
                        @if (conversation.unreadCount > 0) {
                          <span class="unread-badge">{{ conversation.unreadCount }}</span>
                        }
                      </div>
                    </div>
                  </div>
                }
              }
            </div>
          </div>
        }

        <!-- Chat View -->
        @if (selectedConversation()) {
          <div class="chat-view">
            <!-- Chat Header -->
            <div class="chat-header">
              <button class="btn-back" (click)="selectedConversation.set(null)">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="19" y1="12" x2="5" y2="12"/>
                  <polyline points="12 19 5 12 12 5"/>
                </svg>
              </button>
              <div class="chat-avatar">
                {{ getConversationTitle(selectedConversation()!).charAt(0).toUpperCase() }}
              </div>
              <div class="chat-info">
                <h4>{{ getConversationTitle(selectedConversation()!) }}</h4>
                @if (typingUsers().size > 0) {
                  <p class="typing">digitando...</p>
                }
              </div>
            </div>

            <!-- Messages -->
            <div class="messages-container" #messagesContainer>
              @if (isLoadingMessages()) {
                <div class="loading">
                  <div class="spinner"></div>
                </div>
              } @else if (messages().length === 0) {
                <div class="empty-messages">
                  <p>Nenhuma mensagem</p>
                </div>
              } @else {
                @for (message of messages(); track message.id) {
                  <div
                    class="message"
                    [class.own]="isOwnMessage(message)"
                    [class.deleted]="message.isDeleted">
                    @if (!isOwnMessage(message)) {
                      <div class="message-avatar">
                        {{ message.senderName.charAt(0).toUpperCase() }}
                      </div>
                    }
                    <div class="message-content">
                      <div class="message-bubble">
                        @if (message.isDeleted) {
                          <em>Mensagem excluída</em>
                        } @else {
                          {{ message.content }}
                        }
                      </div>
                      <div class="message-meta">
                        <span class="message-time">{{ formatTime(message.sentAt) }}</span>
                        @if (isOwnMessage(message) && message.readBy.length > 1) {
                          <svg class="read-indicator" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="20 6 9 17 4 12"/>
                          </svg>
                        }
                      </div>
                    </div>
                  </div>
                }
              }
            </div>

            <!-- Message Input -->
            <div class="message-input-container">
              <form (submit)="sendMessage(); $event.preventDefault()">
                <input
                  type="text"
                  [(ngModel)]="messageInput"
                  (input)="onTyping()"
                  placeholder="Digite uma mensagem..."
                  class="message-input"
                  name="messageInput"
                  [disabled]="!isConnected()"
                />
                <button
                  type="submit"
                  class="btn-send"
                  [disabled]="!messageInput.trim() || !isConnected()">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="22" y1="2" x2="11" y2="13"/>
                    <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                  </svg>
                </button>
              </form>
            </div>
          </div>
        }
      </div>
    }
  </div>
}

<!-- User List Panel -->
@if (showUserList) {
  <div class="user-list-overlay" (click)="toggleUserList()">
    <div class="user-list-panel" (click)="$event.stopPropagation()">
      <div class="panel-header">
        <h3>Nova Conversa</h3>
        <button class="btn-close" (click)="toggleUserList()">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>

      <div class="search-box">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"/>
          <path d="m21 21-4.35-4.35"/>
        </svg>
        <input
          type="text"
          [(ngModel)]="searchQuery"
          placeholder="Buscar usuário..."
          class="search-input"
        />
      </div>

      <div class="users-list">
        @for (user of filteredUsers(); track user.userId) {
          <div class="user-item" (click)="startConversation(user)">
            <div class="user-avatar">
              {{ user.fullName.charAt(0).toUpperCase() }}
            </div>
            <div class="user-info">
              <h4>{{ user.fullName }}</h4>
              <p>{{ user.userName }}</p>
            </div>
          </div>
        }
      </div>
    </div>
  </div>
}
