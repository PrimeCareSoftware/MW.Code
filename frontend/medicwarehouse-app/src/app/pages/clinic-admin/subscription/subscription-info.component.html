<app-navbar></app-navbar>

<div class="subscription-container">
  <div class="page-header">
    <h1>Assinatura e Plano</h1>
    <p>Gerencie sua assinatura e informações de pagamento</p>
  </div>

  @if (isLoading()) {
    <div class="loading-state">
      <div class="spinner"></div>
      <p>Carregando informações da assinatura...</p>
    </div>
  } @else {
    @if (errorMessage()) {
      <div class="alert alert-error">
        {{ errorMessage() }}
      </div>
    }

    @if (successMessage()) {
      <div class="alert alert-success">
        {{ successMessage() }}
      </div>
    }

    @if (subscription()) {
      <div class="subscription-card">
        <div class="subscription-header">
          <div class="plan-info">
            <h2>{{ subscription()!.planName }}</h2>
            <span class="plan-type">{{ subscription()!.planType }}</span>
            <span [class]="'status-badge ' + getStatusClass(subscription()!.status)">
              {{ getStatusText(subscription()!.status) }}
            </span>
            @if (subscription()!.isTrial) {
              <span class="badge-info">Trial</span>
            }
          </div>
          <div class="plan-price">
            <span class="price-label">Valor</span>
            <span class="price-value">{{ subscription()!.currentPrice | currency: 'BRL' }}</span>
          </div>
        </div>

        <div class="subscription-details">
          <div class="detail-item">
            <label>Data de Início</label>
            <p>{{ subscription()!.startDate | date: 'dd/MM/yyyy' }}</p>
          </div>

          @if (subscription()!.endDate) {
            <div class="detail-item">
              <label>Data de Término</label>
              <p>{{ subscription()!.endDate | date: 'dd/MM/yyyy' }}</p>
            </div>
          }

          @if (subscription()!.nextBillingDate) {
            <div class="detail-item">
              <label>Próxima Cobrança</label>
              <p>{{ subscription()!.nextBillingDate | date: 'dd/MM/yyyy' }}</p>
            </div>
          }
        </div>

        <!-- Usage Limits -->
        <div class="limits-section">
          <h3>Limites do Plano</h3>
          
          <div class="limit-item">
            <div class="limit-header">
              <label>Usuários</label>
              <span class="limit-value">
                {{ subscription()!.limits.currentUsers }} / {{ subscription()!.limits.maxUsers }}
              </span>
            </div>
            <div class="progress-bar">
              <div 
                class="progress-fill" 
                [class]="getUserUsageClass()"
                [style.width.%]="getUserUsagePercentage()"
              ></div>
            </div>
            @if (getUserUsagePercentage() >= 90) {
              <p class="limit-warning">Você está próximo do limite de usuários!</p>
            }
          </div>

          <div class="limit-item">
            <div class="limit-header">
              <label>Pacientes</label>
              <span class="limit-value">{{ subscription()!.limits.maxPatients }}</span>
            </div>
          </div>
        </div>

        <!-- Features -->
        <div class="features-section">
          <h3>Funcionalidades Incluídas</h3>
          <ul class="features-list">
            <li [class.feature-enabled]="subscription()!.features.hasReports">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                @if (subscription()!.features.hasReports) {
                  <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                  <polyline points="22 4 12 14.01 9 11.01"/>
                } @else {
                  <circle cx="12" cy="12" r="10"/>
                  <line x1="15" x2="9" y1="9" y2="15"/>
                  <line x1="9" x2="15" y1="9" y2="15"/>
                }
              </svg>
              <span>Relatórios Avançados</span>
            </li>
            <li [class.feature-enabled]="subscription()!.features.hasWhatsAppIntegration">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                @if (subscription()!.features.hasWhatsAppIntegration) {
                  <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                  <polyline points="22 4 12 14.01 9 11.01"/>
                } @else {
                  <circle cx="12" cy="12" r="10"/>
                  <line x1="15" x2="9" y1="9" y2="15"/>
                  <line x1="9" x2="15" y1="9" y2="15"/>
                }
              </svg>
              <span>Integração WhatsApp</span>
            </li>
            <li [class.feature-enabled]="subscription()!.features.hasSMSNotifications">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                @if (subscription()!.features.hasSMSNotifications) {
                  <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                  <polyline points="22 4 12 14.01 9 11.01"/>
                } @else {
                  <circle cx="12" cy="12" r="10"/>
                  <line x1="15" x2="9" y1="9" y2="15"/>
                  <line x1="9" x2="15" y1="9" y2="15"/>
                }
              </svg>
              <span>Notificações SMS</span>
            </li>
            <li [class.feature-enabled]="subscription()!.features.hasTissExport">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                @if (subscription()!.features.hasTissExport) {
                  <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                  <polyline points="22 4 12 14.01 9 11.01"/>
                } @else {
                  <circle cx="12" cy="12" r="10"/>
                  <line x1="15" x2="9" y1="9" y2="15"/>
                  <line x1="9" x2="15" y1="9" y2="15"/>
                }
              </svg>
              <span>Exportação TISS</span>
            </li>
          </ul>
        </div>

        @if (subscription()!.isActive) {
          <div class="actions-section">
            <button 
              type="button" 
              class="btn btn-danger" 
              (click)="requestCancellation()"
              [disabled]="isCancelling()"
            >
              Solicitar Cancelamento
            </button>
          </div>
        }
      </div>
    } @else {
      <div class="empty-state">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="8" width="18" height="4" rx="1"/>
          <path d="M12 8v13"/>
          <path d="M19 12v7a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-7"/>
          <path d="M7.5 8a2.5 2.5 0 0 1 0-5A4.8 8 0 0 1 12 8a4.8 8 0 0 1 4.5-5 2.5 2.5 0 0 1 0 5"/>
        </svg>
        <h3>Nenhuma assinatura encontrada</h3>
        <p>Entre em contato com o suporte para ativar sua assinatura.</p>
      </div>
    }
  }

  @if (showCancelConfirm()) {
    <div class="modal-overlay" (click)="cancelCancellationRequest()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <h3>Confirmar Cancelamento</h3>
        <p>Tem certeza que deseja solicitar o cancelamento da sua assinatura?</p>
        <p class="warning-text">Esta ação não pode ser desfeita e você perderá acesso a todas as funcionalidades do sistema.</p>
        
        <div class="modal-actions">
          <button 
            type="button" 
            class="btn btn-secondary" 
            (click)="cancelCancellationRequest()"
          >
            Voltar
          </button>
          <button 
            type="button" 
            class="btn btn-danger" 
            (click)="confirmCancellation()"
            [disabled]="isCancelling()"
          >
            @if (isCancelling()) {
              <span class="spinner"></span>
              <span>Processando...</span>
            } @else {
              <span>Confirmar Cancelamento</span>
            }
          </button>
        </div>
      </div>
    </div>
  }
</div>
