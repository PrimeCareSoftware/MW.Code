<app-navbar></app-navbar>

<div class="attendance-container">
  <div class="page-header">
    <div>
      <h1>Atendimento ao Paciente</h1>
      <p>Registro de consulta e prontuário médico</p>
    </div>
    <button class="btn btn-secondary" routerLink="/appointments">Voltar para Agenda</button>
  </div>

  @if (errorMessage()) {
    <div class="alert alert-error">{{ errorMessage() }}</div>
  }
  @if (successMessage()) {
    <div class="alert alert-success">{{ successMessage() }}</div>
  }

  @if (isLoading()) {
    <div class="loading">Carregando...</div>
  } @else {
    <div class="attendance-layout">
      <!-- Left Panel - Patient Info and Timer -->
      <div class="left-panel">
        <!-- Patient Info Card -->
        <div class="card patient-info">
          <h3>Informações do Paciente</h3>
          @if (patient()) {
            <div class="patient-details">
              <div class="detail-row">
                <span class="label">Nome:</span>
                <span class="value">{{ patient()!.name }}</span>
              </div>
              <div class="detail-row">
                <span class="label">Idade:</span>
                <span class="value">{{ patient()!.age }} anos</span>
              </div>
              <div class="detail-row">
                <span class="label">CPF:</span>
                <span class="value">{{ patient()!.document }}</span>
              </div>
              <div class="detail-row">
                <span class="label">Telefone:</span>
                <span class="value">{{ patient()!.phone }}</span>
              </div>
              @if (patient()!.allergies) {
                <div class="detail-row highlight">
                  <span class="label">Alergias:</span>
                  <span class="value">{{ patient()!.allergies }}</span>
                </div>
              }
            </div>
          } @else {
            <p class="text-muted">Carregando informações do paciente...</p>
          }
        </div>

        <!-- Timer Card -->
        <div class="card timer-card">
          <h3>Tempo de Consulta</h3>
          <div class="timer-display">
            {{ formatTime(elapsedSeconds()) }}
          </div>
          <p class="timer-info">
            @if (medicalRecord()?.consultationEndTime) {
              Consulta finalizada
            } @else {
              Consulta em andamento
            }
          </p>
        </div>

        <!-- Patient History Card -->
        <div class="card patient-history">
          <h3>Histórico de Consultas</h3>
          @if (patientHistory().length > 0) {
            <div class="history-list">
              @for (record of patientHistory(); track record.id) {
                <div class="history-item">
                  <div class="history-date">
                    {{ record.consultationStartTime | date: 'dd/MM/yyyy' }}
                  </div>
                  <div class="history-info">
                    <p><strong>Diagnóstico:</strong> {{ record.diagnosis || 'N/A' }}</p>
                    <p><strong>Duração:</strong> {{ record.consultationDurationMinutes }} min</p>
                  </div>
                </div>
              }
            </div>
          } @else {
            <p class="text-muted">Nenhum histórico de consultas</p>
          }
        </div>
      </div>

      <!-- Right Panel - Medical Record Form -->
      <div class="right-panel">
        <form [formGroup]="attendanceForm" class="medical-record-form">
          <!-- CFM 1.821 - Anamnese (Required Fields) -->
          <div class="card">
            <h3>Anamnese - CFM 1.821 <span class="required-badge">Obrigatório</span></h3>
            
            <div class="form-group">
              <label for="chiefComplaint">Queixa Principal <span class="required">*</span></label>
              <textarea 
                id="chiefComplaint" 
                formControlName="chiefComplaint" 
                class="form-control"
                rows="2"
                placeholder="Descreva a queixa principal do paciente (mínimo 10 caracteres)..."
              ></textarea>
              @if (attendanceForm.get('chiefComplaint')?.invalid && attendanceForm.get('chiefComplaint')?.touched) {
                <div class="error-message">Queixa principal é obrigatória (mínimo 10 caracteres)</div>
              }
            </div>

            <div class="form-group">
              <label for="historyOfPresentIllness">História da Doença Atual (HDA) <span class="required">*</span></label>
              <textarea 
                id="historyOfPresentIllness" 
                formControlName="historyOfPresentIllness" 
                class="form-control"
                rows="4"
                placeholder="Descreva a história da doença atual do paciente (mínimo 50 caracteres)..."
              ></textarea>
              @if (attendanceForm.get('historyOfPresentIllness')?.invalid && attendanceForm.get('historyOfPresentIllness')?.touched) {
                <div class="error-message">História da doença atual é obrigatória (mínimo 50 caracteres)</div>
              }
            </div>

            <div class="form-group">
              <label for="pastMedicalHistory">História Patológica Pregressa (HPP)</label>
              <textarea 
                id="pastMedicalHistory" 
                formControlName="pastMedicalHistory" 
                class="form-control"
                rows="3"
                placeholder="Doenças anteriores, cirurgias, internações..."
              ></textarea>
            </div>

            <div class="form-group">
              <label for="familyHistory">História Familiar</label>
              <textarea 
                id="familyHistory" 
                formControlName="familyHistory" 
                class="form-control"
                rows="2"
                placeholder="Histórico de doenças na família..."
              ></textarea>
            </div>

            <div class="form-group">
              <label for="lifestyleHabits">Hábitos de Vida</label>
              <textarea 
                id="lifestyleHabits" 
                formControlName="lifestyleHabits" 
                class="form-control"
                rows="2"
                placeholder="Tabagismo, etilismo, atividade física, alimentação..."
              ></textarea>
            </div>

            <div class="form-group">
              <label for="currentMedications">Medicações em Uso</label>
              <textarea 
                id="currentMedications" 
                formControlName="currentMedications" 
                class="form-control"
                rows="2"
                placeholder="Medicamentos que o paciente está utilizando atualmente..."
              ></textarea>
            </div>
          </div>

          <!-- CFM 1.821 - Clinical Examination -->
          <div class="card">
            <div class="card-header-flex">
              <h3>Exame Clínico - CFM 1.821 <span class="required-badge">Obrigatório</span></h3>
              <button type="button" class="btn btn-outline" (click)="toggleAddClinicalExamination()">
                {{ showAddClinicalExamination() ? 'Cancelar' : '+ Adicionar Exame Clínico' }}
              </button>
            </div>

            @if (showAddClinicalExamination()) {
              <form [formGroup]="clinicalExaminationForm" class="add-form">
                <div class="form-group">
                  <label for="systematicExamination">Exame Físico Sistemático <span class="required">*</span></label>
                  <textarea 
                    id="systematicExamination" 
                    formControlName="systematicExamination" 
                    class="form-control"
                    rows="4"
                    placeholder="Descreva o exame físico do paciente por sistemas (mínimo 20 caracteres)..."
                  ></textarea>
                  @if (clinicalExaminationForm.get('systematicExamination')?.invalid && clinicalExaminationForm.get('systematicExamination')?.touched) {
                    <div class="error-message">Exame físico é obrigatório (mínimo 20 caracteres)</div>
                  }
                </div>

                <div class="vital-signs-grid">
                  <div class="form-group">
                    <label for="bloodPressureSystolic">PA Sistólica (mmHg)</label>
                    <input 
                      type="number" 
                      id="bloodPressureSystolic" 
                      formControlName="bloodPressureSystolic" 
                      class="form-control"
                      placeholder="120"
                      min="50"
                      max="300"
                    />
                  </div>
                  <div class="form-group">
                    <label for="bloodPressureDiastolic">PA Diastólica (mmHg)</label>
                    <input 
                      type="number" 
                      id="bloodPressureDiastolic" 
                      formControlName="bloodPressureDiastolic" 
                      class="form-control"
                      placeholder="80"
                      min="30"
                      max="200"
                    />
                  </div>
                  <div class="form-group">
                    <label for="heartRate">FC (bpm)</label>
                    <input 
                      type="number" 
                      id="heartRate" 
                      formControlName="heartRate" 
                      class="form-control"
                      placeholder="72"
                      min="30"
                      max="220"
                    />
                  </div>
                  <div class="form-group">
                    <label for="respiratoryRate">FR (irpm)</label>
                    <input 
                      type="number" 
                      id="respiratoryRate" 
                      formControlName="respiratoryRate" 
                      class="form-control"
                      placeholder="16"
                      min="8"
                      max="60"
                    />
                  </div>
                  <div class="form-group">
                    <label for="temperature">Temperatura (°C)</label>
                    <input 
                      type="number" 
                      id="temperature" 
                      formControlName="temperature" 
                      class="form-control"
                      placeholder="36.5"
                      step="0.1"
                      min="32"
                      max="45"
                    />
                  </div>
                  <div class="form-group">
                    <label for="oxygenSaturation">SatO2 (%)</label>
                    <input 
                      type="number" 
                      id="oxygenSaturation" 
                      formControlName="oxygenSaturation" 
                      class="form-control"
                      placeholder="98"
                      min="0"
                      max="100"
                    />
                  </div>
                </div>

                <div class="form-group">
                  <label for="generalState">Estado Geral</label>
                  <input 
                    type="text" 
                    id="generalState" 
                    formControlName="generalState" 
                    class="form-control"
                    placeholder="Paciente em bom estado geral, consciente, orientado..."
                  />
                </div>

                <button type="button" class="btn btn-primary" (click)="onAddClinicalExamination()" [disabled]="!clinicalExaminationForm.valid">
                  Adicionar Exame Clínico
                </button>
              </form>
            }

            @if (clinicalExaminations().length > 0) {
              <div class="examinations-list">
                @for (exam of clinicalExaminations(); track exam.id) {
                  <div class="examination-item">
                    <div class="exam-vital-signs">
                      @if (exam.bloodPressureSystolic && exam.bloodPressureDiastolic) {
                        <span class="vital-sign">PA: {{ exam.bloodPressureSystolic }}/{{ exam.bloodPressureDiastolic }} mmHg</span>
                      }
                      @if (exam.heartRate) {
                        <span class="vital-sign">FC: {{ exam.heartRate }} bpm</span>
                      }
                      @if (exam.respiratoryRate) {
                        <span class="vital-sign">FR: {{ exam.respiratoryRate }} irpm</span>
                      }
                      @if (exam.temperature) {
                        <span class="vital-sign">T: {{ exam.temperature }}°C</span>
                      }
                      @if (exam.oxygenSaturation) {
                        <span class="vital-sign">SatO2: {{ exam.oxygenSaturation }}%</span>
                      }
                    </div>
                    @if (exam.generalState) {
                      <div class="exam-general"><strong>Estado Geral:</strong> {{ exam.generalState }}</div>
                    }
                    <div class="exam-systematic"><strong>Exame Físico:</strong> {{ exam.systematicExamination }}</div>
                    <div class="exam-date">{{ exam.createdAt | date: 'dd/MM/yyyy HH:mm' }}</div>
                  </div>
                }
              </div>
            } @else {
              <p class="text-muted">Nenhum exame clínico registrado. É obrigatório adicionar pelo menos um exame clínico.</p>
            }
          </div>

          <!-- CFM 1.821 - Diagnostic Hypotheses -->
          <div class="card">
            <div class="card-header-flex">
              <h3>Hipóteses Diagnósticas - CFM 1.821 <span class="required-badge">Obrigatório</span></h3>
              <button type="button" class="btn btn-outline" (click)="toggleAddDiagnosis()">
                {{ showAddDiagnosis() ? 'Cancelar' : '+ Adicionar Diagnóstico' }}
              </button>
            </div>

            @if (showAddDiagnosis()) {
              <form [formGroup]="diagnosticForm" class="add-form">
                <div class="form-group">
                  <label for="description">Descrição do Diagnóstico <span class="required">*</span></label>
                  <input 
                    type="text" 
                    id="description" 
                    formControlName="description" 
                    class="form-control"
                    placeholder="Ex: Hipertensão Arterial Essencial"
                  />
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label for="icd10Code">Código CID-10 <span class="required">*</span></label>
                    <input 
                      type="text" 
                      id="icd10Code" 
                      formControlName="icd10Code" 
                      class="form-control"
                      placeholder="Ex: I10, J20.9, Z99.01"
                      maxlength="10"
                    />
                    @if (diagnosticForm.get('icd10Code')?.invalid && diagnosticForm.get('icd10Code')?.touched) {
                      <div class="error-message">Formato CID-10 inválido (Ex: A00, J20.9)</div>
                    }
                  </div>
                  <div class="form-group">
                    <label for="type">Tipo</label>
                    <select id="type" formControlName="type" class="form-control">
                      @for (type of diagnosisTypes; track type) {
                        <option [value]="type">{{ diagnosisTypeLabels[type] }}</option>
                      }
                    </select>
                  </div>
                </div>

                <button type="button" class="btn btn-primary" (click)="onAddDiagnosis()" [disabled]="!diagnosticForm.valid">
                  Adicionar Diagnóstico
                </button>
              </form>
            }

            @if (diagnosticHypotheses().length > 0) {
              <div class="diagnoses-list">
                @for (diagnosis of diagnosticHypotheses(); track diagnosis.id) {
                  <div class="diagnosis-item">
                    <div class="diagnosis-header">
                      <strong>{{ diagnosis.description }}</strong>
                      <span class="diagnosis-code">CID-10: {{ diagnosis.icd10Code }}</span>
                      <span class="diagnosis-type-badge type-{{ diagnosis.type }}">{{ diagnosisTypeLabels[diagnosis.type] }}</span>
                      <button type="button" class="btn-remove" (click)="removeDiagnosis(diagnosis)" title="Remover">
                        ✕
                      </button>
                    </div>
                    <div class="diagnosis-date">{{ diagnosis.diagnosedAt | date: 'dd/MM/yyyy HH:mm' }}</div>
                  </div>
                }
              </div>
            } @else {
              <p class="text-muted">Nenhuma hipótese diagnóstica registrada. É obrigatório adicionar pelo menos um diagnóstico com CID-10.</p>
            }
          </div>

          <!-- CFM 1.821 - Therapeutic Plan -->
          <div class="card">
            <div class="card-header-flex">
              <h3>Plano Terapêutico - CFM 1.821 <span class="required-badge">Obrigatório</span></h3>
              <button type="button" class="btn btn-outline" (click)="toggleAddTherapeuticPlan()">
                {{ showAddTherapeuticPlan() ? 'Cancelar' : '+ Adicionar Plano Terapêutico' }}
              </button>
            </div>

            @if (showAddTherapeuticPlan()) {
              <form [formGroup]="therapeuticPlanForm" class="add-form">
                <div class="form-group">
                  <label for="treatment">Tratamento/Conduta <span class="required">*</span></label>
                  <textarea 
                    id="treatment" 
                    formControlName="treatment" 
                    class="form-control"
                    rows="3"
                    placeholder="Descreva o tratamento e conduta para o paciente (mínimo 20 caracteres)..."
                  ></textarea>
                  @if (therapeuticPlanForm.get('treatment')?.invalid && therapeuticPlanForm.get('treatment')?.touched) {
                    <div class="error-message">Tratamento é obrigatório (mínimo 20 caracteres)</div>
                  }
                </div>

                <div class="form-group">
                  <label for="medicationPrescription">Prescrição Medicamentosa</label>
                  <textarea 
                    id="medicationPrescription" 
                    formControlName="medicationPrescription" 
                    class="form-control"
                    rows="3"
                    placeholder="Medicamentos prescritos, dosagens e instruções..."
                  ></textarea>
                </div>

                <div class="form-group">
                  <label for="examRequests">Solicitação de Exames</label>
                  <textarea 
                    id="examRequests" 
                    formControlName="examRequests" 
                    class="form-control"
                    rows="2"
                    placeholder="Exames solicitados..."
                  ></textarea>
                </div>

                <div class="form-group">
                  <label for="referrals">Encaminhamentos</label>
                  <textarea 
                    id="referrals" 
                    formControlName="referrals" 
                    class="form-control"
                    rows="2"
                    placeholder="Encaminhamentos para especialistas..."
                  ></textarea>
                </div>

                <div class="form-group">
                  <label for="patientGuidance">Orientações ao Paciente</label>
                  <textarea 
                    id="patientGuidance" 
                    formControlName="patientGuidance" 
                    class="form-control"
                    rows="2"
                    placeholder="Orientações e recomendações..."
                  ></textarea>
                </div>

                <div class="form-group">
                  <label for="returnDate">Data de Retorno</label>
                  <input 
                    type="date" 
                    id="returnDate" 
                    formControlName="returnDate" 
                    class="form-control"
                  />
                </div>

                <button type="button" class="btn btn-primary" (click)="onAddTherapeuticPlan()" [disabled]="!therapeuticPlanForm.valid">
                  Adicionar Plano Terapêutico
                </button>
              </form>
            }

            @if (therapeuticPlans().length > 0) {
              <div class="plans-list">
                @for (plan of therapeuticPlans(); track plan.id) {
                  <div class="plan-item">
                    <div class="plan-treatment"><strong>Tratamento:</strong> {{ plan.treatment }}</div>
                    @if (plan.medicationPrescription) {
                      <div class="plan-medication"><strong>Prescrição:</strong> {{ plan.medicationPrescription }}</div>
                    }
                    @if (plan.examRequests) {
                      <div class="plan-exams"><strong>Exames:</strong> {{ plan.examRequests }}</div>
                    }
                    @if (plan.referrals) {
                      <div class="plan-referrals"><strong>Encaminhamentos:</strong> {{ plan.referrals }}</div>
                    }
                    @if (plan.patientGuidance) {
                      <div class="plan-guidance"><strong>Orientações:</strong> {{ plan.patientGuidance }}</div>
                    }
                    @if (plan.returnDate) {
                      <div class="plan-return"><strong>Retorno:</strong> {{ plan.returnDate | date: 'dd/MM/yyyy' }}</div>
                    }
                    <div class="plan-date">{{ plan.createdAt | date: 'dd/MM/yyyy HH:mm' }}</div>
                  </div>
                }
              </div>
            } @else {
              <p class="text-muted">Nenhum plano terapêutico registrado. É obrigatório adicionar pelo menos um plano terapêutico.</p>
            }
          </div>

          <!-- Legacy Fields (Optional - kept for backward compatibility) -->
          <div class="card legacy-fields">
            <h3>Campos Adicionais (Opcional)</h3>
            <p class="info-text">Estes campos são mantidos para compatibilidade, mas os campos CFM 1.821 acima são obrigatórios.</p>
            
            <div class="form-group">
              <app-rich-text-editor
                formControlName="diagnosis"
                id="diagnosis"
                label="Diagnóstico (Legacy)"
                placeholder="Campo legado - use Hipóteses Diagnósticas CFM acima"
                [rows]="3"
                [enableMedicationAutocomplete]="false"
                [enableExamAutocomplete]="false"
              ></app-rich-text-editor>
            </div>

            <div class="form-group">
              <app-rich-text-editor
                formControlName="prescription"
                id="prescription"
                label="Prescrição Médica (Legacy)"
                placeholder="Campo legado - use Plano Terapêutico CFM acima"
                [rows]="4"
                [enableMedicationAutocomplete]="true"
                [enableExamAutocomplete]="false"
                (medicationSelected)="onMedicationSelected($event)"
              ></app-rich-text-editor>
              <button type="button" class="btn btn-outline btn-print" (click)="onPrint()">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="6 9 6 2 18 2 18 9"></polyline>
                  <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path>
                  <rect x="6" y="14" width="12" height="8"></rect>
                </svg>
                Imprimir Receita
              </button>
            </div>

            <div class="form-group">
              <app-rich-text-editor
                formControlName="notes"
                id="notes"
                label="Observações Clínicas (Legacy)"
                placeholder="Campo legado para anotações adicionais"
                [rows]="3"
                [enableMedicationAutocomplete]="true"
                [enableExamAutocomplete]="true"
                (medicationSelected)="onMedicationSelected($event)"
                (examSelected)="onExamSelected($event)"
              ></app-rich-text-editor>
            </div>
          </div>

          <!-- Procedures Section -->
          <div class="card">
            <div class="card-header-flex">
              <h3>Procedimentos Realizados</h3>
              <button type="button" class="btn btn-outline" (click)="toggleAddProcedure()">
                {{ showAddProcedure() ? 'Cancelar' : '+ Adicionar Procedimento' }}
              </button>
            </div>
            
            @if (showAddProcedure()) {
              <form [formGroup]="procedureForm" class="add-form">
                <div class="form-group">
                  <label for="procedure">Procedimento</label>
                  <select id="procedure" formControlName="procedureId" class="form-control">
                    <option value="">Selecione um procedimento</option>
                    @for (proc of availableProcedures(); track proc.id) {
                      <option [value]="proc.id">{{ proc.name }} - R$ {{ proc.price }}</option>
                    }
                  </select>
                </div>
                <div class="form-row">
                  <div class="form-group">
                    <label for="customPrice">Preço Personalizado (opcional)</label>
                    <input 
                      type="number" 
                      id="customPrice" 
                      formControlName="customPrice" 
                      class="form-control" 
                      placeholder="Deixe vazio para usar preço padrão"
                      step="0.01"
                    />
                  </div>
                  <div class="form-group">
                    <label for="procedureNotes">Observações</label>
                    <input 
                      type="text" 
                      id="procedureNotes" 
                      formControlName="notes" 
                      class="form-control" 
                      placeholder="Observações sobre o procedimento"
                    />
                  </div>
                </div>
                <button type="button" class="btn btn-primary" (click)="onAddProcedure()" [disabled]="!procedureForm.valid">
                  Adicionar
                </button>
              </form>
            }

            @if (appointmentProcedures().length > 0) {
              <div class="procedures-list">
                @for (proc of appointmentProcedures(); track proc.id) {
                  <div class="procedure-item">
                    <div class="procedure-info">
                      <strong>{{ proc.procedureName }}</strong>
                      <span class="procedure-code">{{ proc.procedureCode }}</span>
                    </div>
                    <div class="procedure-price">R$ {{ proc.priceCharged }}</div>
                    @if (proc.notes) {
                      <div class="procedure-notes">{{ proc.notes }}</div>
                    }
                  </div>
                }
                <div class="procedures-total">
                  <strong>Total:</strong> <span>R$ {{ getTotalProceduresCost() }}</span>
                </div>
              </div>
            } @else {
              <p class="text-muted">Nenhum procedimento adicionado</p>
            }
          </div>

          <!-- Exam Requests Section -->
          <div class="card">
            <div class="card-header-flex">
              <h3>Pedidos de Exames</h3>
              <button type="button" class="btn btn-outline" (click)="toggleAddExam()">
                {{ showAddExam() ? 'Cancelar' : '+ Solicitar Exame' }}
              </button>
            </div>
            
            @if (showAddExam()) {
              <form [formGroup]="examForm" class="add-form">
                <div class="form-row">
                  <div class="form-group">
                    <label for="examType">Tipo de Exame</label>
                    <select id="examType" formControlName="examType" class="form-control">
                      @for (type of examTypes; track type) {
                        <option [value]="type">{{ examTypeLabels[type] }}</option>
                      }
                    </select>
                  </div>
                  <div class="form-group">
                    <label for="urgency">Urgência</label>
                    <select id="urgency" formControlName="urgency" class="form-control">
                      @for (urgency of examUrgencies; track urgency) {
                        <option [value]="urgency">{{ examUrgencyLabels[urgency] }}</option>
                      }
                    </select>
                  </div>
                </div>
                <div class="form-group">
                  <label for="examName">Nome do Exame</label>
                  <input 
                    type="text" 
                    id="examName" 
                    formControlName="examName" 
                    class="form-control" 
                    placeholder="Ex: Hemograma Completo, Raio-X de Tórax"
                  />
                </div>
                <div class="form-group">
                  <label for="description">Descrição / Justificativa</label>
                  <textarea 
                    id="description" 
                    formControlName="description" 
                    class="form-control" 
                    rows="2"
                    placeholder="Motivo da solicitação do exame..."
                  ></textarea>
                </div>
                <div class="form-group">
                  <label for="examNotes">Observações Adicionais</label>
                  <input 
                    type="text" 
                    id="examNotes" 
                    formControlName="notes" 
                    class="form-control" 
                    placeholder="Instruções especiais, preparo, etc."
                  />
                </div>
                <button type="button" class="btn btn-primary" (click)="onAddExamRequest()" [disabled]="!examForm.valid">
                  Adicionar Pedido
                </button>
              </form>
            }

            @if (examRequests().length > 0) {
              <div class="exams-list">
                @for (exam of examRequests(); track exam.id) {
                  <div class="exam-item">
                    <div class="exam-header">
                      <strong>{{ exam.examName }}</strong>
                      <span class="exam-type-badge">{{ examTypeLabels[exam.examType] }}</span>
                      <span class="exam-urgency-badge urgency-{{ exam.urgency }}">{{ examUrgencyLabels[exam.urgency] }}</span>
                      <button type="button" class="btn-remove" (click)="removeExamRequest(exam)" title="Remover">
                        ✕
                      </button>
                    </div>
                    <div class="exam-description">{{ exam.description }}</div>
                    @if (exam.notes) {
                      <div class="exam-notes"><em>Obs: {{ exam.notes }}</em></div>
                    }
                  </div>
                }
              </div>
            } @else {
              <p class="text-muted">Nenhum pedido de exame adicionado</p>
            }
          </div>

          <!-- Digital Prescriptions Section - CFM 1.643/2002 + ANVISA -->
          <div class="card">
            <div class="card-header-flex">
              <h3>Receitas Médicas Digitais - CFM 1.643/2002 + ANVISA</h3>
              @if (medicalRecord()?.id) {
                <button 
                  type="button" 
                  class="btn btn-primary" 
                  [routerLink]="['/prescriptions/new', medicalRecord()!.id]"
                  title="Criar nova receita digital conforme CFM e ANVISA"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="12" y1="18" x2="12" y2="12"></line>
                    <line x1="9" y1="15" x2="15" y2="15"></line>
                  </svg>
                  Nova Receita Digital
                </button>
              }
            </div>
            <div class="prescription-info">
              <p class="info-text">
                <strong>Sistema de Receitas Digitais:</strong> Crie receitas em conformidade com CFM 1.643/2002 e ANVISA 344/1998.
                Suporta receitas simples, controladas (A, B, C1) e antimicrobianas com rastreamento SNGPC.
              </p>
              @if (!medicalRecord()?.id) {
                <p class="text-warning">
                  ⚠️ Salve o prontuário primeiro para habilitar a criação de receitas digitais.
                </p>
              }
            </div>
          </div>

          <div class="form-actions">
            <button type="button" class="btn btn-secondary" (click)="onSave()" [disabled]="isLoading()">
              Salvar Prontuário
            </button>
            <button type="button" class="btn btn-primary" (click)="onComplete()" [disabled]="isLoading() || medicalRecord()?.consultationEndTime">
              {{ medicalRecord()?.consultationEndTime ? 'Consulta Finalizada' : 'Finalizar e Notificar Secretaria' }}
            </button>
          </div>
          @if (medicalRecord()?.consultationEndTime) {
            <div class="completion-notice">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                <polyline points="22 4 12 14.01 9 11.01"></polyline>
              </svg>
              Consulta finalizada - Secretaria foi notificada para chamar o próximo paciente
            </div>
          }
        </form>
      </div>
    </div>
  }
</div>

<!-- Print-only section -->
<div class="print-only">
  @if (patient() && medicalRecord()) {
    <div class="prescription-print">
      <h2>Prescrição Médica</h2>
      <div class="prescription-header">
        <p><strong>Paciente:</strong> {{ patient()!.name }}</p>
        <p><strong>Data:</strong> {{ medicalRecord()!.consultationStartTime | date: 'dd/MM/yyyy HH:mm' }}</p>
      </div>
      <div class="prescription-content">
        {{ attendanceForm.get('prescription')?.value }}
      </div>
    </div>
  }
</div>
