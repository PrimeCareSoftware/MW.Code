<app-navbar></app-navbar>

<div class="external-services">
  <div class="header">
    <div>
      <h1>Configura√ß√£o de Servi√ßos Externos</h1>
      <p class="subtitle">Gerencie as chaves de API e configura√ß√µes de todos os servi√ßos externos integrados ao sistema</p>
    </div>
    <button class="btn btn-primary" (click)="openCreateModal()">
      <span>‚ûï Adicionar Servi√ßo</span>
    </button>
  </div>

  @if (loading()) {
    <div class="loading">Carregando servi√ßos...</div>
  } @else if (error()) {
    <div class="error">
      <p>Erro: {{ error() }}</p>
      <button (click)="loadServices()" class="btn-retry">Tentar novamente</button>
    </div>
  } @else {
    <div class="table-container">
      <table class="services-table">
        <thead>
          <tr>
            <th>Servi√ßo</th>
            <th>Tipo</th>
            <th>Configura√ß√£o</th>
            <th>Status</th>
            <th>√öltima Sincroniza√ß√£o</th>
            <th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody>
          @for (service of services(); track service.id) {
            <tr>
              <td>
                <div class="service-info">
                  <div class="service-name">{{ service.serviceName }}</div>
                  @if (service.description) {
                    <div class="service-desc">{{ service.description }}</div>
                  }
                  @if (service.clinicName) {
                    <div class="clinic-badge">üè• {{ service.clinicName }}</div>
                  }
                </div>
              </td>
              <td>
                <span class="service-type-badge">{{ getServiceTypeLabel(service.serviceType) }}</span>
              </td>
              <td>
                <div class="config-info">
                  @if (service.hasApiKey) {
                    <span class="config-badge">üîë API Key</span>
                  }
                  @if (service.hasClientId) {
                    <span class="config-badge">üë§ Client ID</span>
                  }
                  @if (service.hasAccessToken) {
                    <span class="config-badge">üé´ Token</span>
                    @if (service.isTokenExpired) {
                      <span class="config-badge expired">‚ö†Ô∏è Expirado</span>
                    }
                  }
                  @if (service.apiUrl) {
                    <div class="config-url">
                      <code>{{ service.apiUrl }}</code>
                    </div>
                  }
                </div>
              </td>
              <td>
                <span class="status-badge" [ngClass]="getStatusBadgeClass(service)">
                  {{ getStatusText(service) }}
                </span>
                @if (service.lastError) {
                  <div class="error-info" [title]="service.lastError">
                    ‚ö†Ô∏è {{ service.lastError.substring(0, 50) }}...
                  </div>
                }
              </td>
              <td>
                <div class="date-info">
                  {{ formatDate(service.lastSyncAt) }}
                </div>
              </td>
              <td>
                <div class="actions">
                  <button class="btn-icon" (click)="openEditModal(service)" title="Editar">
                    ‚úèÔ∏è
                  </button>
                  <button class="btn-icon btn-danger" (click)="deleteService(service.id, service.serviceName)" title="Excluir">
                    üóëÔ∏è
                  </button>
                </div>
              </td>
            </tr>
          }
        </tbody>
      </table>

      @if (services().length === 0) {
        <div class="empty-state">
          <p>üì¶ Nenhum servi√ßo externo configurado</p>
          <p class="empty-subtitle">Clique em "Adicionar Servi√ßo" para come√ßar</p>
        </div>
      }
    </div>
  }
</div>

<!-- Modal for Create/Edit -->
@if (showModal) {
  <div class="modal-overlay" (click)="closeModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>{{ editingService ? 'Editar Servi√ßo' : 'Adicionar Servi√ßo' }}</h2>
        <button class="btn-close" (click)="closeModal()">‚úï</button>
      </div>

      <form (ngSubmit)="onSubmit()">
        <div class="form-section">
          <h3>Informa√ß√µes B√°sicas</h3>
          
          <div class="form-group">
            <label for="serviceType">Tipo de Servi√ßo *</label>
            <select 
              id="serviceType" 
              [(ngModel)]="formData.serviceType" 
              name="serviceType"
              [disabled]="editingService !== null"
              required
            >
              @for (type of availableServiceTypes; track type.value) {
                <option [value]="type.value">{{ type.label }}</option>
              }
            </select>
            @if (editingService) {
              <small class="form-hint">O tipo de servi√ßo n√£o pode ser alterado ap√≥s a cria√ß√£o</small>
            }
          </div>

          <div class="form-group">
            <label for="serviceName">Nome do Servi√ßo *</label>
            <input 
              type="text" 
              id="serviceName" 
              [(ngModel)]="formData.serviceName" 
              name="serviceName"
              placeholder="Ex: SendGrid Produ√ß√£o"
              required
            >
          </div>

          <div class="form-group">
            <label for="description">Descri√ß√£o</label>
            <textarea 
              id="description" 
              [(ngModel)]="formData.description" 
              name="description"
              rows="2"
              placeholder="Descri√ß√£o opcional do servi√ßo"
            ></textarea>
          </div>

          <div class="form-group">
            <label>
              <input 
                type="checkbox" 
                [(ngModel)]="formData.isActive" 
                name="isActive"
              >
              Servi√ßo ativo
            </label>
          </div>
        </div>

        <div class="form-section">
          <div class="section-header">
            <h3>Credenciais</h3>
            @if (editingService) {
              <button type="button" class="btn-link" (click)="toggleShowSecrets()">
                {{ showSecrets ? 'üôà Ocultar' : 'üëÅÔ∏è Mostrar campos' }}
              </button>
            }
          </div>

          @if (!editingService || showSecrets) {
            <div class="form-row">
              <div class="form-group">
                <label for="apiKey">API Key</label>
                <input 
                  type="password" 
                  id="apiKey" 
                  [(ngModel)]="formData.apiKey" 
                  name="apiKey"
                  placeholder="Digite a API Key"
                >
                <small class="form-hint">
                  @if (editingService && editingService.hasApiKey) {
                    Deixe em branco para manter o valor atual
                  } @else {
                    Chave de API para autentica√ß√£o
                  }
                </small>
              </div>

              <div class="form-group">
                <label for="apiSecret">API Secret</label>
                <input 
                  type="password" 
                  id="apiSecret" 
                  [(ngModel)]="formData.apiSecret" 
                  name="apiSecret"
                  placeholder="Digite o API Secret"
                >
                <small class="form-hint">
                  @if (editingService && editingService.hasApiSecret) {
                    Deixe em branco para manter o valor atual
                  } @else {
                    Secret para autentica√ß√£o
                  }
                </small>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="clientId">Client ID</label>
                <input 
                  type="text" 
                  id="clientId" 
                  [(ngModel)]="formData.clientId" 
                  name="clientId"
                  placeholder="Digite o Client ID"
                >
              </div>

              <div class="form-group">
                <label for="clientSecret">Client Secret</label>
                <input 
                  type="password" 
                  id="clientSecret" 
                  [(ngModel)]="formData.clientSecret" 
                  name="clientSecret"
                  placeholder="Digite o Client Secret"
                >
                <small class="form-hint">
                  @if (editingService && editingService.hasClientSecret) {
                    Deixe em branco para manter o valor atual
                  }
                </small>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="accessToken">Access Token</label>
                <input 
                  type="password" 
                  id="accessToken" 
                  [(ngModel)]="formData.accessToken" 
                  name="accessToken"
                  placeholder="Digite o Access Token"
                >
              </div>

              <div class="form-group">
                <label for="refreshToken">Refresh Token</label>
                <input 
                  type="password" 
                  id="refreshToken" 
                  [(ngModel)]="formData.refreshToken" 
                  name="refreshToken"
                  placeholder="Digite o Refresh Token"
                >
              </div>
            </div>
          } @else {
            <div class="credentials-summary">
              <p>‚úÖ Credenciais configuradas e armazenadas de forma segura</p>
              <p class="form-hint">Clique em "Mostrar campos" para atualizar as credenciais</p>
            </div>
          }
        </div>

        <div class="form-section">
          <h3>Configura√ß√µes do Servi√ßo</h3>

          <div class="form-group">
            <label for="apiUrl">API URL</label>
            <input 
              type="url" 
              id="apiUrl" 
              [(ngModel)]="formData.apiUrl" 
              name="apiUrl"
              placeholder="https://api.exemplo.com"
            >
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="webhookUrl">Webhook URL</label>
              <input 
                type="url" 
                id="webhookUrl" 
                [(ngModel)]="formData.webhookUrl" 
                name="webhookUrl"
                placeholder="https://hooks.exemplo.com"
              >
            </div>

            <div class="form-group">
              <label for="accountId">Account ID</label>
              <input 
                type="text" 
                id="accountId" 
                [(ngModel)]="formData.accountId" 
                name="accountId"
                placeholder="ID da conta"
              >
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="projectId">Project ID</label>
              <input 
                type="text" 
                id="projectId" 
                [(ngModel)]="formData.projectId" 
                name="projectId"
                placeholder="ID do projeto"
              >
            </div>

            <div class="form-group">
              <label for="region">Regi√£o</label>
              <input 
                type="text" 
                id="region" 
                [(ngModel)]="formData.region" 
                name="region"
                placeholder="Ex: us-east-1, sa-east-1"
              >
            </div>
          </div>

          <div class="form-group">
            <label for="additionalConfiguration">Configura√ß√µes Adicionais (JSON)</label>
            <textarea 
              id="additionalConfiguration" 
              [(ngModel)]="formData.additionalConfiguration" 
              name="additionalConfiguration"
              rows="4"
              placeholder='{"customField": "value"}'
            ></textarea>
            <small class="form-hint">Configura√ß√µes espec√≠ficas do servi√ßo em formato JSON</small>
          </div>
        </div>

        @if (modalError()) {
          <div class="alert alert-error">
            {{ modalError() }}
          </div>
        }

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="closeModal()" [disabled]="submitting()">
            Cancelar
          </button>
          <button type="submit" class="btn btn-primary" [disabled]="submitting()">
            @if (submitting()) {
              Salvando...
            } @else {
              {{ editingService ? 'Atualizar' : 'Criar' }} Servi√ßo
            }
          </button>
        </div>
      </form>
    </div>
  </div>
}
