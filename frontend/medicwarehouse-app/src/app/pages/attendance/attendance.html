<app-navbar></app-navbar>

<div class="attendance-container">
  <div class="page-header">
    <div>
      <h1>Atendimento ao Paciente</h1>
      <p>Registro de consulta e prontuário médico</p>
    </div>
    <button class="btn btn-secondary" routerLink="/appointments">Voltar para Agenda</button>
  </div>

  @if (errorMessage()) {
    <div class="alert alert-error">{{ errorMessage() }}</div>
  }
  @if (successMessage()) {
    <div class="alert alert-success">{{ successMessage() }}</div>
  }

  @if (isLoading()) {
    <div class="loading">Carregando...</div>
  } @else {
    <div class="attendance-layout">
      <!-- Left Panel - Patient Info and Timer -->
      <div class="left-panel">
        <!-- Patient Info Card -->
        <div class="card patient-info">
          <h3>Informações do Paciente</h3>
          @if (patient()) {
            <div class="patient-details">
              <div class="detail-row">
                <span class="label">Nome:</span>
                <span class="value">{{ patient()!.name }}</span>
              </div>
              <div class="detail-row">
                <span class="label">Idade:</span>
                <span class="value">{{ patient()!.age }} anos</span>
              </div>
              <div class="detail-row">
                <span class="label">CPF:</span>
                <span class="value">{{ patient()!.document }}</span>
              </div>
              <div class="detail-row">
                <span class="label">Telefone:</span>
                <span class="value">{{ patient()!.phone }}</span>
              </div>
              @if (patient()!.allergies) {
                <div class="detail-row highlight">
                  <span class="label">Alergias:</span>
                  <span class="value">{{ patient()!.allergies }}</span>
                </div>
              }
            </div>
          } @else {
            <p class="text-muted">Carregando informações do paciente...</p>
          }
        </div>

        <!-- Timer Card -->
        <div class="card timer-card">
          <h3>Tempo de Consulta</h3>
          <div class="timer-display">
            {{ formatTime(elapsedSeconds()) }}
          </div>
          <p class="timer-info">
            @if (medicalRecord()?.consultationEndTime) {
              Consulta finalizada
            } @else {
              Consulta em andamento
            }
          </p>
        </div>

        <!-- Patient History Card -->
        <div class="card patient-history">
          <h3>Histórico de Consultas</h3>
          @if (patientHistory().length > 0) {
            <div class="history-list">
              @for (record of patientHistory(); track record.id) {
                <div class="history-item">
                  <div class="history-date">
                    {{ record.consultationStartTime | date: 'dd/MM/yyyy' }}
                  </div>
                  <div class="history-info">
                    <p><strong>Diagnóstico:</strong> {{ record.diagnosis || 'N/A' }}</p>
                    <p><strong>Duração:</strong> {{ record.consultationDurationMinutes }} min</p>
                  </div>
                </div>
              }
            </div>
          } @else {
            <p class="text-muted">Nenhum histórico de consultas</p>
          }
        </div>
      </div>

      <!-- Right Panel - Medical Record Form -->
      <div class="right-panel">
        <form [formGroup]="attendanceForm" class="medical-record-form">
          <div class="card">
            <h3>Prontuário Médico</h3>
            
            <div class="form-group">
              <app-rich-text-editor
                formControlName="diagnosis"
                id="diagnosis"
                label="Diagnóstico"
                placeholder="Descreva o diagnóstico do paciente..."
                [rows]="4"
                [enableMedicationAutocomplete]="false"
                [enableExamAutocomplete]="false"
              ></app-rich-text-editor>
            </div>

            <div class="form-group">
              <app-rich-text-editor
                formControlName="prescription"
                id="prescription"
                label="Prescrição Médica"
                placeholder="Receite medicamentos, dosagens, e instruções de uso... Use @@ para buscar medicações"
                [rows]="8"
                [enableMedicationAutocomplete]="true"
                [enableExamAutocomplete]="false"
                (medicationSelected)="onMedicationSelected($event)"
              ></app-rich-text-editor>
              <button type="button" class="btn btn-outline btn-print" (click)="onPrint()">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="6 9 6 2 18 2 18 9"></polyline>
                  <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path>
                  <rect x="6" y="14" width="12" height="8"></rect>
                </svg>
                Imprimir Receita
              </button>
            </div>

            <div class="form-group">
              <app-rich-text-editor
                formControlName="notes"
                id="notes"
                label="Observações Clínicas"
                placeholder="Anotações adicionais sobre a consulta... Use @@ para medicações e ## para exames"
                [rows]="4"
                [enableMedicationAutocomplete]="true"
                [enableExamAutocomplete]="true"
                (medicationSelected)="onMedicationSelected($event)"
                (examSelected)="onExamSelected($event)"
              ></app-rich-text-editor>
            </div>
          </div>

          <!-- Procedures Section -->
          <div class="card">
            <div class="card-header-flex">
              <h3>Procedimentos Realizados</h3>
              <button type="button" class="btn btn-outline" (click)="toggleAddProcedure()">
                {{ showAddProcedure() ? 'Cancelar' : '+ Adicionar Procedimento' }}
              </button>
            </div>
            
            @if (showAddProcedure()) {
              <form [formGroup]="procedureForm" class="add-form">
                <div class="form-group">
                  <label for="procedure">Procedimento</label>
                  <select id="procedure" formControlName="procedureId" class="form-control">
                    <option value="">Selecione um procedimento</option>
                    @for (proc of availableProcedures(); track proc.id) {
                      <option [value]="proc.id">{{ proc.name }} - R$ {{ proc.price }}</option>
                    }
                  </select>
                </div>
                <div class="form-row">
                  <div class="form-group">
                    <label for="customPrice">Preço Personalizado (opcional)</label>
                    <input 
                      type="number" 
                      id="customPrice" 
                      formControlName="customPrice" 
                      class="form-control" 
                      placeholder="Deixe vazio para usar preço padrão"
                      step="0.01"
                    />
                  </div>
                  <div class="form-group">
                    <label for="procedureNotes">Observações</label>
                    <input 
                      type="text" 
                      id="procedureNotes" 
                      formControlName="notes" 
                      class="form-control" 
                      placeholder="Observações sobre o procedimento"
                    />
                  </div>
                </div>
                <button type="button" class="btn btn-primary" (click)="onAddProcedure()" [disabled]="!procedureForm.valid">
                  Adicionar
                </button>
              </form>
            }

            @if (appointmentProcedures().length > 0) {
              <div class="procedures-list">
                @for (proc of appointmentProcedures(); track proc.id) {
                  <div class="procedure-item">
                    <div class="procedure-info">
                      <strong>{{ proc.procedureName }}</strong>
                      <span class="procedure-code">{{ proc.procedureCode }}</span>
                    </div>
                    <div class="procedure-price">R$ {{ proc.priceCharged }}</div>
                    @if (proc.notes) {
                      <div class="procedure-notes">{{ proc.notes }}</div>
                    }
                  </div>
                }
                <div class="procedures-total">
                  <strong>Total:</strong> <span>R$ {{ getTotalProceduresCost() }}</span>
                </div>
              </div>
            } @else {
              <p class="text-muted">Nenhum procedimento adicionado</p>
            }
          </div>

          <!-- Exam Requests Section -->
          <div class="card">
            <div class="card-header-flex">
              <h3>Pedidos de Exames</h3>
              <button type="button" class="btn btn-outline" (click)="toggleAddExam()">
                {{ showAddExam() ? 'Cancelar' : '+ Solicitar Exame' }}
              </button>
            </div>
            
            @if (showAddExam()) {
              <form [formGroup]="examForm" class="add-form">
                <div class="form-row">
                  <div class="form-group">
                    <label for="examType">Tipo de Exame</label>
                    <select id="examType" formControlName="examType" class="form-control">
                      @for (type of examTypes; track type) {
                        <option [value]="type">{{ examTypeLabels[type] }}</option>
                      }
                    </select>
                  </div>
                  <div class="form-group">
                    <label for="urgency">Urgência</label>
                    <select id="urgency" formControlName="urgency" class="form-control">
                      @for (urgency of examUrgencies; track urgency) {
                        <option [value]="urgency">{{ examUrgencyLabels[urgency] }}</option>
                      }
                    </select>
                  </div>
                </div>
                <div class="form-group">
                  <label for="examName">Nome do Exame</label>
                  <input 
                    type="text" 
                    id="examName" 
                    formControlName="examName" 
                    class="form-control" 
                    placeholder="Ex: Hemograma Completo, Raio-X de Tórax"
                  />
                </div>
                <div class="form-group">
                  <label for="description">Descrição / Justificativa</label>
                  <textarea 
                    id="description" 
                    formControlName="description" 
                    class="form-control" 
                    rows="2"
                    placeholder="Motivo da solicitação do exame..."
                  ></textarea>
                </div>
                <div class="form-group">
                  <label for="examNotes">Observações Adicionais</label>
                  <input 
                    type="text" 
                    id="examNotes" 
                    formControlName="notes" 
                    class="form-control" 
                    placeholder="Instruções especiais, preparo, etc."
                  />
                </div>
                <button type="button" class="btn btn-primary" (click)="onAddExamRequest()" [disabled]="!examForm.valid">
                  Adicionar Pedido
                </button>
              </form>
            }

            @if (examRequests().length > 0) {
              <div class="exams-list">
                @for (exam of examRequests(); track exam.id) {
                  <div class="exam-item">
                    <div class="exam-header">
                      <strong>{{ exam.examName }}</strong>
                      <span class="exam-type-badge">{{ examTypeLabels[exam.examType] }}</span>
                      <span class="exam-urgency-badge urgency-{{ exam.urgency }}">{{ examUrgencyLabels[exam.urgency] }}</span>
                      <button type="button" class="btn-remove" (click)="removeExamRequest(exam)" title="Remover">
                        ✕
                      </button>
                    </div>
                    <div class="exam-description">{{ exam.description }}</div>
                    @if (exam.notes) {
                      <div class="exam-notes"><em>Obs: {{ exam.notes }}</em></div>
                    }
                  </div>
                }
              </div>
            } @else {
              <p class="text-muted">Nenhum pedido de exame adicionado</p>
            }
          </div>

          <div class="form-actions">
            <button type="button" class="btn btn-secondary" (click)="onSave()" [disabled]="isLoading()">
              Salvar Prontuário
            </button>
            <button type="button" class="btn btn-primary" (click)="onComplete()" [disabled]="isLoading() || medicalRecord()?.consultationEndTime">
              {{ medicalRecord()?.consultationEndTime ? 'Consulta Finalizada' : 'Finalizar Atendimento' }}
            </button>
          </div>
        </form>
      </div>
    </div>
  }
</div>

<!-- Print-only section -->
<div class="print-only">
  @if (patient() && medicalRecord()) {
    <div class="prescription-print">
      <h2>Prescrição Médica</h2>
      <div class="prescription-header">
        <p><strong>Paciente:</strong> {{ patient()!.name }}</p>
        <p><strong>Data:</strong> {{ medicalRecord()!.consultationStartTime | date: 'dd/MM/yyyy HH:mm' }}</p>
      </div>
      <div class="prescription-content">
        {{ attendanceForm.get('prescription')?.value }}
      </div>
    </div>
  }
</div>
