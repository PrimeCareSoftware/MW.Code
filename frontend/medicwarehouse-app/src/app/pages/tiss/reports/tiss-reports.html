<div class="tiss-reports-container">
  <app-navbar></app-navbar>
  
  <div class="page-header">
    <div class="header-content">
      <h1>Relatórios TISS</h1>
      <p>Relatórios analíticos sobre faturamento, glosas e procedimentos TISS</p>
    </div>
    <div class="header-actions">
      <button 
        type="button"
        class="btn btn-secondary" 
        (click)="exportToPDF()"
        [disabled]="!hasReportData() || isLoading()"
      >
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
          <polyline points="14 2 14 8 20 8"/>
        </svg>
        Exportar PDF
      </button>
      <button 
        type="button"
        class="btn btn-primary" 
        (click)="exportToExcel()"
        [disabled]="!hasReportData() || isLoading()"
      >
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
          <polyline points="14 2 14 8 20 8"/>
          <line x1="16" y1="13" x2="8" y2="13"/>
          <line x1="16" y1="17" x2="8" y2="17"/>
        </svg>
        Exportar Excel
      </button>
    </div>
  </div>

  <!-- Filters Section -->
  <div class="form-section">
    <div class="section-header">
      <div class="section-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/>
        </svg>
      </div>
      <div>
        <h3>Filtros do Relatório</h3>
        <p>Selecione os parâmetros para gerar o relatório desejado</p>
      </div>
    </div>
    
    <div class="form-grid">
      <div class="form-group">
        <label for="reportType">Tipo de Relatório <span class="required">*</span></label>
        <select 
          id="reportType"
          class="form-control" 
          [(ngModel)]="selectedReportType"
          (change)="onReportTypeChange()"
        >
          @for (type of reportTypes; track type.value) {
            <option [value]="type.value">{{ type.label }}</option>
          }
        </select>
      </div>
      
      <div class="form-group">
        <label for="startDate">Data Inicial <span class="required">*</span></label>
        <input 
          type="date" 
          id="startDate"
          class="form-control" 
          [(ngModel)]="startDate"
        />
      </div>
      
      <div class="form-group">
        <label for="endDate">Data Final <span class="required">*</span></label>
        <input 
          type="date" 
          id="endDate"
          class="form-control" 
          [(ngModel)]="endDate"
        />
      </div>
      
      <div class="form-group">
        <label for="operator">Operadora</label>
        <select 
          id="operator"
          class="form-control" 
          [(ngModel)]="selectedOperatorId"
        >
          <option value="all">Todas as Operadoras</option>
          @for (operator of operators(); track operator.id) {
            <option [value]="operator.id">{{ operator.tradeName }}</option>
          }
        </select>
      </div>
    </div>
    
    <div class="form-actions">
      <button 
        type="button"
        class="btn btn-primary" 
        (click)="generateReport()"
        [disabled]="isLoading()"
      >
        @if (isLoading()) {
          <span class="spinner"></span>
          <span>Gerando...</span>
        } @else {
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="12" y1="20" x2="12" y2="10"/>
            <line x1="18" y1="20" x2="18" y2="4"/>
            <line x1="6" y1="20" x2="6" y2="16"/>
          </svg>
          <span>Gerar Relatório</span>
        }
      </button>
    </div>
  </div>

  <!-- Error Message -->
  @if (errorMessage()) {
    <div class="alert alert-error">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"/>
        <line x1="12" y1="8" x2="12" y2="12"/>
        <line x1="12" y1="16" x2="12.01" y2="16"/>
      </svg>
      <span>{{ errorMessage() }}</span>
      <button type="button" class="btn-close" (click)="errorMessage.set('')">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"/>
          <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </div>
  }

  <!-- Loading State -->
  @if (isLoading()) {
    <div class="loading-state">
      <span class="spinner"></span>
      <p>Gerando relatório...</p>
    </div>
  }

  <!-- Report Preview Section -->
  @if (hasReportData() && !isLoading()) {
    <div class="report-section">
      <div class="section-header">
        <div class="section-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
            <polyline points="14 2 14 8 20 8"/>
            <line x1="16" y1="13" x2="8" y2="13"/>
            <line x1="16" y1="17" x2="8" y2="17"/>
          </svg>
        </div>
        <div>
          <h3>{{ getReportTitle() }}</h3>
          <p>
            Período: {{ startDate() }} a {{ endDate() }}
            @if (selectedOperatorId() !== 'all') {
              <span class="mx-2">|</span>
              <span>Operadora: {{ getSelectedOperatorName() }}</span>
            }
          </p>
        </div>
      </div>
      
      <div class="table-container">
        <!-- Billing Report -->
        @if (selectedReportType() === 'billing') {
          <div class="table-responsive">
            <table class="table table-hover table-striped">
              <thead>
                <tr>
                    <th>Operadora</th>
                    <th class="text-end">Total Faturado</th>
                    <th class="text-end">Total Aprovado</th>
                    <th class="text-end">Total Glosado</th>
                    <th class="text-center">Taxa de Glosa</th>
                    <th class="text-center">Guias</th>
                  </tr>
                </thead>
                <tbody>
                  @for (item of billingData(); track item.operatorId) {
                    <tr>
                      <td>{{ item.operatorName }}</td>
                      <td class="text-end">{{ formatCurrency(item.totalBilled) }}</td>
                      <td class="text-end text-success">{{ formatCurrency(item.totalBilled - item.totalGlosed) }}</td>
                      <td class="text-end text-danger">{{ formatCurrency(item.totalGlosed) }}</td>
                      <td class="text-center">
                        <span 
                          class="badge" 
                          [ngClass]="item.glosaPercentage > 15 ? 'badge-error' : item.glosaPercentage > 10 ? 'badge-warning' : 'badge-success'"
                        >
                          {{ formatPercentage(item.glosaPercentage) }}
                        </span>
                      </td>
                      <td class="text-center">
                        {{ formatNumber(item.totalGuides) }}
                        <small class="text-muted">({{ formatNumber(item.glosedGuides) }} glosadas)</small>
                      </td>
                    </tr>
                  }
                </tbody>
                @if (billingData().length > 1) {
                  <tfoot>
                    <tr class="table-light fw-bold">
                      <td>TOTAL</td>
                      <td class="text-end">
                        {{ formatCurrency(getTotalBilled(billingData())) }}
                      </td>
                      <td class="text-end text-success">
                        {{ formatCurrency(getTotalApproved(billingData())) }}
                      </td>
                      <td class="text-end text-danger">
                        {{ formatCurrency(getTotalGlosed(billingData())) }}
                      </td>
                      <td class="text-center">
                        @if (getTotalBilled(billingData()) > 0) {
                          <span class="badge badge-default">
                            {{ formatPercentage((getTotalGlosed(billingData()) / getTotalBilled(billingData())) * 100) }}
                          </span>
                        }
                      </td>
                      <td class="text-center">
                        {{ formatNumber(getTotalGuides(billingData())) }}
                      </td>
                    </tr>
                  </tfoot>
                }
              </table>
            </div>
          }

          <!-- Glosas Report -->
          @if (selectedReportType() === 'glosas') {
            <div class="table-responsive">
              <table class="table table-hover table-striped">
                <thead>
                  <tr>
                    <th>Operadora</th>
                    <th class="text-end">Total Glosado</th>
                    <th class="text-center">Taxa de Glosa</th>
                    <th class="text-center">Guias Glosadas</th>
                    <th class="text-center">Total de Guias</th>
                  </tr>
                </thead>
                <tbody>
                  @for (item of glosasData(); track item.operatorId) {
                    <tr>
                      <td>{{ item.operatorName }}</td>
                      <td class="text-end text-danger">{{ formatCurrency(item.totalGlosed) }}</td>
                      <td class="text-center">
                        <span 
                          class="badge" 
                          [ngClass]="item.glosaPercentage > 15 ? 'badge-error' : item.glosaPercentage > 10 ? 'badge-warning' : 'badge-success'"
                        >
                          {{ formatPercentage(item.glosaPercentage) }}
                        </span>
                      </td>
                      <td class="text-center">{{ formatNumber(item.glosedGuides) }}</td>
                      <td class="text-center">{{ formatNumber(item.totalGuides) }}</td>
                    </tr>
                  }
                </tbody>
              </table>
            </div>
          }

          <!-- Denials Report -->
          @if (selectedReportType() === 'denials') {
            <div class="table-responsive">
              <table class="table table-hover table-striped">
                <thead>
                  <tr>
                    <th>Operadora</th>
                    <th class="text-center">Total de Solicitações</th>
                    <th class="text-center">Aprovadas</th>
                    <th class="text-center">Negadas</th>
                    <th class="text-center">Pendentes</th>
                    <th class="text-center">Taxa de Aprovação</th>
                  </tr>
                </thead>
                <tbody>
                  @for (item of denialsData(); track item.operatorId) {
                    <tr>
                      <td>{{ item.operatorName }}</td>
                      <td class="text-center">{{ formatNumber(item.totalRequests) }}</td>
                      <td class="text-center text-success">{{ formatNumber(item.approvedRequests) }}</td>
                      <td class="text-center text-danger">{{ formatNumber(item.rejectedRequests) }}</td>
                      <td class="text-center text-warning">{{ formatNumber(item.pendingRequests) }}</td>
                      <td class="text-center">
                        <span 
                          class="badge" 
                          [ngClass]="item.approvalRate >= 80 ? 'badge-success' : item.approvalRate >= 60 ? 'badge-warning' : 'badge-error'"
                        >
                          {{ formatPercentage(item.approvalRate) }}
                        </span>
                      </td>
                    </tr>
                  }
                </tbody>
              </table>
            </div>
          }

          <!-- Approval Time Report -->
          @if (selectedReportType() === 'approvalTime') {
            <div class="table-responsive">
              <table class="table table-hover table-striped">
                <thead>
                  <tr>
                    <th>Operadora</th>
                    <th class="text-center">Média de Aprovação</th>
                    <th class="text-center">Tempo Mínimo</th>
                    <th class="text-center">Tempo Máximo</th>
                    <th class="text-center">Total Processado</th>
                  </tr>
                </thead>
                <tbody>
                  @for (item of approvalTimeData(); track item.operatorId) {
                    <tr>
                      <td>{{ item.operatorName }}</td>
                      <td class="text-center">
                        <span 
                          class="badge" 
                          [ngClass]="item.averageApprovalDays <= 5 ? 'badge-success' : item.averageApprovalDays <= 10 ? 'badge-warning' : 'badge-error'"
                        >
                          {{ formatDays(item.averageApprovalDays) }}
                        </span>
                      </td>
                      <td class="text-center">{{ formatDays(item.minApprovalDays) }}</td>
                      <td class="text-center">{{ formatDays(item.maxApprovalDays) }}</td>
                      <td class="text-center">{{ formatNumber(item.totalProcessed) }}</td>
                    </tr>
                  }
                </tbody>
              </table>
            </div>
          }

          <!-- Procedures Report -->
          @if (selectedReportType() === 'procedures') {
            <div class="table-responsive">
              <table class="table table-hover table-striped">
                <thead>
                  <tr>
                    <th>Código</th>
                    <th>Procedimento</th>
                    <th class="text-end">Total Faturado</th>
                    <th class="text-end">Total Glosado</th>
                    <th class="text-center">Taxa de Glosa</th>
                    <th class="text-center">Ocorrências</th>
                  </tr>
                </thead>
                <tbody>
                  @for (item of proceduresData(); track item.procedureCode) {
                    <tr>
                      <td><code>{{ item.procedureCode }}</code></td>
                      <td>{{ item.procedureName }}</td>
                      <td class="text-end">{{ formatCurrency(item.totalBilled) }}</td>
                      <td class="text-end text-danger">{{ formatCurrency(item.totalGlosed) }}</td>
                      <td class="text-center">
                        <span 
                          class="badge" 
                          [ngClass]="item.glosaPercentage > 20 ? 'badge-error' : item.glosaPercentage > 10 ? 'badge-warning' : 'badge-success'"
                        >
                          {{ formatPercentage(item.glosaPercentage) }}
                        </span>
                      </td>
                      <td class="text-center">
                        {{ formatNumber(item.glosedOccurrences) }} / {{ formatNumber(item.totalOccurrences) }}
                      </td>
                    </tr>
                  }
                </tbody>
              </table>
            </div>
          }
        </div>
      </div>
  }

  <!-- Empty State -->
  @if (!hasReportData() && !isLoading() && !errorMessage()) {
    <div class="empty-state">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
        <polyline points="14 2 14 8 20 8"/>
        <line x1="16" y1="13" x2="8" y2="13"/>
        <line x1="16" y1="17" x2="8" y2="17"/>
      </svg>
      <h3>Nenhum relatório gerado</h3>
      <p>
        Selecione os filtros desejados e clique em "Gerar Relatório" para visualizar os dados.
      </p>
    </div>
  }
</div>
