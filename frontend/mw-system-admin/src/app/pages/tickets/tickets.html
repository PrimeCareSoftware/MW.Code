<div class="tickets-page">
  <div class="page-header">
    <div class="header-left">
      <h1>Gerenciamento de Chamados</h1>
      <p>Visualize e gerencie todos os chamados do sistema</p>
    </div>
    
    <div class="view-toggle">
      <button 
        class="toggle-btn" 
        [class.active]="viewMode === 'kanban'"
        (click)="switchViewMode('kanban')"
      >
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="3" width="7" height="7"/>
          <rect x="14" y="3" width="7" height="7"/>
          <rect x="14" y="14" width="7" height="7"/>
          <rect x="3" y="14" width="7" height="7"/>
        </svg>
        Kanban
      </button>
      <button 
        class="toggle-btn" 
        [class.active]="viewMode === 'list'"
        (click)="switchViewMode('list')"
      >
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="8" y1="6" x2="21" y2="6"/>
          <line x1="8" y1="12" x2="21" y2="12"/>
          <line x1="8" y1="18" x2="21" y2="18"/>
          <line x1="3" y1="6" x2="3.01" y2="6"/>
          <line x1="3" y1="12" x2="3.01" y2="12"/>
          <line x1="3" y1="18" x2="3.01" y2="18"/>
        </svg>
        Lista
      </button>
    </div>
  </div>

  <!-- Statistics Cards -->
  @if (statistics(); as stats) {
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon" style="background: #dbeafe; color: #1e40af;">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
          </svg>
        </div>
        <div class="stat-content">
          <span class="stat-label">Total de Chamados</span>
          <span class="stat-value">{{ stats.totalTickets }}</span>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon" style="background: #dcfce7; color: #166534;">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="20 6 9 17 4 12"/>
          </svg>
        </div>
        <div class="stat-content">
          <span class="stat-label">Concluídos</span>
          <span class="stat-value">{{ stats.completedTickets }}</span>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon" style="background: #fef3c7; color: #92400e;">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <polyline points="12 6 12 12 16 14"/>
          </svg>
        </div>
        <div class="stat-content">
          <span class="stat-label">Em Andamento</span>
          <span class="stat-value">{{ stats.inProgressTickets }}</span>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon" style="background: #fee2e2; color: #991b1b;">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <line x1="15" y1="9" x2="9" y2="15"/>
            <line x1="9" y1="9" x2="15" y2="15"/>
          </svg>
        </div>
        <div class="stat-content">
          <span class="stat-label">Com Impedimento</span>
          <span class="stat-value">{{ stats.blockedTickets }}</span>
        </div>
      </div>
    </div>
  }

  <!-- Filters -->
  <div class="filters">
    <div class="search-box">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="11" cy="11" r="8"/>
        <path d="m21 21-4.35-4.35"/>
      </svg>
      <input
        type="text"
        placeholder="Buscar por título, usuário ou clínica..."
        [(ngModel)]="searchQuery"
        (input)="applyFilters()"
      />
    </div>

    <select [(ngModel)]="typeFilter" (change)="applyFilters()">
      <option value="all">Todos os Tipos</option>
      <option [value]="TicketType.BugReport">Reporte de Bug</option>
      <option [value]="TicketType.FeatureRequest">Solicitação de Funcionalidade</option>
      <option [value]="TicketType.SystemAdjustment">Ajuste no Sistema</option>
      <option [value]="TicketType.FinancialIssue">Questão Financeira</option>
      <option [value]="TicketType.TechnicalSupport">Suporte Técnico</option>
      <option [value]="TicketType.UserSupport">Suporte ao Usuário</option>
      <option [value]="TicketType.Other">Outro</option>
    </select>
  </div>

  <!-- Loading -->
  @if (isLoading()) {
    <div class="loading">
      <div class="spinner"></div>
      <p>Carregando chamados...</p>
    </div>
  }

  <!-- Kanban View -->
  @if (!isLoading() && viewMode === 'kanban') {
    <div class="kanban-board">
      @for (column of columns(); track column.status) {
        <div 
          class="kanban-column"
          (dragover)="onDragOver($event)"
          (drop)="onDrop($event, column.status)"
        >
          <div class="column-header" [style.border-left-color]="column.color">
            <h3>{{ column.label }}</h3>
            <span class="ticket-count">{{ column.tickets.length }}</span>
          </div>

          <div class="column-content">
            @for (ticket of column.tickets; track ticket.id) {
              <div 
                class="kanban-card"
                draggable="true"
                (dragstart)="onDragStart($event, ticket)"
                (click)="viewTicket(ticket.id)"
              >
                <h4>{{ ticket.title }}</h4>
                
                <div class="card-meta">
                  <span class="badge" [ngClass]="getPriorityBadgeClass(ticket.priority)">
                    {{ getTicketPriorityLabel(ticket.priority) }}
                  </span>
                  <span class="badge badge-type">
                    {{ getTicketTypeLabel(ticket.type) }}
                  </span>
                </div>

                <div class="card-footer">
                  <span class="user-info">{{ ticket.userName }}</span>
                  @if (ticket.clinicName) {
                    <span class="clinic-info">{{ ticket.clinicName }}</span>
                  }
                </div>

                <div class="card-date">
                  {{ formatDate(ticket.createdAt) }}
                </div>
              </div>
            } @empty {
              <div class="empty-column">
                <p>Nenhum chamado</p>
              </div>
            }
          </div>
        </div>
      }
    </div>
  }

  <!-- List View -->
  @if (!isLoading() && viewMode === 'list') {
    <div class="list-view">
      @for (ticket of filteredTickets; track ticket.id) {
        <div class="list-item" (click)="viewTicket(ticket.id)">
          <div class="list-item-content">
            <h3>{{ ticket.title }}</h3>
            <div class="list-meta">
              <span class="badge" [ngClass]="getStatusBadgeClass(ticket.status)">
                {{ getTicketStatusLabel(ticket.status) }}
              </span>
              <span class="badge" [ngClass]="getPriorityBadgeClass(ticket.priority)">
                {{ getTicketPriorityLabel(ticket.priority) }}
              </span>
              <span class="badge badge-type">
                {{ getTicketTypeLabel(ticket.type) }}
              </span>
            </div>
          </div>
          <div class="list-item-info">
            <span class="user-info">{{ ticket.userName }}</span>
            @if (ticket.clinicName) {
              <span class="clinic-info">{{ ticket.clinicName }}</span>
            }
            <span class="date-info">{{ formatDate(ticket.createdAt) }}</span>
          </div>
        </div>
      } @empty {
        <div class="empty-state">
          <p>Nenhum chamado encontrado</p>
        </div>
      }
    </div>
  }
</div>

<!-- Ticket Detail Modal -->
@if (showDetailModal() && selectedTicket(); as ticket) {
  <div class="modal-overlay" (click)="closeDetailModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>{{ ticket.title }}</h2>
        <button class="close-button" (click)="closeDetailModal()">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>

      <div class="modal-body">
        <!-- Status Update -->
        <div class="detail-section">
          <h4>Status do Chamado</h4>
          <div class="status-update-form">
            <select [(ngModel)]="newStatus" class="status-select">
              <option [value]="TicketStatus.Open">Aberto</option>
              <option [value]="TicketStatus.InAnalysis">Em Análise</option>
              <option [value]="TicketStatus.InProgress">Em Atendimento</option>
              <option [value]="TicketStatus.Blocked">Com Impedimento</option>
              <option [value]="TicketStatus.Completed">Concluído</option>
              <option [value]="TicketStatus.Cancelled">Cancelado</option>
            </select>
            @if (newStatus !== ticket.status) {
              <div class="status-comment">
                <textarea
                  [(ngModel)]="statusComment"
                  placeholder="Adicione um comentário sobre a mudança de status (opcional)"
                  rows="2"
                ></textarea>
                <button class="btn btn-primary" (click)="updateStatus()">
                  Atualizar Status
                </button>
              </div>
            }
          </div>
        </div>

        <!-- Badges -->
        <div class="ticket-badges">
          <span class="badge" [ngClass]="getStatusBadgeClass(ticket.status)">
            {{ getTicketStatusLabel(ticket.status) }}
          </span>
          <span class="badge" [ngClass]="getPriorityBadgeClass(ticket.priority)">
            {{ getTicketPriorityLabel(ticket.priority) }}
          </span>
          <span class="badge badge-type">
            {{ getTicketTypeLabel(ticket.type) }}
          </span>
        </div>

        <!-- Description -->
        <div class="detail-section">
          <h4>Descrição</h4>
          <p class="description">{{ ticket.description }}</p>
        </div>

        <!-- Metadata -->
        <div class="detail-section">
          <div class="metadata">
            <div class="metadata-item">
              <strong>Usuário:</strong>
              <span>{{ ticket.userName }} ({{ ticket.userEmail }})</span>
            </div>
            @if (ticket.clinicName) {
              <div class="metadata-item">
                <strong>Clínica:</strong>
                <span>{{ ticket.clinicName }}</span>
              </div>
            }
            <div class="metadata-item">
              <strong>Criado em:</strong>
              <span>{{ formatDate(ticket.createdAt) }}</span>
            </div>
            <div class="metadata-item">
              <strong>Última atualização:</strong>
              <span>{{ formatDate(ticket.updatedAt) }}</span>
            </div>
            @if (ticket.assignedToName) {
              <div class="metadata-item">
                <strong>Atribuído para:</strong>
                <span>{{ ticket.assignedToName }}</span>
              </div>
            }
          </div>
        </div>

        <!-- Attachments -->
        @if (ticket.attachments.length > 0) {
          <div class="detail-section">
            <h4>Anexos ({{ ticket.attachments.length }})</h4>
            <div class="attachments-list">
              @for (attachment of ticket.attachments; track attachment.id) {
                <div class="attachment-item">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                    <circle cx="8.5" cy="8.5" r="1.5"/>
                    <polyline points="21 15 16 10 5 21"/>
                  </svg>
                  <span>{{ attachment.fileName }}</span>
                </div>
              }
            </div>
          </div>
        }

        <!-- Comments -->
        <div class="detail-section">
          <h4>Comentários ({{ ticket.comments.length }})</h4>
          
          @if (ticket.comments.length > 0) {
            <div class="comments-list">
              @for (comment of ticket.comments; track comment.id) {
                <div class="comment" [class.system-owner]="comment.isSystemOwner">
                  <div class="comment-header">
                    <strong>{{ comment.authorName }}</strong>
                    @if (comment.isSystemOwner) {
                      <span class="badge badge-owner">Suporte</span>
                    }
                    <span class="comment-date">{{ formatDate(comment.createdAt) }}</span>
                  </div>
                  <p>{{ comment.comment }}</p>
                </div>
              }
            </div>
          } @else {
            <p class="no-comments">Nenhum comentário ainda</p>
          }

          <!-- Add Comment Form -->
          <div class="add-comment-form">
            <textarea
              [(ngModel)]="newComment"
              placeholder="Adicionar comentário..."
              rows="3"
              [disabled]="isAddingComment()"
            ></textarea>
            <button
              class="btn btn-primary"
              (click)="addComment()"
              [disabled]="!newComment.trim() || isAddingComment()"
            >
              @if (isAddingComment()) {
                <span class="spinner"></span>
                Enviando...
              } @else {
                Adicionar Comentário
              }
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
}
