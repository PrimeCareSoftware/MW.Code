import{c as r,i as a,k as l,la as h,n as u,q as i,qa as p,va as c,x as o}from"./chunk-W37OOKLC.js";var d=class s{constructor(e,t){this.http=e;this.router=t;this.hasToken()&&this.startSessionValidation()}apiUrl=c.apiUrl;tokenKey="auth_token";userKey="user_info";sessionCheckInterval=3e4;sessionCheckSubscription;isAuthenticated=o(this.hasToken());currentUser=o(this.getUserInfo());login(e){return this.http.post(`${this.apiUrl}/auth/owner-login`,e).pipe(l(t=>{this.setToken(t.token),this.setUserInfo({username:t.username,tenantId:t.tenantId,isSystemOwner:t.isSystemOwner}),this.isAuthenticated.set(!0),this.currentUser.set({username:t.username,tenantId:t.tenantId,isSystemOwner:t.isSystemOwner}),this.startSessionValidation()}))}logout(e=!1){this.stopSessionValidation(),localStorage.removeItem(this.tokenKey),localStorage.removeItem(this.userKey),this.isAuthenticated.set(!1),this.currentUser.set(null),e?this.router.navigate(["/login"],{state:{message:"Sua sess\xE3o foi encerrada porque voc\xEA fez login em outro dispositivo ou navegador."}}):this.router.navigate(["/login"])}getToken(){return localStorage.getItem(this.tokenKey)}setToken(e){localStorage.setItem(this.tokenKey,e)}hasToken(){return!!this.getToken()}setUserInfo(e){localStorage.setItem(this.userKey,JSON.stringify(e))}getUserInfo(){let e=localStorage.getItem(this.userKey);return e?JSON.parse(e):null}getCurrentUser(){return this.http.get(`${this.apiUrl}/auth/me`)}validateSession(){let e=this.getToken();if(!e)return new r(n=>{n.next({isValid:!1,message:"No token found"}),n.complete()});let t={token:e};return this.http.post(`${this.apiUrl}/auth/validate-session`,t)}startSessionValidation(){this.stopSessionValidation(),this.sessionCheckSubscription=a(this.sessionCheckInterval).subscribe(()=>{this.validateSession().subscribe({next:e=>{e.isValid||(console.warn("Session invalidated:",e.message),this.logout(!0))},error:e=>{console.error("Error validating session:",e)}})})}stopSessionValidation(){this.sessionCheckSubscription&&(this.sessionCheckSubscription.unsubscribe(),this.sessionCheckSubscription=null)}static \u0275fac=function(t){return new(t||s)(i(h),i(p))};static \u0275prov=u({token:s,factory:s.\u0275fac,providedIn:"root"})};export{d as a};
