<app-navbar></app-navbar>

<div class="patient-form-container">
  <div class="page-header">
    <div class="header-content">
      <a routerLink="/patients" class="back-link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="19" y1="12" x2="5" y2="12"/>
          <polyline points="12 19 5 12 12 5"/>
        </svg>
        Voltar para lista
      </a>
      <h1>{{ isEditMode() ? 'Editar Paciente' : 'Novo Paciente' }}</h1>
      <p>{{ isEditMode() ? 'Atualize os dados do paciente' : 'Preencha os dados para cadastrar um novo paciente' }}</p>
    </div>
  </div>

  @if (errorMessage()) {
    <div class="alert alert-error">{{ errorMessage() }}</div>
  }
  @if (successMessage()) {
    <div class="alert alert-success">{{ successMessage() }}</div>
  }

  <form [formGroup]="patientForm" (ngSubmit)="onSubmit()" class="patient-form">
    <!-- Personal Data Section -->
    <div class="form-section">
      <div class="section-header">
        <div class="section-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
            <circle cx="12" cy="7" r="4"/>
          </svg>
        </div>
        <div>
          <h3>Dados Pessoais</h3>
          <p>Informações básicas do paciente</p>
        </div>
      </div>
      
      <div class="form-grid">
        <div class="form-group col-span-2">
          <label for="name">Nome Completo <span class="required">*</span></label>
          <input type="text" id="name" formControlName="name" class="form-control" placeholder="Digite o nome completo"/>
        </div>
        <div class="form-group">
          <label for="document">CPF <span class="required">*</span></label>
          <input type="text" id="document" formControlName="document" class="form-control" [class.readonly]="isEditMode()" [readonly]="isEditMode()" placeholder="000.000.000-00"/>
          @if (isEditMode()) {
            <span class="form-hint">CPF não pode ser alterado</span>
          }
        </div>
        <div class="form-group">
          <label for="dateOfBirth">Data de Nascimento <span class="required">*</span></label>
          <input type="date" id="dateOfBirth" formControlName="dateOfBirth" class="form-control" [class.readonly]="isEditMode()" [readonly]="isEditMode()" (change)="onDateOfBirthChange()"/>
        </div>
        <div class="form-group">
          <label for="gender">Gênero <span class="required">*</span></label>
          <select id="gender" formControlName="gender" class="form-control" [disabled]="isEditMode()">
            <option value="">Selecione</option>
            <option value="M">Masculino</option>
            <option value="F">Feminino</option>
            <option value="O">Outro</option>
          </select>
        </div>
      </div>

      @if (isChildPatient()) {
        <div class="guardian-section">
          <div class="guardian-header">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
              <circle cx="9" cy="7" r="4"/>
              <line x1="19" y1="8" x2="19" y2="14"/>
              <line x1="22" y1="11" x2="16" y2="11"/>
            </svg>
            <div>
              <h4>Responsável Legal</h4>
              <p>Pacientes menores de 18 anos devem ter um responsável</p>
            </div>
          </div>
          
          <div class="form-group">
            <label for="guardianSearch">Buscar Responsável <span class="required">*</span></label>
            <div class="search-input-wrapper">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"/>
                <line x1="21" y1="21" x2="16.65" y2="16.65"/>
              </svg>
              <input 
                type="text" 
                id="guardianSearch" 
                [(ngModel)]="guardianSearchTerm"
                [ngModelOptions]="{standalone: true}"
                (input)="searchGuardian()"
                placeholder="Digite o nome ou CPF do responsável"
                class="form-control" 
              />
            </div>
            
            @if (guardianSearchResults().length > 0) {
              <div class="search-results">
                @for (patient of guardianSearchResults(); track patient.id) {
                  <button type="button" class="search-result-item" (click)="selectGuardian(patient)">
                    <div class="result-avatar">{{ patient.name.charAt(0) }}</div>
                    <div class="result-info">
                      <strong>{{ patient.name }}</strong>
                      <span>CPF: {{ patient.document }} · {{ patient.age }} anos</span>
                    </div>
                  </button>
                }
              </div>
            }
            
            @if (selectedGuardian()) {
              <div class="selected-guardian">
                <div class="guardian-info">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                    <polyline points="22 4 12 14.01 9 11.01"/>
                  </svg>
                  <span>Responsável: <strong>{{ selectedGuardian()!.name }}</strong></span>
                </div>
                <button type="button" class="btn-remove" (click)="clearGuardian()">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                  </svg>
                </button>
              </div>
            }
          </div>
        </div>
      }
    </div>

    <!-- Contact Section -->
    <div class="form-section">
      <div class="section-header">
        <div class="section-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
          </svg>
        </div>
        <div>
          <h3>Contato</h3>
          <p>Informações para comunicação</p>
        </div>
      </div>
      
      <div class="form-grid">
        <div class="form-group">
          <label for="email">E-mail <span class="required">*</span></label>
          <input type="email" id="email" formControlName="email" class="form-control" placeholder="email@exemplo.com"/>
        </div>
        <div class="form-group">
          <label for="phoneNumber">Telefone <span class="required">*</span></label>
          <input type="text" id="phoneNumber" formControlName="phoneNumber" class="form-control" placeholder="(00) 00000-0000"/>
        </div>
      </div>
    </div>

    <!-- Address Section -->
    <div class="form-section" formGroupName="address">
      <div class="section-header">
        <div class="section-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
            <circle cx="12" cy="10" r="3"/>
          </svg>
        </div>
        <div>
          <h3>Endereço</h3>
          <p>Localização do paciente</p>
        </div>
      </div>
      
      <div class="form-grid">
        <div class="form-group">
          <label for="zipCode">CEP <span class="required">*</span></label>
          <input type="text" id="zipCode" formControlName="zipCode" class="form-control" placeholder="00000-000"/>
        </div>
        <div class="form-group col-span-2">
          <label for="street">Rua <span class="required">*</span></label>
          <input type="text" id="street" formControlName="street" class="form-control" placeholder="Nome da rua"/>
        </div>
        <div class="form-group">
          <label for="number">Número <span class="required">*</span></label>
          <input type="text" id="number" formControlName="number" class="form-control" placeholder="123"/>
        </div>
        <div class="form-group">
          <label for="complement">Complemento</label>
          <input type="text" id="complement" formControlName="complement" class="form-control" placeholder="Apto, Bloco..."/>
        </div>
        <div class="form-group">
          <label for="neighborhood">Bairro <span class="required">*</span></label>
          <input type="text" id="neighborhood" formControlName="neighborhood" class="form-control" placeholder="Nome do bairro"/>
        </div>
        <div class="form-group">
          <label for="city">Cidade <span class="required">*</span></label>
          <input type="text" id="city" formControlName="city" class="form-control" placeholder="Nome da cidade"/>
        </div>
        <div class="form-group">
          <label for="state">Estado <span class="required">*</span></label>
          <input type="text" id="state" formControlName="state" class="form-control" placeholder="UF" maxlength="2"/>
        </div>
      </div>
    </div>

    <!-- Medical Info Section -->
    <div class="form-section">
      <div class="section-header">
        <div class="section-icon medical">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
          </svg>
        </div>
        <div>
          <h3>Informações Médicas</h3>
          <p>Dados importantes para o atendimento</p>
        </div>
      </div>
      
      <div class="form-grid">
        <div class="form-group col-span-full">
          <label for="medicalHistory">Histórico Médico</label>
          <textarea id="medicalHistory" formControlName="medicalHistory" class="form-control" rows="3" placeholder="Descreva o histórico médico relevante..."></textarea>
        </div>
        <div class="form-group col-span-full">
          <label for="allergies">
            Alergias
            <span class="label-badge warning">Importante</span>
          </label>
          <textarea id="allergies" formControlName="allergies" class="form-control allergy-field" rows="3" placeholder="Liste as alergias conhecidas..."></textarea>
        </div>
      </div>
    </div>

    <div class="form-actions">
      <button type="button" class="btn btn-secondary" routerLink="/patients">
        Cancelar
      </button>
      <button type="submit" class="btn btn-primary" [disabled]="patientForm.invalid || isLoading()">
        @if (isLoading()) {
          <span class="spinner"></span>
          <span>Salvando...</span>
        } @else {
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
            <polyline points="17 21 17 13 7 13 7 21"/>
            <polyline points="7 3 7 8 15 8"/>
          </svg>
          <span>Salvar Paciente</span>
        }
      </button>
    </div>
  </form>
</div>
