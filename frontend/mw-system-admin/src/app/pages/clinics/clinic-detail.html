<app-navbar></app-navbar>

<div class="clinic-detail">
      <div class="header">
        <div>
          <button class="btn-back" (click)="goBack()">‚Üê Voltar</button>
          <h1>Detalhes da Cl√≠nica</h1>
        </div>
      </div>

      @if (loading()) {
        <div class="loading">Carregando dados...</div>
      } @else if (error()) {
        <div class="error-message">{{ error() }}</div>
      } @else if (clinic()) {
        <!-- Tab Navigation -->
        <div class="tabs">
          <button 
            class="tab" 
            [class.active]="activeTab() === 'info'"
            (click)="setActiveTab('info')"
          >
            üìã Informa√ß√µes
          </button>
          <button 
            class="tab" 
            [class.active]="activeTab() === 'health'"
            (click)="setActiveTab('health')"
          >
            {{ getHealthScoreIcon() }} Health Score
          </button>
          <button 
            class="tab" 
            [class.active]="activeTab() === 'timeline'"
            (click)="setActiveTab('timeline')"
          >
            üìÖ Timeline
          </button>
          <button 
            class="tab" 
            [class.active]="activeTab() === 'metrics'"
            (click)="setActiveTab('metrics')"
          >
            üìä M√©tricas
          </button>
          <button 
            class="tab" 
            [class.active]="activeTab() === 'tags'"
            (click)="setActiveTab('tags')"
          >
            üè∑Ô∏è Tags
          </button>
        </div>

        <div class="content">
          <!-- Info Tab (Original Content) -->
          @if (activeTab() === 'info') {
          <!-- Clinic Info Card -->
          <div class="card">
            <div class="card-header">
              <h2>Informa√ß√µes da Cl√≠nica</h2>
              @if (!editMode()) {
                <button class="btn btn-secondary" (click)="toggleEditMode()">
                  ‚úèÔ∏è Editar
                </button>
              }
            </div>

            @if (editMode()) {
              <form (ngSubmit)="saveClinicChanges()" class="edit-form">
                <div class="form-grid">
                  <div class="form-group">
                    <label>Nome</label>
                    <input type="text" [(ngModel)]="editData.name" name="name" required />
                  </div>
                  <div class="form-group">
                    <label>CNPJ</label>
                    <input type="text" [(ngModel)]="editData.document" name="document" required />
                  </div>
                  <div class="form-group">
                    <label>Email</label>
                    <input type="email" [(ngModel)]="editData.email" name="email" required />
                  </div>
                  <div class="form-group">
                    <label>Telefone</label>
                    <input type="tel" [(ngModel)]="editData.phone" name="phone" required />
                  </div>
                  <div class="form-group full-width">
                    <label>Endere√ßo</label>
                    <input type="text" [(ngModel)]="editData.address" name="address" required />
                  </div>
                </div>

                @if (saveError()) {
                  <div class="error-message">{{ saveError() }}</div>
                }

                <div class="form-actions">
                  <button type="button" class="btn btn-secondary" (click)="cancelEdit()">
                    Cancelar
                  </button>
                  <button type="submit" class="btn btn-primary" [disabled]="saving()">
                    @if (saving()) {
                      <span>Salvando...</span>
                    } @else {
                      <span>Salvar Altera√ß√µes</span>
                    }
                  </button>
                </div>
              </form>
            } @else {
              <div class="info-grid">
                <div class="info-item">
                  <span class="label">Nome:</span>
                  <span class="value">{{ clinic()!.name }}</span>
                </div>
                <div class="info-item">
                  <span class="label">CNPJ:</span>
                  <span class="value">{{ clinic()!.document }}</span>
                </div>
                <div class="info-item">
                  <span class="label">Email:</span>
                  <span class="value">{{ clinic()!.email }}</span>
                </div>
                <div class="info-item">
                  <span class="label">Telefone:</span>
                  <span class="value">{{ clinic()!.phone }}</span>
                </div>
                <div class="info-item">
                  <span class="label">Endere√ßo:</span>
                  <span class="value">{{ clinic()!.address }}</span>
                </div>
                <div class="info-item">
                  <span class="label">Tenant ID:</span>
                  <span class="value">{{ clinic()!.tenantId }}</span>
                </div>
                <div class="info-item">
                  <span class="label">Status:</span>
                  <span class="badge" [class.active]="clinic()!.isActive" [class.inactive]="!clinic()!.isActive">
                    {{ clinic()!.isActive ? 'Ativa' : 'Inativa' }}
                  </span>
                </div>
                <div class="info-item">
                  <span class="label">Criada em:</span>
                  <span class="value">{{ formatDate(clinic()!.createdAt) }}</span>
                </div>
              </div>
            }
          </div>

          <!-- Subscription Card -->
          <div class="card">
            <div class="card-header">
              <h2>Assinatura e Plano</h2>
            </div>

            <div class="info-grid">
              <div class="info-item">
                <span class="label">Plano Atual:</span>
                <span class="value">{{ clinic()!.planName }}</span>
              </div>
              <div class="info-item">
                <span class="label">Valor:</span>
                <span class="value">{{ formatCurrency(clinic()!.planPrice) }}/m√™s</span>
              </div>
              <div class="info-item">
                <span class="label">Status:</span>
                <span class="badge" [class]="getStatusClass(clinic()!.subscriptionStatus)">
                  {{ getStatusLabel(clinic()!.subscriptionStatus) }}
                </span>
              </div>
              @if (clinic()!.trialEndsAt) {
                <div class="info-item">
                  <span class="label">Trial termina em:</span>
                  <span class="value">{{ formatDate(clinic()!.trialEndsAt) }}</span>
                </div>
              }
              @if (clinic()!.nextBillingDate) {
                <div class="info-item">
                  <span class="label">Pr√≥ximo pagamento:</span>
                  <span class="value">{{ formatDate(clinic()!.nextBillingDate) }}</span>
                </div>
              }
            </div>

            <div class="subscription-actions">
              <button class="btn btn-secondary" (click)="showChangePlanModal = true">
                Alterar Plano
              </button>
              <button class="btn btn-primary" (click)="showManualOverrideModal = true">
                üîì Override Manual
              </button>
            </div>
          </div>

          <!-- Users Card -->
          <div class="card">
            <div class="card-header">
              <h2>Usu√°rios</h2>
            </div>

            <div class="info-grid">
              <div class="info-item">
                <span class="label">Total de Usu√°rios:</span>
                <span class="value">{{ clinic()!.totalUsers }}</span>
              </div>
              <div class="info-item">
                <span class="label">Usu√°rios Ativos:</span>
                <span class="value success">{{ clinic()!.activeUsers }}</span>
              </div>
            </div>

            <div class="subscription-actions">
              <button class="btn btn-secondary" (click)="navigateToOwners()">
                Gerenciar Propriet√°rios
              </button>
            </div>
          </div>
          }

          <!-- Health Score Tab -->
          @if (activeTab() === 'health' && healthScore()) {
            <div class="card">
              <div class="card-header">
                <h2>{{ getHealthScoreIcon() }} Health Score da Cl√≠nica</h2>
              </div>

              <div class="health-score-container">
                <div class="health-score-main">
                  <div class="score-circle" [class]="getHealthScoreClass()">
                    <span class="score-value">{{ healthScore()!.totalScore }}</span>
                    <span class="score-label">/100</span>
                  </div>
                  <div class="score-status">
                    <span class="status-badge" [class]="getHealthScoreClass()">
                      {{ healthScore()!.healthStatus === 'Healthy' ? 'Saud√°vel' :
                         healthScore()!.healthStatus === 'NeedsAttention' ? 'Precisa Aten√ß√£o' :
                         'Em Risco' }}
                    </span>
                    <small>Calculado em {{ formatDate(healthScore()!.calculatedAt) }}</small>
                  </div>
                </div>

                <div class="health-score-breakdown">
                  <h3>Detalhamento da Pontua√ß√£o</h3>
                  
                  <div class="score-item">
                    <div class="score-item-header">
                      <span class="score-item-label">üíª Frequ√™ncia de Uso</span>
                      <span class="score-item-value">{{ healthScore()!.usageScore }}/30</span>
                    </div>
                    <div class="progress-bar">
                      <div class="progress-fill" [style.width.%]="(healthScore()!.usageScore / 30) * 100"></div>
                    </div>
                    @if (healthScore()!.daysSinceActivity !== undefined) {
                      <small>√öltima atividade h√° {{ healthScore()!.daysSinceActivity }} dias</small>
                    }
                  </div>

                  <div class="score-item">
                    <div class="score-item-header">
                      <span class="score-item-label">üë• Engajamento de Usu√°rios</span>
                      <span class="score-item-value">{{ healthScore()!.userEngagementScore }}/25</span>
                    </div>
                    <div class="progress-bar">
                      <div class="progress-fill" [style.width.%]="(healthScore()!.userEngagementScore / 25) * 100"></div>
                    </div>
                    @if (healthScore()!.activeUsersPercentage !== undefined) {
                      <small>{{ healthScore()!.activeUsersPercentage }}% de usu√°rios ativos</small>
                    }
                  </div>

                  <div class="score-item">
                    <div class="score-item-header">
                      <span class="score-item-label">üé´ Suporte</span>
                      <span class="score-item-value">{{ healthScore()!.supportScore }}/20</span>
                    </div>
                    <div class="progress-bar">
                      <div class="progress-fill" [style.width.%]="(healthScore()!.supportScore / 20) * 100"></div>
                    </div>
                    @if (healthScore()!.openTicketsCount !== undefined) {
                      <small>{{ healthScore()!.openTicketsCount }} tickets abertos</small>
                    }
                  </div>

                  <div class="score-item">
                    <div class="score-item-header">
                      <span class="score-item-label">üí≥ Pagamentos</span>
                      <span class="score-item-value">{{ healthScore()!.paymentScore }}/25</span>
                    </div>
                    <div class="progress-bar">
                      <div class="progress-fill" [style.width.%]="(healthScore()!.paymentScore / 25) * 100"></div>
                    </div>
                    <small>{{ healthScore()!.hasPaymentIssues ? 'Problemas detectados' : 'Pagamentos em dia' }}</small>
                  </div>
                </div>
              </div>
            </div>
          }

          <!-- Timeline Tab -->
          @if (activeTab() === 'timeline') {
            <div class="card">
              <div class="card-header">
                <h2>üìÖ Timeline de Eventos</h2>
              </div>

              @if (timeline().length > 0) {
                <div class="timeline">
                  @for (event of timeline(); track event.date) {
                    <div class="timeline-item">
                      <div class="timeline-icon">{{ getTimelineIcon(event.type) }}</div>
                      <div class="timeline-content">
                        <div class="timeline-header">
                          <strong>{{ event.title }}</strong>
                          <span class="timeline-date">{{ formatDate(event.date) }}</span>
                        </div>
                        <div class="timeline-description">{{ event.description }}</div>
                      </div>
                    </div>
                  }
                </div>
              } @else {
                <div class="empty-state">
                  <p>Nenhum evento registrado ainda</p>
                </div>
              }
            </div>
          }

          <!-- Metrics Tab -->
          @if (activeTab() === 'metrics' && usageMetrics()) {
            <div class="card">
              <div class="card-header">
                <h2>üìä M√©tricas de Uso</h2>
              </div>

              <div class="metrics-grid">
                <div class="metric-item">
                  <span class="metric-icon">üîê</span>
                  <div class="metric-content">
                    <span class="metric-label">Total de Logins</span>
                    <span class="metric-value">{{ usageMetrics()!.totalLogins }}</span>
                  </div>
                </div>

                <div class="metric-item">
                  <span class="metric-icon">üë§</span>
                  <div class="metric-content">
                    <span class="metric-label">Usu√°rios √önicos Ativos</span>
                    <span class="metric-value">{{ usageMetrics()!.uniqueActiveUsers }}</span>
                  </div>
                </div>

                <div class="metric-item">
                  <span class="metric-icon">üìÖ</span>
                  <div class="metric-content">
                    <span class="metric-label">Total de Agendamentos</span>
                    <span class="metric-value">{{ usageMetrics()!.totalAppointments }}</span>
                  </div>
                </div>

                <div class="metric-item">
                  <span class="metric-icon">üìã</span>
                  <div class="metric-content">
                    <span class="metric-label">Registros de Pacientes</span>
                    <span class="metric-value">{{ usageMetrics()!.totalPatientRecords }}</span>
                  </div>
                </div>

                <div class="metric-item">
                  <span class="metric-icon">üìÑ</span>
                  <div class="metric-content">
                    <span class="metric-label">Documentos Gerados</span>
                    <span class="metric-value">{{ usageMetrics()!.totalDocuments }}</span>
                  </div>
                </div>

                <div class="metric-item">
                  <span class="metric-icon">‚è±Ô∏è</span>
                  <div class="metric-content">
                    <span class="metric-label">Dura√ß√£o M√©dia de Sess√£o</span>
                    <span class="metric-value">{{ usageMetrics()!.averageSessionDuration }} min</span>
                  </div>
                </div>
              </div>

              <div class="metric-period">
                <small>Per√≠odo: {{ formatDate(usageMetrics()!.periodStart) }} - {{ formatDate(usageMetrics()!.periodEnd) }}</small>
              </div>
            </div>
          }

          <!-- Tags Tab -->
          @if (activeTab() === 'tags') {
            <div class="card">
              <div class="card-header">
                <h2>üè∑Ô∏è Gest√£o de Tags</h2>
              </div>

              <!-- Assigned Tags -->
              @if (clinic() && clinic()!.tags && clinic()!.tags.length > 0) {
                <div class="tags-section">
                  <h3>Tags Atribu√≠das</h3>
                  <div class="tags-container">
                    @for (tag of clinic()!.tags; track tag.id) {
                      <div class="tag-badge" [style.background-color]="tag.color">
                        <span>{{ tag.name }}</span>
                        @if (tag.isAutomatic) {
                          <span class="tag-auto-indicator" title="Tag autom√°tica">ü§ñ</span>
                        }
                        @if (!tag.isAutomatic) {
                          <button class="tag-remove" (click)="removeTag(tag.id)" title="Remover tag">‚úï</button>
                        }
                      </div>
                    }
                  </div>
                </div>
              } @else {
                <div class="empty-state">
                  <p>Nenhuma tag atribu√≠da ainda</p>
                </div>
              }

              <!-- Available Tags -->
              @if (availableTags().length > 0) {
                <div class="tags-section">
                  <h3>Tags Dispon√≠veis</h3>
                  <div class="tags-container">
                    @for (tag of availableTags(); track tag.id) {
                      @if (!clinic()!.tags || !clinic()!.tags.find(t => t.id === tag.id)) {
                        <div class="tag-badge clickable" [style.background-color]="tag.color" (click)="assignTag(tag.id)">
                          <span>{{ tag.name }}</span>
                          @if (tag.description) {
                            <span class="tag-description" [title]="tag.description">‚ÑπÔ∏è</span>
                          }
                        </div>
                      }
                    }
                  </div>
                </div>
              }
            </div>
          }
        </div>

        <!-- Manual Override Modal -->
        @if (showManualOverrideModal) {
          <div class="modal-overlay" (click)="showManualOverrideModal = false">
            <div class="modal" (click)="$event.stopPropagation()">
              <div class="modal-header">
                <h2>Ativar Override Manual</h2>
                <button class="btn-close" (click)="showManualOverrideModal = false">‚úï</button>
              </div>
              
              <div class="modal-body">
                <p>O override manual permite estender o acesso da cl√≠nica mesmo ap√≥s o vencimento do trial ou falta de pagamento.</p>
                
                <div class="form-group">
                  <label>Motivo *</label>
                  <textarea
                    [(ngModel)]="overrideReason"
                    placeholder="Ex: Cliente solicitou extens√£o para teste..."
                    rows="3"
                  ></textarea>
                </div>

                <div class="form-group">
                  <label>Estender at√© (opcional)</label>
                  <input
                    type="date"
                    [(ngModel)]="overrideExtendUntil"
                  />
                  <small>Deixe em branco para acesso indefinido</small>
                </div>

                @if (overrideError()) {
                  <div class="error-message">{{ overrideError() }}</div>
                }
              </div>

              <div class="modal-footer">
                <button class="btn btn-secondary" (click)="showManualOverrideModal = false">
                  Cancelar
                </button>
                <button class="btn btn-primary" (click)="activateManualOverride()" [disabled]="!overrideReason || overrideProcessing()">
                  @if (overrideProcessing()) {
                    <span>Ativando...</span>
                  } @else {
                    <span>Ativar Override</span>
                  }
                </button>
              </div>
            </div>
          </div>
        }

        <!-- Change Plan Modal -->
        @if (showChangePlanModal) {
          <div class="modal-overlay" (click)="showChangePlanModal = false">
            <div class="modal" (click)="$event.stopPropagation()">
              <div class="modal-header">
                <h2>Alterar Plano</h2>
                <button class="btn-close" (click)="showChangePlanModal = false">‚úï</button>
              </div>
              
              <div class="modal-body">
                <div class="form-group">
                  <label>Novo Plano *</label>
                  <select [(ngModel)]="newPlanId">
                    <option value="">Selecione um plano</option>
                    @for (plan of availablePlans(); track plan.id) {
                      <option [value]="plan.id">
                        {{ plan.name }} - R$ {{ plan.monthlyPrice.toFixed(2) }}/m√™s
                      </option>
                    }
                  </select>
                </div>

                @if (changePlanError()) {
                  <div class="error-message">{{ changePlanError() }}</div>
                }
              </div>

              <div class="modal-footer">
                <button class="btn btn-secondary" (click)="showChangePlanModal = false">
                  Cancelar
                </button>
                <button class="btn btn-primary" (click)="changePlan()" [disabled]="!newPlanId || changePlanProcessing()">
                  @if (changePlanProcessing()) {
                    <span>Alterando...</span>
                  } @else {
                    <span>Alterar Plano</span>
                  }
                </button>
              </div>
            </div>
          </div>
        }
      }
    </div>
