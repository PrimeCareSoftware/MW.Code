<div class="fiscal-dashboard-container">
  
  
  <div class="page-header">
    <div class="header-content">
      <h1>Dashboard Fiscal - NF-e/NFS-e</h1>
      <p>Acompanhamento de Notas Fiscais Eletrônicas</p>
    </div>
    <div class="header-actions">
      <button class="btn btn-secondary" (click)="exportToExcel()">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
        </svg>
        Excel
      </button>
      <button class="btn btn-primary" (click)="exportToPDF()">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
        </svg>
        PDF
      </button>
    </div>
  </div>

  <!-- Filters -->
  <div class="form-section">
    <div class="section-header">
      <div class="section-icon">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
        </svg>
      </div>
      <div>
        <h3>Filtros</h3>
        <p>Selecione o período e tipo de nota para análise</p>
      </div>
    </div>

    <div class="form-grid">
      <div class="form-group">
        <label for="selectedMonth">Mês</label>
        <select 
          id="selectedMonth"
          class="form-control" 
          [(ngModel)]="selectedMonth"
          (change)="onMonthChange()"
        >
          <option [value]="1">Janeiro</option>
          <option [value]="2">Fevereiro</option>
          <option [value]="3">Março</option>
          <option [value]="4">Abril</option>
          <option [value]="5">Maio</option>
          <option [value]="6">Junho</option>
          <option [value]="7">Julho</option>
          <option [value]="8">Agosto</option>
          <option [value]="9">Setembro</option>
          <option [value]="10">Outubro</option>
          <option [value]="11">Novembro</option>
          <option [value]="12">Dezembro</option>
        </select>
      </div>
      <div class="form-group">
        <label for="selectedYear">Ano</label>
        <select 
          id="selectedYear"
          class="form-control" 
          [(ngModel)]="selectedYear"
          (change)="onYearChange()"
        >
          @for (year of generateYears(); track year) {
            <option [value]="year">{{ year }}</option>
          }
        </select>
      </div>
      <div class="form-group">
        <label for="invoiceTypeFilter">Tipo de Nota</label>
        <select 
          id="invoiceTypeFilter"
          class="form-control" 
          [(ngModel)]="invoiceTypeFilter"
          (change)="onInvoiceTypeFilterChange()"
        >
          <option value="all">Todos</option>
          <option value="NFSe">NFS-e</option>
          <option value="NFe">NF-e</option>
          <option value="NFCe">NFC-e</option>
        </select>
      </div>
      <div class="form-group">
        <label for="trendMonths">Período de Evolução</label>
        <select 
          id="trendMonths"
          class="form-control" 
          [(ngModel)]="trendMonths"
          (change)="onTrendMonthsChange()"
        >
          <option [value]="6">6 meses</option>
          <option [value]="12">12 meses</option>
          <option [value]="18">18 meses</option>
          <option [value]="24">24 meses</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  @if (isLoading()) {
    <div class="loading-state">
      <div class="spinner"></div>
      <p>Carregando dados fiscais...</p>
    </div>
  }

  <!-- Error Message -->
  @if (errorMessage()) {
    <div class="alert alert-error">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
      <span>{{ errorMessage() }}</span>
    </div>
  }

  <!-- Dashboard Content -->
  @if (!isLoading()) {
    
    <!-- Alerts Section -->
    @if (alerts().length > 0) {
      <div class="alerts-section">
        @for (alert of alerts(); track alert.id) {
          <div class="alert" [ngClass]="getAlertClass(alert.type)">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
            <span>{{ alert.message }}</span>
          </div>
        }
      </div>
    }

    <!-- Summary Cards -->
    <div class="summary-section">
      <div class="section-header">
        <div class="section-icon">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
          </svg>
        </div>
        <div>
          <h3>Resumo Mensal</h3>
          <p>{{ getMonthName(selectedMonth()) }}/{{ selectedYear() }}</p>
        </div>
      </div>

      <div class="summary-grid">
        <div class="summary-card">
          <h6>Total Emitido no Mês</h6>
          <h3 class="text-primary">{{ formatCurrency(totalIssuedMonth()) }}</h3>
          <small>Todas as notas</small>
        </div>
        <div class="summary-card">
          <h6>Total de Impostos</h6>
          <h3 class="text-danger">{{ formatCurrency(totalTaxesPaid()) }}</h3>
          <small>Carga tributária: {{ formatPercentage(taxEffectiveRate()) }}</small>
        </div>
        <div class="summary-card">
          <h6>Total de Notas</h6>
          <h3 class="text-success">{{ formatNumber(totalInvoices()) }}</h3>
          <small>Todas as categorias</small>
        </div>
        <div class="summary-card">
          <h6>Ticket Médio</h6>
          <h3 class="text-info">{{ formatCurrency(averageInvoiceValue()) }}</h3>
          <small>Por nota emitida</small>
        </div>
      </div>
    </div>

    <!-- Invoice Status -->
    <div class="status-section">
      <div class="section-header">
        <div class="section-icon">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        </div>
        <div>
          <h3>Status das Notas</h3>
          <p>Distribuição por status de autorização</p>
        </div>
      </div>

      <div class="status-grid">
        <div class="status-card status-success">
          <div class="status-icon">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
          </div>
          <div class="status-info">
            <h4>{{ invoiceStatus().authorized }}</h4>
            <span>Autorizadas</span>
          </div>
        </div>
        <div class="status-card status-warning">
          <div class="status-icon">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
          </div>
          <div class="status-info">
            <h4>{{ invoiceStatus().cancelled }}</h4>
            <span>Canceladas</span>
          </div>
        </div>
        <div class="status-card status-error">
          <div class="status-icon">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
          </div>
          <div class="status-info">
            <h4>{{ invoiceStatus().error }}</h4>
            <span>Com Erro</span>
          </div>
        </div>
        <div class="status-card status-info">
          <div class="status-icon">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
          </div>
          <div class="status-info">
            <h4>{{ invoiceStatus().pending }}</h4>
            <span>Pendentes</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Two column layout -->
    <div class="two-column-layout">
      <!-- Left Column -->
      <div class="left-column">
        
        <!-- Invoice by Type -->
        <div class="invoice-types-section">
          <div class="section-header">
            <div class="section-icon">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
              </svg>
            </div>
            <div>
              <h3>Notas por Tipo</h3>
            </div>
          </div>

          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Tipo</th>
                  <th class="text-end">Quantidade</th>
                  <th class="text-end">Valor Total</th>
                </tr>
              </thead>
              <tbody>
                @for (item of invoicesByType(); track item.type) {
                  <tr>
                    <td><strong>{{ item.type }}</strong></td>
                    <td class="text-end">{{ formatNumber(item.quantity) }}</td>
                    <td class="text-end">{{ formatCurrency(item.totalValue) }}</td>
                  </tr>
                }
                @if (invoicesByType().length === 0) {
                  <tr>
                    <td colspan="3" class="text-center text-muted">
                      Nenhuma nota emitida no período
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        </div>

        <!-- Tax Breakdown -->
        <div class="tax-breakdown-section">
          <div class="section-header">
            <div class="section-icon">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
            </div>
            <div>
              <h3>Breakdown de Impostos</h3>
            </div>
          </div>

          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Imposto</th>
                  <th class="text-end">Alíquota</th>
                  <th class="text-end">Valor</th>
                </tr>
              </thead>
              <tbody>
                @for (tax of taxBreakdown(); track tax.taxType) {
                  <tr>
                    <td><strong>{{ tax.taxType }}</strong></td>
                    <td class="text-end">{{ formatPercentage(tax.percentage) }}</td>
                    <td class="text-end">{{ formatCurrency(tax.amount) }}</td>
                  </tr>
                }
              </tbody>
              <tfoot>
                <tr>
                  <td colspan="2"><strong>Total</strong></td>
                  <td class="text-end"><strong>{{ formatCurrency(totalTaxesPaid()) }}</strong></td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>

      </div>

      <!-- Right Column -->
      <div class="right-column">
        
        <!-- Top Clients -->
        <div class="top-clients-section">
          <div class="section-header">
            <div class="section-icon">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
              </svg>
            </div>
            <div>
              <h3>Top 5 Clientes</h3>
            </div>
          </div>

          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Cliente</th>
                  <th class="text-center">Notas</th>
                  <th class="text-end">Faturamento</th>
                </tr>
              </thead>
              <tbody>
                @for (client of topClients(); track client.clientId; let index = $index) {
                  <tr>
                    <td>
                      <div class="client-rank">
                        <span class="rank-badge">{{ index + 1 }}º</span>
                        <span>{{ client.clientName }}</span>
                      </div>
                    </td>
                    <td class="text-center">
                      <span class="badge badge-default">{{ client.invoiceCount }}</span>
                    </td>
                    <td class="text-end">
                      <strong>{{ formatCurrency(client.totalBilled) }}</strong>
                    </td>
                  </tr>
                }
                @if (topClients().length === 0) {
                  <tr>
                    <td colspan="3" class="text-center text-muted">
                      Nenhum cliente encontrado
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        </div>

        <!-- Monthly Trend -->
        <div class="monthly-trend-section">
          <div class="section-header">
            <div class="section-icon">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z" />
              </svg>
            </div>
            <div>
              <h3>Evolução Mensal</h3>
            </div>
          </div>

          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Período</th>
                  <th class="text-center">Notas</th>
                  <th class="text-end">Total</th>
                </tr>
              </thead>
              <tbody>
                @for (trend of monthlyTrend(); track trend.month + trend.year) {
                  <tr>
                    <td>{{ trend.month }}/{{ trend.year }}</td>
                    <td class="text-center">{{ formatNumber(trend.invoiceCount) }}</td>
                    <td class="text-end">{{ formatCurrency(trend.totalIssued) }}</td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        </div>

      </div>
    </div>

  }
</div>
