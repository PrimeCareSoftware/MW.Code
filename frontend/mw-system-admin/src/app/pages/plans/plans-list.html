<app-navbar></app-navbar>

<div class="plans-list">
      <div class="header">
        <div>
          <h1>Gerenciar Planos de Assinatura</h1>
          <p class="subtitle">Configure os planos dispon√≠veis para as cl√≠nicas</p>
        </div>
        <button class="btn btn-primary" (click)="openCreateModal()">
          <span>‚ûï Novo Plano</span>
        </button>
      </div>

      @if (loading()) {
        <div class="loading">Carregando planos...</div>
      } @else if (error()) {
        <div class="error">
          <p>Erro: {{ error() }}</p>
          <button (click)="loadPlans()" class="btn-retry">Tentar novamente</button>
        </div>
      } @else {
        <div class="table-container">
          <table class="plans-table">
            <thead>
              <tr>
                <th>Plano</th>
                <th>Pre√ßo Mensal</th>
                <th>Pre√ßo Anual</th>
                <th>Campanha</th>
                <th>Trial (dias)</th>
                <th>Max Usu√°rios</th>
                <th>Max Pacientes</th>
                <th>Status</th>
                <th>A√ß√µes</th>
              </tr>
            </thead>
            <tbody>
              @for (plan of plans(); track plan.id) {
                <tr>
                  <td>
                    <div class="plan-info">
                      <div class="plan-name">{{ plan.name }}</div>
                      @if (plan.description) {
                        <div class="plan-desc">{{ plan.description }}</div>
                      }
                    </div>
                  </td>
                  <td>{{ formatCurrency(plan.monthlyPrice) }}</td>
                  <td>{{ formatCurrency(plan.yearlyPrice) }}</td>
                  <td>
                    @if (plan.campaignName) {
                      <div class="campaign-info">
                        <div class="campaign-badge">üéØ {{ plan.campaignName }}</div>
                        @if (plan.campaignPrice) {
                          <div class="campaign-price">{{ formatCurrency(plan.campaignPrice!) }}</div>
                        }
                        @if (plan.currentEarlyAdopters !== undefined && plan.maxEarlyAdopters) {
                          <div class="campaign-slots">{{ plan.currentEarlyAdopters }}/{{ plan.maxEarlyAdopters }} vagas</div>
                        }
                      </div>
                    } @else {
                      <span class="no-campaign">‚Äî</span>
                    }
                  </td>
                  <td>{{ plan.trialDays }} dias</td>
                  <td>{{ plan.maxUsers }}</td>
                  <td>{{ plan.maxPatients }}</td>
                  <td>
                    <span class="status-badge" [class.active]="plan.isActive" [class.inactive]="!plan.isActive">
                      {{ plan.isActive ? '‚úÖ Ativo' : 'üö´ Inativo' }}
                    </span>
                  </td>
                  <td>
                    <div class="actions">
                      <button class="btn-icon" (click)="openEditModal(plan)" title="Editar">
                        ‚úèÔ∏è
                      </button>
                      <button 
                        class="btn-icon" 
                        [class.btn-danger]="plan.isActive"
                        [class.btn-success]="!plan.isActive"
                        (click)="toggleStatus(plan.id, plan.isActive)" 
                        [title]="plan.isActive ? 'Desativar' : 'Ativar'"
                      >
                        {{ plan.isActive ? 'üö´' : '‚úÖ' }}
                      </button>
                      <button class="btn-icon btn-danger" (click)="deletePlan(plan.id)" title="Excluir">
                        üóëÔ∏è
                      </button>
                    </div>
                  </td>
                </tr>
              }
            </tbody>
          </table>

          @if (plans().length === 0) {
            <div class="empty-state">
              <p>Nenhum plano cadastrado</p>
            </div>
          }
        </div>
      }

      <!-- Create/Edit Modal -->
      @if (showModal) {
        <div class="modal-overlay" (click)="closeModal()">
          <div class="modal" (click)="$event.stopPropagation()">
            <div class="modal-header">
              <h2>{{ editingPlan ? 'Editar Plano' : 'Criar Novo Plano' }}</h2>
              <button class="btn-close" (click)="closeModal()">‚úï</button>
            </div>
            
            <form (ngSubmit)="onSubmit()" class="modal-body">
              <div class="form-group">
                <label>Nome do Plano *</label>
                <input
                  type="text"
                  [(ngModel)]="formData.name"
                  name="name"
                  required
                  placeholder="Ex: Plano B√°sico"
                />
              </div>

              <div class="form-group">
                <label>Descri√ß√£o</label>
                <textarea
                  [(ngModel)]="formData.description"
                  name="description"
                  rows="3"
                  placeholder="Descri√ß√£o opcional do plano"
                ></textarea>
              </div>

              <div class="form-grid">
                <div class="form-group">
                  <label>Pre√ßo Mensal (R$) *</label>
                  <input
                    type="number"
                    [(ngModel)]="formData.monthlyPrice"
                    name="monthlyPrice"
                    required
                    min="0"
                    step="0.01"
                    placeholder="0.00"
                  />
                </div>

                <div class="form-group">
                  <label>Pre√ßo Anual (R$) *</label>
                  <input
                    type="number"
                    [(ngModel)]="formData.yearlyPrice"
                    name="yearlyPrice"
                    required
                    min="0"
                    step="0.01"
                    placeholder="0.00"
                  />
                </div>

                <div class="form-group">
                  <label>Dias de Trial *</label>
                  <input
                    type="number"
                    [(ngModel)]="formData.trialDays"
                    name="trialDays"
                    required
                    min="0"
                    placeholder="14"
                  />
                </div>

                <div class="form-group">
                  <label>Max Usu√°rios *</label>
                  <input
                    type="number"
                    [(ngModel)]="formData.maxUsers"
                    name="maxUsers"
                    required
                    min="1"
                    placeholder="10"
                  />
                </div>

                <div class="form-group">
                  <label>Max Pacientes *</label>
                  <input
                    type="number"
                    [(ngModel)]="formData.maxPatients"
                    name="maxPatients"
                    required
                    min="1"
                    placeholder="100"
                  />
                </div>

                @if (editingPlan) {
                  <div class="form-group">
                    <label>Status</label>
                    <select [(ngModel)]="formDataUpdate.isActive" name="isActive">
                      <option [value]="true">Ativo</option>
                      <option [value]="false">Inativo</option>
                    </select>
                  </div>
                }
              </div>
              
              <!-- Campaign Section -->
              <div class="campaign-section">
                <h3 class="section-title">üéØ Dados de Campanha (Opcional)</h3>
                
                <div class="form-group">
                  <label>Nome da Campanha</label>
                  <input
                    type="text"
                    [(ngModel)]="activeFormData.campaignName"
                    name="campaignName"
                    placeholder="Ex: MVP Early Adopter"
                  />
                </div>

                <div class="form-group">
                  <label>Descri√ß√£o da Campanha</label>
                  <textarea
                    [(ngModel)]="activeFormData.campaignDescription"
                    name="campaignDescription"
                    rows="2"
                    placeholder="Ex: Seja um dos primeiros clientes e garanta pre√ßo especial vital√≠cio"
                  ></textarea>
                </div>

                <div class="form-grid">
                  <div class="form-group">
                    <label>Pre√ßo Original/Futuro (R$)</label>
                    <input
                      type="number"
                      [(ngModel)]="activeFormData.originalPrice"
                      name="originalPrice"
                      min="0"
                      step="0.01"
                      placeholder="0.00"
                    />
                  </div>

                  <div class="form-group">
                    <label>Pre√ßo Promocional (R$)</label>
                    <input
                      type="number"
                      [(ngModel)]="activeFormData.campaignPrice"
                      name="campaignPrice"
                      min="0"
                      step="0.01"
                      placeholder="0.00"
                    />
                  </div>

                  <div class="form-group">
                    <label>Data In√≠cio</label>
                    <input
                      type="date"
                      [(ngModel)]="activeFormData.campaignStartDate"
                      name="campaignStartDate"
                    />
                  </div>

                  <div class="form-group">
                    <label>Data Fim (vazio = vital√≠cio)</label>
                    <input
                      type="date"
                      [(ngModel)]="activeFormData.campaignEndDate"
                      name="campaignEndDate"
                    />
                  </div>

                  <div class="form-group">
                    <label>Max Early Adopters</label>
                    <input
                      type="number"
                      [(ngModel)]="activeFormData.maxEarlyAdopters"
                      name="maxEarlyAdopters"
                      min="0"
                      placeholder="100"
                    />
                  </div>
                </div>

                <!-- Early Adopter Benefits -->
                <div class="form-group array-field">
                  <label>üéÅ Benef√≠cios Early Adopter</label>
                  <div class="array-input">
                    <input
                      type="text"
                      [(ngModel)]="newBenefit"
                      name="newBenefit"
                      placeholder="Ex: Pre√ßo vital√≠cio de R$ 49/m√™s (67% OFF)"
                      (keyup.enter)="addBenefit()"
                    />
                    <button type="button" class="btn-add" (click)="addBenefit()">‚ûï Adicionar</button>
                  </div>
                  <ul class="array-list">
                    @for (benefit of activeFormData.earlyAdopterBenefits; track $index) {
                      <li>
                        <span>‚≠ê {{ benefit }}</span>
                        <button type="button" class="btn-remove" (click)="removeBenefit($index)">‚úï</button>
                      </li>
                    }
                  </ul>
                </div>

                <!-- Features Available -->
                <div class="form-group array-field">
                  <label>‚úÖ Recursos Dispon√≠veis</label>
                  <div class="array-input">
                    <input
                      type="text"
                      [(ngModel)]="newFeatureAvailable"
                      name="newFeatureAvailable"
                      placeholder="Ex: At√© 2 usu√°rios"
                      (keyup.enter)="addFeatureAvailable()"
                    />
                    <button type="button" class="btn-add" (click)="addFeatureAvailable()">‚ûï Adicionar</button>
                  </div>
                  <ul class="array-list">
                    @for (feature of activeFormData.featuresAvailable; track $index) {
                      <li>
                        <span>‚úì {{ feature }}</span>
                        <button type="button" class="btn-remove" (click)="removeFeatureAvailable($index)">‚úï</button>
                      </li>
                    }
                  </ul>
                </div>

                <!-- Features In Development -->
                <div class="form-group array-field">
                  <label>üîÑ Recursos em Desenvolvimento</label>
                  <div class="array-input">
                    <input
                      type="text"
                      [(ngModel)]="newFeatureInDevelopment"
                      name="newFeatureInDevelopment"
                      placeholder="Ex: Assinatura digital (ICP-Brasil)"
                      (keyup.enter)="addFeatureInDevelopment()"
                    />
                    <button type="button" class="btn-add" (click)="addFeatureInDevelopment()">‚ûï Adicionar</button>
                  </div>
                  <ul class="array-list">
                    @for (feature of activeFormData.featuresInDevelopment; track $index) {
                      <li>
                        <span>‚è≥ {{ feature }}</span>
                        <button type="button" class="btn-remove" (click)="removeFeatureInDevelopment($index)">‚úï</button>
                      </li>
                    }
                  </ul>
                </div>
              </div>

              @if (modalError()) {
                <div class="error-message">{{ modalError() }}</div>
              }
            </form>

            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" (click)="closeModal()">
                Cancelar
              </button>
              <button type="button" class="btn btn-primary" (click)="onSubmit()" [disabled]="submitting()">
                @if (submitting()) {
                  <span>Salvando...</span>
                } @else {
                  <span>{{ editingPlan ? 'Salvar' : 'Criar' }}</span>
                }
              </button>
            </div>
          </div>
        </div>
      }
    </div>
