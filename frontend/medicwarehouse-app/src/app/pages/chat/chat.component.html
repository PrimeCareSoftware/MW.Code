<app-navbar></app-navbar>
<div class="chat-container">
  <!-- Sidebar with conversations list -->
  <div class="chat-sidebar">
    <div class="sidebar-header">
      <h2>Conversas</h2>
      <button class="btn-icon" (click)="toggleUserList()" title="Nova conversa">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
          <circle cx="9" cy="7" r="4"/>
          <line x1="19" y1="8" x2="19" y2="14"/>
          <line x1="22" y1="11" x2="16" y2="11"/>
        </svg>
      </button>
    </div>

    <!-- Connection status -->
    @if (!isConnected()) {
      <div class="connection-status offline">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"/>
          <line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/>
        </svg>
        <span>Desconectado - Tentando reconectar...</span>
      </div>
    }

    <!-- Conversations list -->
    <div class="conversations-list">
      @if (isLoadingConversations()) {
        <div class="loading">
          <div class="spinner"></div>
          <p>Carregando conversas...</p>
        </div>
      } @else if (sortedConversations().length === 0) {
        <div class="empty-state">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
          </svg>
          <h3>Nenhuma conversa ainda</h3>
          <p>Clique no botão <strong>+</strong> acima para iniciar uma nova conversa com um usuário da clínica</p>
          <button class="btn-primary" (click)="toggleUserList()">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
              <circle cx="9" cy="7" r="4"/>
              <line x1="19" y1="8" x2="19" y2="14"/>
              <line x1="22" y1="11" x2="16" y2="11"/>
            </svg>
            Iniciar Nova Conversa
          </button>
        </div>
      } @else {
        @for (conversation of sortedConversations(); track conversation.id) {
          <div 
            class="conversation-item"
            [class.active]="selectedConversation()?.id === conversation.id"
            [class.unread]="conversation.unreadCount > 0"
            (click)="selectConversation(conversation)">
            <div class="conversation-avatar">
              {{ getConversationTitle(conversation).charAt(0).toUpperCase() }}
            </div>
            <div class="conversation-info">
              <div class="conversation-header">
                <h3>{{ getConversationTitle(conversation) }}</h3>
                <span class="time">{{ formatTime(conversation.lastMessageAt || conversation.createdAt) }}</span>
              </div>
              <div class="conversation-preview">
                <p>{{ getLastMessagePreview(conversation) }}</p>
                @if (conversation.unreadCount > 0) {
                  <span class="unread-badge">{{ conversation.unreadCount }}</span>
                }
              </div>
            </div>
          </div>
        }
      }
    </div>
  </div>

  <!-- Main chat area -->
  <div class="chat-main">
    @if (!selectedConversation()) {
      <div class="no-conversation">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
          <polyline points="10 9 9 9 8 9"/>
        </svg>
        <h3>Selecione uma conversa</h3>
        <p>Escolha uma conversa na lista ou inicie uma nova</p>
      </div>
    } @else {
      <!-- Chat header -->
      <div class="chat-header">
        <div class="chat-header-info">
          <div class="chat-avatar">
            {{ getConversationTitle(selectedConversation()!).charAt(0).toUpperCase() }}
          </div>
          <div class="chat-title">
            <h2>{{ getConversationTitle(selectedConversation()!) }}</h2>
            @if (typingUsers().size > 0) {
              <p class="typing-indicator">digitando...</p>
            }
          </div>
        </div>
      </div>

      <!-- Messages container -->
      <div class="messages-container" #messagesContainer>
        @if (isLoadingMessages()) {
          <div class="loading">
            <div class="spinner"></div>
            <p>Carregando mensagens...</p>
          </div>
        } @else if (messages().length === 0) {
          <div class="empty-messages">
            <p>Nenhuma mensagem ainda. Envie a primeira!</p>
          </div>
        } @else {
          @for (message of messages(); track message.id) {
            <div 
              class="message"
              [class.own]="isOwnMessage(message)"
              [class.deleted]="message.isDeleted">
              @if (!isOwnMessage(message)) {
                <div class="message-avatar">
                  {{ message.senderName.charAt(0).toUpperCase() }}
                </div>
              }
              <div class="message-content">
                @if (!isOwnMessage(message)) {
                  <div class="message-sender">{{ message.senderName }}</div>
                }
                <div class="message-bubble">
                  @if (message.isDeleted) {
                    <em>Mensagem excluída</em>
                  } @else {
                    {{ message.content }}
                  }
                </div>
                <div class="message-meta">
                  <span class="message-time">{{ formatTime(message.sentAt) }}</span>
                  @if (message.isEdited) {
                    <span class="edited">(editada)</span>
                  }
                  @if (isOwnMessage(message) && message.readBy.length > 1) {
                    <svg class="read-indicator" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <polyline points="20 6 9 17 4 12"/>
                      <polyline points="16 6 5 17"/>
                    </svg>
                  }
                </div>
              </div>
            </div>
          }
        }
      </div>

      <!-- Message input -->
      <div class="message-input-container">
        <form (submit)="sendMessage(); $event.preventDefault()">
          <input
            type="text"
            [(ngModel)]="messageInput"
            (input)="onTyping()"
            placeholder="Digite sua mensagem..."
            class="message-input"
            name="messageInput"
            [disabled]="!isConnected()"
          />
          <button 
            type="submit" 
            class="btn-send"
            [disabled]="!messageInput.trim() || !isConnected()">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="22" y1="2" x2="11" y2="13"/>
              <polygon points="22 2 15 22 11 13 2 9 22 2"/>
            </svg>
          </button>
        </form>
      </div>
    }
  </div>

  <!-- User list panel (for starting new conversations) -->
  @if (showUserList) {
    <div class="user-list-overlay" (click)="toggleUserList()">
      <div class="user-list-panel" (click)="$event.stopPropagation()">
        <div class="panel-header">
          <div class="header-content">
            <h3>Usuários da Clínica</h3>
            <p class="subtitle">Selecione um usuário para iniciar uma conversa</p>
          </div>
          <button class="btn-close" (click)="toggleUserList()">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"/>
              <line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
          </button>
        </div>
        
        <div class="search-box">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"/>
            <path d="m21 21-4.35-4.35"/>
          </svg>
          <input 
            type="text" 
            [(ngModel)]="searchQuery"
            placeholder="Buscar usuário..."
            class="search-input"
          />
        </div>

        <div class="users-list">
          @for (user of filteredUsers(); track user.userId) {
            <div class="user-item" (click)="startConversation(user)">
              <div class="user-avatar">
                <span class="avatar-text">{{ user.fullName.charAt(0).toUpperCase() }}</span>
                <span class="presence-indicator" [class]="getPresenceClass(user)"></span>
              </div>
              <div class="user-info">
                <h4>{{ user.fullName }}</h4>
                <p class="user-status">{{ user.userName }}</p>
              </div>
            </div>
          }
        </div>
      </div>
    </div>
  }
</div>
