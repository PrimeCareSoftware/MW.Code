<div class="reports-container">
  <app-navbar></app-navbar>
  
  <div class="content">
    <div class="header-section">
      <h1>Relatórios TISS</h1>
      <div class="export-buttons">
        <button 
          class="btn btn-outline-danger" 
          (click)="exportToPDF()"
          [disabled]="!hasReportData() || isLoading()"
        >
          <i class="bi bi-file-pdf"></i> Exportar PDF
        </button>
        <button 
          class="btn btn-outline-success" 
          (click)="exportToExcel()"
          [disabled]="!hasReportData() || isLoading()"
        >
          <i class="bi bi-file-earmark-excel"></i> Exportar Excel
        </button>
      </div>
    </div>

    <!-- Filters Section -->
    <div class="filters-section card">
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-3 col-sm-6">
            <label for="reportType" class="form-label">Tipo de Relatório *</label>
            <select 
              id="reportType"
              class="form-select" 
              [(ngModel)]="selectedReportType"
              (change)="onReportTypeChange()"
            >
              @for (type of reportTypes; track type.value) {
                <option [value]="type.value">{{ type.label }}</option>
              }
            </select>
          </div>
          
          <div class="col-md-3 col-sm-6">
            <label for="startDate" class="form-label">Data Inicial *</label>
            <input 
              type="date" 
              id="startDate"
              class="form-control" 
              [(ngModel)]="startDate"
            />
          </div>
          
          <div class="col-md-3 col-sm-6">
            <label for="endDate" class="form-label">Data Final *</label>
            <input 
              type="date" 
              id="endDate"
              class="form-control" 
              [(ngModel)]="endDate"
            />
          </div>
          
          <div class="col-md-3 col-sm-6">
            <label for="operator" class="form-label">Operadora</label>
            <select 
              id="operator"
              class="form-select" 
              [(ngModel)]="selectedOperatorId"
            >
              <option value="all">Todas as Operadoras</option>
              @for (operator of operators(); track operator.id) {
                <option [value]="operator.id">{{ operator.tradeName }}</option>
              }
            </select>
          </div>
        </div>
        
        <div class="row mt-3">
          <div class="col-12">
            <button 
              class="btn btn-primary" 
              (click)="generateReport()"
              [disabled]="isLoading()"
            >
              @if (isLoading()) {
                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                Gerando...
              } @else {
                <i class="bi bi-bar-chart"></i> Gerar Relatório
              }
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Error Message -->
    @if (errorMessage()) {
      <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        {{ errorMessage() }}
        <button type="button" class="btn-close" (click)="errorMessage.set('')"></button>
      </div>
    }

    <!-- Loading State -->
    @if (isLoading()) {
      <div class="text-center my-5">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Carregando...</span>
        </div>
        <p class="mt-3">Gerando relatório...</p>
      </div>
    }

    <!-- Report Preview Section -->
    @if (hasReportData() && !isLoading()) {
      <div class="report-preview-section card">
        <div class="card-header">
          <h3 class="mb-0">
            <i class="bi bi-file-text me-2"></i>
            Prévia: {{ getReportTitle() }}
          </h3>
          <small class="text-muted">
            Período: {{ startDate() }} a {{ endDate() }}
            @if (selectedOperatorId() !== 'all') {
              <span class="ms-2">| Operadora: {{ getSelectedOperatorName() }}</span>
            }
          </small>
        </div>
        <div class="card-body">
          
          <!-- Billing Report -->
          @if (selectedReportType() === 'billing') {
            <div class="table-responsive">
              <table class="table table-hover table-striped">
                <thead>
                  <tr>
                    <th>Operadora</th>
                    <th class="text-end">Total Faturado</th>
                    <th class="text-end">Total Aprovado</th>
                    <th class="text-end">Total Glosado</th>
                    <th class="text-center">Taxa de Glosa</th>
                    <th class="text-center">Guias</th>
                  </tr>
                </thead>
                <tbody>
                  @for (item of billingData(); track item.operatorId) {
                    <tr>
                      <td>{{ item.operatorName }}</td>
                      <td class="text-end">{{ formatCurrency(item.totalBilled) }}</td>
                      <td class="text-end text-success">{{ formatCurrency(item.totalBilled - item.totalGlosed) }}</td>
                      <td class="text-end text-danger">{{ formatCurrency(item.totalGlosed) }}</td>
                      <td class="text-center">
                        <span 
                          class="badge" 
                          [ngClass]="item.glosaPercentage > 15 ? 'bg-danger' : item.glosaPercentage > 10 ? 'bg-warning' : 'bg-success'"
                        >
                          {{ formatPercentage(item.glosaPercentage) }}
                        </span>
                      </td>
                      <td class="text-center">
                        {{ formatNumber(item.totalGuides) }}
                        <small class="text-muted">({{ formatNumber(item.glosedGuides) }} glosadas)</small>
                      </td>
                    </tr>
                  }
                </tbody>
                @if (billingData().length > 1) {
                  <tfoot>
                    <tr class="table-light fw-bold">
                      <td>TOTAL</td>
                      <td class="text-end">
                        {{ formatCurrency(getTotalBilled(billingData())) }}
                      </td>
                      <td class="text-end text-success">
                        {{ formatCurrency(getTotalApproved(billingData())) }}
                      </td>
                      <td class="text-end text-danger">
                        {{ formatCurrency(getTotalGlosed(billingData())) }}
                      </td>
                      <td class="text-center">
                        @if (getTotalBilled(billingData()) > 0) {
                          <span class="badge bg-secondary">
                            {{ formatPercentage((getTotalGlosed(billingData()) / getTotalBilled(billingData())) * 100) }}
                          </span>
                        }
                      </td>
                      <td class="text-center">
                        {{ formatNumber(getTotalGuides(billingData())) }}
                      </td>
                    </tr>
                  </tfoot>
                }
              </table>
            </div>
          }

          <!-- Glosas Report -->
          @if (selectedReportType() === 'glosas') {
            <div class="table-responsive">
              <table class="table table-hover table-striped">
                <thead>
                  <tr>
                    <th>Operadora</th>
                    <th class="text-end">Total Glosado</th>
                    <th class="text-center">Taxa de Glosa</th>
                    <th class="text-center">Guias Glosadas</th>
                    <th class="text-center">Total de Guias</th>
                  </tr>
                </thead>
                <tbody>
                  @for (item of glosasData(); track item.operatorId) {
                    <tr>
                      <td>{{ item.operatorName }}</td>
                      <td class="text-end text-danger">{{ formatCurrency(item.totalGlosed) }}</td>
                      <td class="text-center">
                        <span 
                          class="badge" 
                          [ngClass]="item.glosaPercentage > 15 ? 'bg-danger' : item.glosaPercentage > 10 ? 'bg-warning' : 'bg-success'"
                        >
                          {{ formatPercentage(item.glosaPercentage) }}
                        </span>
                      </td>
                      <td class="text-center">{{ formatNumber(item.glosedGuides) }}</td>
                      <td class="text-center">{{ formatNumber(item.totalGuides) }}</td>
                    </tr>
                  }
                </tbody>
              </table>
            </div>
          }

          <!-- Denials Report -->
          @if (selectedReportType() === 'denials') {
            <div class="table-responsive">
              <table class="table table-hover table-striped">
                <thead>
                  <tr>
                    <th>Operadora</th>
                    <th class="text-center">Total de Solicitações</th>
                    <th class="text-center">Aprovadas</th>
                    <th class="text-center">Negadas</th>
                    <th class="text-center">Pendentes</th>
                    <th class="text-center">Taxa de Aprovação</th>
                  </tr>
                </thead>
                <tbody>
                  @for (item of denialsData(); track item.operatorId) {
                    <tr>
                      <td>{{ item.operatorName }}</td>
                      <td class="text-center">{{ formatNumber(item.totalRequests) }}</td>
                      <td class="text-center text-success">{{ formatNumber(item.approvedRequests) }}</td>
                      <td class="text-center text-danger">{{ formatNumber(item.rejectedRequests) }}</td>
                      <td class="text-center text-warning">{{ formatNumber(item.pendingRequests) }}</td>
                      <td class="text-center">
                        <span 
                          class="badge" 
                          [ngClass]="item.approvalRate >= 80 ? 'bg-success' : item.approvalRate >= 60 ? 'bg-warning' : 'bg-danger'"
                        >
                          {{ formatPercentage(item.approvalRate) }}
                        </span>
                      </td>
                    </tr>
                  }
                </tbody>
              </table>
            </div>
          }

          <!-- Approval Time Report -->
          @if (selectedReportType() === 'approvalTime') {
            <div class="table-responsive">
              <table class="table table-hover table-striped">
                <thead>
                  <tr>
                    <th>Operadora</th>
                    <th class="text-center">Média de Aprovação</th>
                    <th class="text-center">Tempo Mínimo</th>
                    <th class="text-center">Tempo Máximo</th>
                    <th class="text-center">Total Processado</th>
                  </tr>
                </thead>
                <tbody>
                  @for (item of approvalTimeData(); track item.operatorId) {
                    <tr>
                      <td>{{ item.operatorName }}</td>
                      <td class="text-center">
                        <span 
                          class="badge" 
                          [ngClass]="item.averageApprovalDays <= 5 ? 'bg-success' : item.averageApprovalDays <= 10 ? 'bg-warning' : 'bg-danger'"
                        >
                          {{ formatDays(item.averageApprovalDays) }}
                        </span>
                      </td>
                      <td class="text-center">{{ formatDays(item.minApprovalDays) }}</td>
                      <td class="text-center">{{ formatDays(item.maxApprovalDays) }}</td>
                      <td class="text-center">{{ formatNumber(item.totalProcessed) }}</td>
                    </tr>
                  }
                </tbody>
              </table>
            </div>
          }

          <!-- Procedures Report -->
          @if (selectedReportType() === 'procedures') {
            <div class="table-responsive">
              <table class="table table-hover table-striped">
                <thead>
                  <tr>
                    <th>Código</th>
                    <th>Procedimento</th>
                    <th class="text-end">Total Faturado</th>
                    <th class="text-end">Total Glosado</th>
                    <th class="text-center">Taxa de Glosa</th>
                    <th class="text-center">Ocorrências</th>
                  </tr>
                </thead>
                <tbody>
                  @for (item of proceduresData(); track item.procedureCode) {
                    <tr>
                      <td><code>{{ item.procedureCode }}</code></td>
                      <td>{{ item.procedureName }}</td>
                      <td class="text-end">{{ formatCurrency(item.totalBilled) }}</td>
                      <td class="text-end text-danger">{{ formatCurrency(item.totalGlosed) }}</td>
                      <td class="text-center">
                        <span 
                          class="badge" 
                          [ngClass]="item.glosaPercentage > 20 ? 'bg-danger' : item.glosaPercentage > 10 ? 'bg-warning' : 'bg-success'"
                        >
                          {{ formatPercentage(item.glosaPercentage) }}
                        </span>
                      </td>
                      <td class="text-center">
                        {{ formatNumber(item.glosedOccurrences) }} / {{ formatNumber(item.totalOccurrences) }}
                      </td>
                    </tr>
                  }
                </tbody>
              </table>
            </div>
          }
        </div>
      </div>
    }

    <!-- Empty State -->
    @if (!hasReportData() && !isLoading() && !errorMessage()) {
      <div class="empty-state card">
        <div class="card-body text-center py-5">
          <i class="bi bi-file-earmark-bar-graph display-1 text-muted mb-3"></i>
          <h4 class="text-muted">Nenhum relatório gerado</h4>
          <p class="text-muted">
            Selecione os filtros desejados e clique em "Gerar Relatório" para visualizar os dados.
          </p>
        </div>
      </div>
    }
  </div>
</div>
