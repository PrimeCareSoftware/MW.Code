<app-navbar></app-navbar>

<div class="clinic-detail">
      <div class="header">
        <div>
          <button class="btn-back" (click)="goBack()">‚Üê Voltar</button>
          <h1>Detalhes da Cl√≠nica</h1>
        </div>
      </div>

      @if (loading()) {
        <div class="loading">Carregando dados...</div>
      } @else if (error()) {
        <div class="error-message">{{ error() }}</div>
      } @else if (clinic()) {
        <div class="content">
          <!-- Clinic Info Card -->
          <div class="card">
            <div class="card-header">
              <h2>Informa√ß√µes da Cl√≠nica</h2>
              @if (!editMode()) {
                <button class="btn btn-secondary" (click)="toggleEditMode()">
                  ‚úèÔ∏è Editar
                </button>
              }
            </div>

            @if (editMode()) {
              <form (ngSubmit)="saveClinicChanges()" class="edit-form">
                <div class="form-grid">
                  <div class="form-group">
                    <label>Nome</label>
                    <input type="text" [(ngModel)]="editData.name" name="name" required />
                  </div>
                  <div class="form-group">
                    <label>CNPJ</label>
                    <input type="text" [(ngModel)]="editData.document" name="document" required />
                  </div>
                  <div class="form-group">
                    <label>Email</label>
                    <input type="email" [(ngModel)]="editData.email" name="email" required />
                  </div>
                  <div class="form-group">
                    <label>Telefone</label>
                    <input type="tel" [(ngModel)]="editData.phone" name="phone" required />
                  </div>
                  <div class="form-group full-width">
                    <label>Endere√ßo</label>
                    <input type="text" [(ngModel)]="editData.address" name="address" required />
                  </div>
                </div>

                @if (saveError()) {
                  <div class="error-message">{{ saveError() }}</div>
                }

                <div class="form-actions">
                  <button type="button" class="btn btn-secondary" (click)="cancelEdit()">
                    Cancelar
                  </button>
                  <button type="submit" class="btn btn-primary" [disabled]="saving()">
                    @if (saving()) {
                      <span>Salvando...</span>
                    } @else {
                      <span>Salvar Altera√ß√µes</span>
                    }
                  </button>
                </div>
              </form>
            } @else {
              <div class="info-grid">
                <div class="info-item">
                  <span class="label">Nome:</span>
                  <span class="value">{{ clinic()!.name }}</span>
                </div>
                <div class="info-item">
                  <span class="label">CNPJ:</span>
                  <span class="value">{{ clinic()!.document }}</span>
                </div>
                <div class="info-item">
                  <span class="label">Email:</span>
                  <span class="value">{{ clinic()!.email }}</span>
                </div>
                <div class="info-item">
                  <span class="label">Telefone:</span>
                  <span class="value">{{ clinic()!.phone }}</span>
                </div>
                <div class="info-item">
                  <span class="label">Endere√ßo:</span>
                  <span class="value">{{ clinic()!.address }}</span>
                </div>
                <div class="info-item">
                  <span class="label">Tenant ID:</span>
                  <span class="value">{{ clinic()!.tenantId }}</span>
                </div>
                <div class="info-item">
                  <span class="label">Status:</span>
                  <span class="badge" [class.active]="clinic()!.isActive" [class.inactive]="!clinic()!.isActive">
                    {{ clinic()!.isActive ? 'Ativa' : 'Inativa' }}
                  </span>
                </div>
                <div class="info-item">
                  <span class="label">Criada em:</span>
                  <span class="value">{{ formatDate(clinic()!.createdAt) }}</span>
                </div>
              </div>
            }
          </div>

          <!-- Subscription Card -->
          <div class="card">
            <div class="card-header">
              <h2>Assinatura e Plano</h2>
            </div>

            <div class="info-grid">
              <div class="info-item">
                <span class="label">Plano Atual:</span>
                <span class="value">{{ clinic()!.planName }}</span>
              </div>
              <div class="info-item">
                <span class="label">Valor:</span>
                <span class="value">{{ formatCurrency(clinic()!.planPrice) }}/m√™s</span>
              </div>
              <div class="info-item">
                <span class="label">Status:</span>
                <span class="badge" [class]="getStatusClass(clinic()!.subscriptionStatus)">
                  {{ getStatusLabel(clinic()!.subscriptionStatus) }}
                </span>
              </div>
              @if (clinic()!.trialEndsAt) {
                <div class="info-item">
                  <span class="label">Trial termina em:</span>
                  <span class="value">{{ formatDate(clinic()!.trialEndsAt) }}</span>
                </div>
              }
              @if (clinic()!.nextBillingDate) {
                <div class="info-item">
                  <span class="label">Pr√≥ximo pagamento:</span>
                  <span class="value">{{ formatDate(clinic()!.nextBillingDate) }}</span>
                </div>
              }
            </div>

            <div class="subscription-actions">
              <button class="btn btn-secondary" (click)="showChangePlanModal = true">
                Alterar Plano
              </button>
              <button class="btn btn-primary" (click)="showManualOverrideModal = true">
                üîì Override Manual
              </button>
            </div>
          </div>

          <!-- Users Card -->
          <div class="card">
            <div class="card-header">
              <h2>Usu√°rios</h2>
            </div>

            <div class="info-grid">
              <div class="info-item">
                <span class="label">Total de Usu√°rios:</span>
                <span class="value">{{ clinic()!.totalUsers }}</span>
              </div>
              <div class="info-item">
                <span class="label">Usu√°rios Ativos:</span>
                <span class="value success">{{ clinic()!.activeUsers }}</span>
              </div>
            </div>

            <div class="subscription-actions">
              <button class="btn btn-secondary" (click)="navigateToOwners()">
                Gerenciar Propriet√°rios
              </button>
            </div>
          </div>
        </div>

        <!-- Manual Override Modal -->
        @if (showManualOverrideModal) {
          <div class="modal-overlay" (click)="showManualOverrideModal = false">
            <div class="modal" (click)="$event.stopPropagation()">
              <div class="modal-header">
                <h2>Ativar Override Manual</h2>
                <button class="btn-close" (click)="showManualOverrideModal = false">‚úï</button>
              </div>
              
              <div class="modal-body">
                <p>O override manual permite estender o acesso da cl√≠nica mesmo ap√≥s o vencimento do trial ou falta de pagamento.</p>
                
                <div class="form-group">
                  <label>Motivo *</label>
                  <textarea
                    [(ngModel)]="overrideReason"
                    placeholder="Ex: Cliente solicitou extens√£o para teste..."
                    rows="3"
                  ></textarea>
                </div>

                <div class="form-group">
                  <label>Estender at√© (opcional)</label>
                  <input
                    type="date"
                    [(ngModel)]="overrideExtendUntil"
                  />
                  <small>Deixe em branco para acesso indefinido</small>
                </div>

                @if (overrideError()) {
                  <div class="error-message">{{ overrideError() }}</div>
                }
              </div>

              <div class="modal-footer">
                <button class="btn btn-secondary" (click)="showManualOverrideModal = false">
                  Cancelar
                </button>
                <button class="btn btn-primary" (click)="activateManualOverride()" [disabled]="!overrideReason || overrideProcessing()">
                  @if (overrideProcessing()) {
                    <span>Ativando...</span>
                  } @else {
                    <span>Ativar Override</span>
                  }
                </button>
              </div>
            </div>
          </div>
        }

        <!-- Change Plan Modal -->
        @if (showChangePlanModal) {
          <div class="modal-overlay" (click)="showChangePlanModal = false">
            <div class="modal" (click)="$event.stopPropagation()">
              <div class="modal-header">
                <h2>Alterar Plano</h2>
                <button class="btn-close" (click)="showChangePlanModal = false">‚úï</button>
              </div>
              
              <div class="modal-body">
                <div class="form-group">
                  <label>Novo Plano *</label>
                  <select [(ngModel)]="newPlanId">
                    <option value="">Selecione um plano</option>
                    @for (plan of availablePlans(); track plan.id) {
                      <option [value]="plan.id">
                        {{ plan.name }} - R$ {{ plan.monthlyPrice.toFixed(2) }}/m√™s
                      </option>
                    }
                  </select>
                </div>

                @if (changePlanError()) {
                  <div class="error-message">{{ changePlanError() }}</div>
                }
              </div>

              <div class="modal-footer">
                <button class="btn btn-secondary" (click)="showChangePlanModal = false">
                  Cancelar
                </button>
                <button class="btn btn-primary" (click)="changePlan()" [disabled]="!newPlanId || changePlanProcessing()">
                  @if (changePlanProcessing()) {
                    <span>Alterando...</span>
                  } @else {
                    <span>Alterar Plano</span>
                  }
                </button>
              </div>
            </div>
          </div>
        }
      }
    </div>
