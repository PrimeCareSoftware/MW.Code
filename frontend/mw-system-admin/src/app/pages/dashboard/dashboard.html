<app-navbar></app-navbar>

<div class="dashboard">
      <div class="header">
        <h1>Painel de Administra√ß√£o do Sistema</h1>
        <p class="subtitle">Gerencie todas as cl√≠nicas e visualize m√©tricas do sistema</p>
      </div>

      @if (loading()) {
        <div class="loading">Carregando dados...</div>
      } @else if (error()) {
        <div class="error">
          <p>Erro ao carregar dados: {{ error() }}</p>
          <button (click)="loadAnalytics()" class="btn-retry">Tentar novamente</button>
        </div>
      } @else if (analytics()) {
        <!-- Phase 1: SaaS Metrics KPIs -->
        @if (saasDashboard()) {
          <div class="saas-metrics-section">
            <h2 class="section-title">M√©tricas SaaS</h2>
            <div class="kpi-grid">
              <app-kpi-card
                title="MRR (Receita Recorrente Mensal)"
                [value]="formatCurrency(saasDashboard()!.mrr)"
                [change]="saasDashboard()!.mrrGrowthMoM"
                [trend]="saasDashboard()!.mrrTrend"
                icon="üí∞"
                [clickable]="true"
              />
              <app-kpi-card
                title="ARR (Receita Anual Recorrente)"
                [value]="formatCurrency(saasDashboard()!.arr)"
                [subtitle]="'MRR √ó 12'"
                icon="üìä"
              />
              <app-kpi-card
                title="Clientes Ativos"
                [value]="saasDashboard()!.activeCustomers.toString()"
                [subtitle]="saasDashboard()!.newCustomers + ' novos este m√™s'"
                icon="üë•"
                [clickable]="true"
              />
              <app-kpi-card
                title="Taxa de Churn"
                [value]="saasDashboard()!.churnRate.toFixed(2) + '%'"
                [subtitle]="saasDashboard()!.churnedCustomers + ' cancelamentos este m√™s'"
                icon="üìâ"
              />
              <app-kpi-card
                title="ARPU (Receita M√©dia por Usu√°rio)"
                [value]="formatCurrency(saasDashboard()!.arpu)"
                icon="üíµ"
              />
              <app-kpi-card
                title="LTV / CAC"
                [value]="saasDashboard()!.ltvCacRatio.toFixed(2)"
                [subtitle]="'LTV: ' + formatCurrency(saasDashboard()!.ltv) + ' | CAC: ' + formatCurrency(saasDashboard()!.cac)"
                icon="üìà"
              />
            </div>
          </div>
        }

        <div class="analytics-grid">
          <!-- Clinics Card -->
          <div class="card">
            <div class="card-header">
              <h3>Cl√≠nicas</h3>
              <i class="icon">üè•</i>
            </div>
            <div class="card-body">
              <div class="stat-large">{{ analytics()!.totalClinics }}</div>
              <div class="stat-details">
                <span class="stat-item">
                  <span class="stat-label">Ativas:</span>
                  <span class="stat-value success">{{ analytics()!.activeClinics }}</span>
                </span>
                <span class="stat-item">
                  <span class="stat-label">Inativas:</span>
                  <span class="stat-value error">{{ analytics()!.inactiveClinics }}</span>
                </span>
              </div>
            </div>
          </div>

          <!-- Users Card -->
          <div class="card">
            <div class="card-header">
              <h3>Usu√°rios</h3>
              <i class="icon">üë•</i>
            </div>
            <div class="card-body">
              <div class="stat-large">{{ analytics()!.totalUsers }}</div>
              <div class="stat-details">
                <span class="stat-item">
                  <span class="stat-label">Ativos:</span>
                  <span class="stat-value success">{{ analytics()!.activeUsers }}</span>
                </span>
                <span class="stat-item">
                  <span class="stat-label">Inativos:</span>
                  <span class="stat-value error">{{ analytics()!.totalUsers - analytics()!.activeUsers }}</span>
                </span>
              </div>
            </div>
          </div>

          <!-- Patients Card -->
          <div class="card">
            <div class="card-header">
              <h3>Pacientes</h3>
              <i class="icon">ü©∫</i>
            </div>
            <div class="card-body">
              <div class="stat-large">{{ analytics()!.totalPatients }}</div>
              <div class="stat-details">
                <span class="stat-item">Total de pacientes cadastrados no sistema</span>
              </div>
            </div>
          </div>

          <!-- Revenue Card -->
          <div class="card highlight">
            <div class="card-header">
              <h3>Receita Mensal Recorrente</h3>
              <i class="icon">üí∞</i>
            </div>
            <div class="card-body">
              <div class="stat-large">{{ formatCurrency(analytics()!.monthlyRecurringRevenue) }}</div>
              <div class="stat-details">
                <span class="stat-item">MRR total de todas as cl√≠nicas ativas</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Subscription Status Distribution -->
        <div class="section">
          <h2>Distribui√ß√£o de Assinaturas por Status</h2>
          <div class="distribution-grid">
            @for (item of getSubscriptionStatusItems(); track item.key) {
              <div class="distribution-card">
                <div class="distribution-value">{{ item.value }}</div>
                <div class="distribution-label">{{ item.label }}</div>
              </div>
            }
          </div>
        </div>

        <!-- Subscription Plan Distribution -->
        <div class="section">
          <h2>Distribui√ß√£o de Assinaturas por Plano</h2>
          <div class="distribution-grid">
            @for (item of getSubscriptionPlanItems(); track item.key) {
              <div class="distribution-card">
                <div class="distribution-value">{{ item.value }}</div>
                <div class="distribution-label">{{ item.label }}</div>
              </div>
            }
          </div>
        </div>

        <!-- Quick Actions -->
        <div class="quick-actions">
          <h2>A√ß√µes R√°pidas</h2>
          <div class="actions-grid">
            <button class="action-btn" (click)="navigateToClinics('')">
              <span class="action-icon">üìã</span>
              <span class="action-text">Gerenciar Cl√≠nicas</span>
            </button>
            <button class="action-btn" (click)="navigateToPlans()">
              <span class="action-icon">üíé</span>
              <span class="action-text">Planos de Assinatura</span>
            </button>
            <button class="action-btn" (click)="navigateToOwners()">
              <span class="action-icon">üë§</span>
              <span class="action-text">Gerenciar Propriet√°rios</span>
            </button>
            <button class="action-btn" (click)="navigateToSubdomains()">
              <span class="action-icon">üåê</span>
              <span class="action-text">Configurar Subdom√≠nios</span>
            </button>
          </div>
        </div>
      }
    </div>
