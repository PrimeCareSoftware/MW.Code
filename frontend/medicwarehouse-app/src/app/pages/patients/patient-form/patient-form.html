<app-navbar></app-navbar>

<div class="patient-form-container">
  <!-- Breadcrumbs -->
  <app-accessible-breadcrumbs [items]="breadcrumbs"></app-accessible-breadcrumbs>
  
  <div class="page-header">
    <div class="header-content">
      <a routerLink="/patients" class="back-link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="19" y1="12" x2="5" y2="12"/>
          <polyline points="12 19 5 12 12 5"/>
        </svg>
        Voltar para lista
      </a>
      <h1>{{ isEditMode() ? 'Editar Paciente' : 'Novo Paciente' }}</h1>
      <p>{{ isEditMode() ? 'Atualize os dados do paciente' : 'Preencha os dados para cadastrar um novo paciente' }}</p>
    </div>
  </div>

  @if (errorMessage()) {
    <div class="alert alert-error">{{ errorMessage() }}</div>
  }
  @if (successMessage()) {
    <div class="alert alert-success">{{ successMessage() }}</div>
  }

  <!-- Tabs Navigation -->
  <div class="tabs-navigation">
    <button 
      type="button"
      class="tab-button" 
      [class.active]="activeTab() === 'basic'"
      (click)="setActiveTab('basic')">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
        <circle cx="12" cy="7" r="4"/>
      </svg>
      Cadastro Básico
    </button>

    @if (isEditMode()) {
      <button 
        type="button"
        class="tab-button" 
        [class.active]="activeTab() === 'appointments'"
        (click)="setActiveTab('appointments')">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
          <line x1="16" y1="2" x2="16" y2="6"/>
          <line x1="8" y1="2" x2="8" y2="6"/>
          <line x1="3" y1="10" x2="21" y2="10"/>
        </svg>
        Histórico de Atendimentos
      </button>

      <button 
        type="button"
        class="tab-button" 
        [class.active]="activeTab() === 'procedures'"
        (click)="setActiveTab('procedures')">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
          <polyline points="14 2 14 8 20 8"/>
          <line x1="16" y1="13" x2="8" y2="13"/>
          <line x1="16" y1="17" x2="8" y2="17"/>
          <polyline points="10 9 9 9 8 9"/>
        </svg>
        Histórico de Procedimentos
      </button>
    }
  </div>

  <!-- Tab Content -->

  <!-- Tab Content -->

  <!-- Basic Registration Tab -->
  <div class="tab-content" [class.active]="activeTab() === 'basic'">
  <form [formGroup]="patientForm" (ngSubmit)="onSubmit()" class="patient-form">
    <!-- Personal Data Section -->
    <div class="form-section">
      <div class="section-header">
        <div class="section-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
            <circle cx="12" cy="7" r="4"/>
          </svg>
        </div>
        <div>
          <h3>Dados Pessoais</h3>
          <p>Informações básicas do paciente</p>
        </div>
      </div>
      
      <div class="form-grid">
        <div class="form-group col-span-2">
          <label for="name">Nome Completo <span class="required">*</span></label>
          <input type="text" id="name" formControlName="name" class="form-control" placeholder="Digite o nome completo"/>
        </div>
        <div class="form-group">
          <label for="document">CPF <span class="required">*</span></label>
          <input type="text" id="document" formControlName="document" appCpfMask class="form-control" [class.readonly]="isEditMode()" [readonly]="isEditMode()" placeholder="000.000.000-00"/>
          @if (isEditMode()) {
            <span class="form-hint">CPF não pode ser alterado</span>
          }
        </div>
        <div class="form-group">
          <label for="dateOfBirth">Data de Nascimento <span class="required">*</span></label>
          <input type="date" id="dateOfBirth" formControlName="dateOfBirth" class="form-control" [class.readonly]="isEditMode()" [readonly]="isEditMode()" (change)="onDateOfBirthChange()"/>
        </div>
        <div class="form-group">
          <label for="gender">Gênero <span class="required">*</span></label>
          <select id="gender" formControlName="gender" class="form-control" [disabled]="isEditMode()">
            <option value="">Selecione</option>
            <option value="M">Masculino</option>
            <option value="F">Feminino</option>
            <option value="O">Outro</option>
          </select>
        </div>
      </div>

      @if (isChildPatient()) {
        <div class="guardian-section">
          <div class="guardian-header">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
              <circle cx="9" cy="7" r="4"/>
              <line x1="19" y1="8" x2="19" y2="14"/>
              <line x1="22" y1="11" x2="16" y2="11"/>
            </svg>
            <div>
              <h4>Responsável Legal</h4>
              <p>Pacientes menores de 18 anos devem ter um responsável</p>
            </div>
          </div>
          
          <div class="form-group">
            <label for="guardianSearch">Buscar Responsável <span class="required">*</span></label>
            <div class="search-input-wrapper">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"/>
                <line x1="21" y1="21" x2="16.65" y2="16.65"/>
              </svg>
              <input 
                type="text" 
                id="guardianSearch" 
                [(ngModel)]="guardianSearchTerm"
                [ngModelOptions]="{standalone: true}"
                (input)="searchGuardian()"
                placeholder="Digite o nome ou CPF do responsável"
                class="form-control" 
              />
            </div>
            
            @if (guardianSearchResults().length > 0) {
              <div class="search-results">
                @for (patient of guardianSearchResults(); track patient.id) {
                  <button type="button" class="search-result-item" (click)="selectGuardian(patient)">
                    <div class="result-avatar">{{ patient.name.charAt(0) }}</div>
                    <div class="result-info">
                      <strong>{{ patient.name }}</strong>
                      <span>CPF: {{ patient.document }} · {{ patient.age }} anos</span>
                    </div>
                  </button>
                }
              </div>
            }
            
            @if (selectedGuardian()) {
              <div class="selected-guardian">
                <div class="guardian-info">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                    <polyline points="22 4 12 14.01 9 11.01"/>
                  </svg>
                  <span>Responsável: <strong>{{ selectedGuardian()!.name }}</strong></span>
                </div>
                <button type="button" class="btn-remove" (click)="clearGuardian()">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                  </svg>
                </button>
              </div>
            }
          </div>
        </div>
      }
    </div>

    <!-- Contact Section -->
    <div class="form-section">
      <div class="section-header">
        <div class="section-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
          </svg>
        </div>
        <div>
          <h3>Contato</h3>
          <p>Informações para comunicação</p>
        </div>
      </div>
      
      <div class="form-grid">
        <div class="form-group">
          <label for="email">E-mail <span class="required">*</span></label>
          <input type="email" id="email" formControlName="email" class="form-control" placeholder="email@exemplo.com"/>
        </div>
        <div class="form-group">
          <label for="phoneNumber">Telefone <span class="required">*</span></label>
          <input type="text" id="phoneNumber" formControlName="phoneNumber" appPhoneMask class="form-control" placeholder="(00) 00000-0000"/>
        </div>
      </div>
    </div>

    <!-- Address Section -->
    <div class="form-section" formGroupName="address">
      <div class="section-header">
        <div class="section-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
            <circle cx="12" cy="10" r="3"/>
          </svg>
        </div>
        <div>
          <h3>Endereço</h3>
          <p>Localização do paciente</p>
        </div>
      </div>
      
      <div class="form-grid">
        <div class="form-group">
          <label for="zipCode">CEP <span class="required">*</span></label>
          <input type="text" id="zipCode" formControlName="zipCode" appCepMask class="form-control" placeholder="00000-000" (blur)="onCepBlur()"/>
          <small *ngIf="isLoadingCep()" class="text-muted">Consultando CEP...</small>
        </div>
        <div class="form-group col-span-2">
          <label for="street">Rua <span class="required">*</span></label>
          <input type="text" id="street" formControlName="street" class="form-control" placeholder="Nome da rua"/>
        </div>
        <div class="form-group">
          <label for="number">Número <span class="required">*</span></label>
          <input type="text" id="number" formControlName="number" class="form-control" placeholder="123"/>
        </div>
        <div class="form-group">
          <label for="complement">Complemento</label>
          <input type="text" id="complement" formControlName="complement" class="form-control" placeholder="Apto, Bloco..."/>
        </div>
        <div class="form-group">
          <label for="neighborhood">Bairro <span class="required">*</span></label>
          <input type="text" id="neighborhood" formControlName="neighborhood" class="form-control" placeholder="Nome do bairro"/>
        </div>
        <div class="form-group">
          <label for="city">Cidade <span class="required">*</span></label>
          <input type="text" id="city" formControlName="city" class="form-control" placeholder="Nome da cidade"/>
        </div>
        <div class="form-group">
          <label for="state">Estado <span class="required">*</span></label>
          <input type="text" id="state" formControlName="state" class="form-control" placeholder="UF" maxlength="2"/>
        </div>
      </div>
    </div>

    <!-- Medical Info Section -->
    <div class="form-section">
      <div class="section-header">
        <div class="section-icon medical">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
          </svg>
        </div>
        <div>
          <h3>Informações Médicas</h3>
          <p>Dados importantes para o atendimento</p>
        </div>
      </div>
      
      <div class="form-grid">
        <div class="form-group col-span-full">
          <label for="medicalHistory">Histórico Médico</label>
          <textarea id="medicalHistory" formControlName="medicalHistory" class="form-control" rows="3" placeholder="Descreva o histórico médico relevante..."></textarea>
        </div>
        <div class="form-group col-span-full">
          <label for="allergies">
            Alergias
            <span class="label-badge warning">Importante</span>
          </label>
          <textarea id="allergies" formControlName="allergies" class="form-control allergy-field" rows="3" placeholder="Liste as alergias conhecidas..."></textarea>
        </div>
      </div>
    </div>

    <div class="form-actions">
      <button type="button" class="btn btn-secondary" routerLink="/patients">
        Cancelar
      </button>
      <button type="submit" class="btn btn-primary" [disabled]="patientForm.invalid || isLoading()">
        @if (isLoading()) {
          <span class="spinner"></span>
          <span>Salvando...</span>
        } @else {
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
            <polyline points="17 21 17 13 7 13 7 21"/>
            <polyline points="7 3 7 8 15 8"/>
          </svg>
          <span>Salvar Paciente</span>
        }
      </button>
    </div>
  </form>
  </div>

  <!-- Appointments History Tab -->
  <div class="tab-content" [class.active]="activeTab() === 'appointments'">
    <div class="history-container">
      <div class="history-header">
        <h2>Histórico de Atendimentos</h2>
        <p>Consultas e atendimentos realizados pelo paciente</p>
      </div>

      @if (isLoadingHistory()) {
        <div class="loading-state">
          <span class="spinner"></span>
          <p>Carregando histórico...</p>
        </div>
      } @else if (appointmentHistory().length === 0) {
        <div class="empty-state">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
            <line x1="16" y1="2" x2="16" y2="6"/>
            <line x1="8" y1="2" x2="8" y2="6"/>
            <line x1="3" y1="10" x2="21" y2="10"/>
          </svg>
          <h3>Nenhum atendimento registrado</h3>
          <p>Este paciente ainda não possui histórico de atendimentos</p>
        </div>
      } @else {
        <div class="history-list">
          @for (appointment of appointmentHistory(); track appointment.appointmentId) {
            <div class="history-card">
              <div class="history-card-header">
                <div class="appointment-date">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <polyline points="12 6 12 12 16 14"/>
                  </svg>
                  <span>{{ formatDate(appointment.scheduledDate) }} às {{ formatTime(appointment.scheduledTime) }}</span>
                </div>
                <span class="badge" [ngClass]="getStatusBadgeClass(appointment.status)">
                  {{ formatAppointmentStatus(appointment.status) }}
                </span>
              </div>

              <div class="history-card-body">
                @if (appointment.doctorName) {
                  <div class="info-row">
                    <span class="info-label">Médico:</span>
                    <span class="info-value">
                      {{ appointment.doctorName }}
                      @if (appointment.doctorProfessionalId) {
                        <span class="professional-id">({{ appointment.doctorProfessionalId }})</span>
                      }
                    </span>
                  </div>
                  @if (appointment.doctorSpecialty) {
                    <div class="info-row">
                      <span class="info-label">Especialidade:</span>
                      <span class="info-value">{{ appointment.doctorSpecialty }}</span>
                    </div>
                  }
                }

                @if (appointment.type) {
                  <div class="info-row">
                    <span class="info-label">Tipo:</span>
                    <span class="info-value">{{ appointment.type }}</span>
                  </div>
                }

                @if (appointment.payment) {
                  <div class="payment-info">
                    <div class="info-row">
                      <span class="info-label">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <rect x="1" y="4" width="22" height="16" rx="2" ry="2"/>
                          <line x1="1" y1="10" x2="23" y2="10"/>
                        </svg>
                        Pagamento:
                      </span>
                      <span class="info-value">
                        {{ formatPaymentMethod(appointment.payment.method) }} - 
                        {{ formatCurrency(appointment.payment.amount) }}
                        <span class="badge" [ngClass]="getPaymentStatusBadgeClass(appointment.payment.status)">
                          {{ formatPaymentStatus(appointment.payment.status) }}
                        </span>
                      </span>
                    </div>
                    @if (appointment.payment.cardLastFourDigits) {
                      <div class="info-row">
                        <span class="info-label">Cartão:</span>
                        <span class="info-value">**** {{ appointment.payment.cardLastFourDigits }}</span>
                      </div>
                    }
                    @if (appointment.payment.pixKey) {
                      <div class="info-row">
                        <span class="info-label">Chave PIX:</span>
                        <span class="info-value">{{ appointment.payment.pixKey }}</span>
                      </div>
                    }
                  </div>
                }

                @if (canViewMedicalRecords() && appointment.medicalRecord) {
                  <div class="medical-record-info">
                    <div class="info-row">
                      <span class="info-label">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                          <polyline points="14 2 14 8 20 8"/>
                          <line x1="16" y1="13" x2="8" y2="13"/>
                          <line x1="16" y1="17" x2="8" y2="17"/>
                        </svg>
                        Prontuário:
                      </span>
                      <span class="info-value">{{ appointment.medicalRecord.diagnosis || 'Sem diagnóstico registrado' }}</span>
                    </div>
                    @if (appointment.medicalRecord.consultationDurationMinutes > 0) {
                      <div class="info-row">
                        <span class="info-label">Duração:</span>
                        <span class="info-value">{{ appointment.medicalRecord.consultationDurationMinutes }} minutos</span>
                      </div>
                    }
                  </div>
                }
              </div>
            </div>
          }
        </div>
      }
    </div>
  </div>

  <!-- Procedures History Tab -->
  <div class="tab-content" [class.active]="activeTab() === 'procedures'">
    <div class="history-container">
      <div class="history-header">
        <h2>Histórico de Procedimentos</h2>
        <p>Procedimentos médicos realizados pelo paciente</p>
      </div>

      @if (isLoadingHistory()) {
        <div class="loading-state">
          <span class="spinner"></span>
          <p>Carregando histórico...</p>
        </div>
      } @else if (procedureHistory().length === 0) {
        <div class="empty-state">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
            <polyline points="14 2 14 8 20 8"/>
          </svg>
          <h3>Nenhum procedimento registrado</h3>
          <p>Este paciente ainda não possui histórico de procedimentos</p>
        </div>
      } @else {
        <div class="history-list">
          @for (procedure of procedureHistory(); track procedure.procedureId) {
            <div class="history-card">
              <div class="history-card-header">
                <div class="procedure-info">
                  <h3>{{ procedure.procedureName }}</h3>
                  <span class="procedure-code">Código: {{ procedure.procedureCode }}</span>
                </div>
                <span class="badge badge-info">{{ procedure.procedureCategory }}</span>
              </div>

              <div class="history-card-body">
                <div class="info-row">
                  <span class="info-label">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <circle cx="12" cy="12" r="10"/>
                      <polyline points="12 6 12 12 16 14"/>
                    </svg>
                    Data:
                  </span>
                  <span class="info-value">{{ formatDate(procedure.performedAt) }}</span>
                </div>

                <div class="info-row">
                  <span class="info-label">Valor:</span>
                  <span class="info-value price">{{ formatCurrency(procedure.priceCharged) }}</span>
                </div>

                @if (procedure.doctorName) {
                  <div class="info-row">
                    <span class="info-label">Médico:</span>
                    <span class="info-value">{{ procedure.doctorName }}</span>
                  </div>
                }

                @if (procedure.notes) {
                  <div class="info-row">
                    <span class="info-label">Observações:</span>
                    <span class="info-value">{{ procedure.notes }}</span>
                  </div>
                }

                @if (procedure.payment) {
                  <div class="payment-info">
                    <div class="info-row">
                      <span class="info-label">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <rect x="1" y="4" width="22" height="16" rx="2" ry="2"/>
                          <line x1="1" y1="10" x2="23" y2="10"/>
                        </svg>
                        Pagamento:
                      </span>
                      <span class="info-value">
                        {{ formatPaymentMethod(procedure.payment.method) }}
                        <span class="badge" [ngClass]="getPaymentStatusBadgeClass(procedure.payment.status)">
                          {{ formatPaymentStatus(procedure.payment.status) }}
                        </span>
                      </span>
                    </div>
                  </div>
                }
              </div>
            </div>
          }
        </div>
      }
    </div>
  </div>

</div>
