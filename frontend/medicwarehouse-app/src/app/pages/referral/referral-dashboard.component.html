<app-navbar></app-navbar>

<div class="referral-dashboard">
  <div class="page-header">
    <h1>Programa de Indicação</h1>
    <p class="subtitle">Indique amigos e ganhe R$ {{ program?.rewardPerConversion || 100 }} por cada conversão!</p>
  </div>

  @if (loading) {
    <div class="loading-state">
      <mat-spinner diameter="50"></mat-spinner>
      <p>Carregando...</p>
    </div>
  } @else {
    <!-- Stats Cards -->
    <div class="stats-grid">
      <mat-card class="stat-card">
        <mat-card-content>
          <div class="stat-icon conversions">
            <mat-icon>check_circle</mat-icon>
          </div>
          <div class="stat-info">
            <h3>{{ stats?.convertedReferrals || 0 }}</h3>
            <p>Conversões</p>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="stat-card">
        <mat-card-content>
          <div class="stat-icon earnings">
            <mat-icon>payments</mat-icon>
          </div>
          <div class="stat-info">
            <h3>{{ formatCurrency(stats?.totalEarned || 0) }}</h3>
            <p>Total Ganho</p>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="stat-card">
        <mat-card-content>
          <div class="stat-icon pending">
            <mat-icon>hourglass_empty</mat-icon>
          </div>
          <div class="stat-info">
            <h3>{{ formatCurrency(stats?.pendingRewards || 0) }}</h3>
            <p>Pendente</p>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="stat-card">
        <mat-card-content>
          <div class="stat-icon available">
            <mat-icon>account_balance_wallet</mat-icon>
          </div>
          <div class="stat-info">
            <h3>{{ formatCurrency(stats?.pendingRewards || 0) }}</h3>
            <p>Disponível</p>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Share Section -->
    <mat-card class="share-card">
      <mat-card-header>
        <mat-card-title>Seu Link de Indicação</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="referral-code-section">
          <div class="code-display">
            <span class="label">Código:</span>
            <span class="code">{{ program?.referralCode }}</span>
          </div>
          <div class="link-display">
            <input 
              type="text" 
              [value]="program?.referralLink" 
              readonly 
              class="link-input"
            />
            <button 
              mat-raised-button 
              color="primary" 
              (click)="onCopyLink()"
              matTooltip="Copiar link"
            >
              <mat-icon>content_copy</mat-icon>
              Copiar
            </button>
          </div>
        </div>

        <div class="share-buttons">
          <h3>Compartilhar via:</h3>
          <div class="button-group">
            <button 
              mat-stroked-button 
              (click)="onShareVia('whatsapp')"
              class="share-btn whatsapp"
            >
              <mat-icon>chat</mat-icon>
              WhatsApp
            </button>
            <button 
              mat-stroked-button 
              (click)="onShareVia('email')"
              class="share-btn email"
            >
              <mat-icon>email</mat-icon>
              E-mail
            </button>
            <button 
              mat-stroked-button 
              (click)="onShareVia('linkedin')"
              class="share-btn linkedin"
            >
              <mat-icon>business</mat-icon>
              LinkedIn
            </button>
            <button 
              mat-stroked-button 
              (click)="onShareVia('twitter')"
              class="share-btn twitter"
            >
              <mat-icon>comment</mat-icon>
              Twitter
            </button>
          </div>
        </div>

        <div class="action-buttons">
          <button 
            mat-raised-button 
            color="accent" 
            (click)="onInviteFriends()"
          >
            <mat-icon>person_add</mat-icon>
            Convidar Amigos
          </button>

          <button 
            mat-raised-button 
            color="primary" 
            (click)="onRequestPayout()"
            [disabled]="(stats?.pendingRewards || 0) < (program?.minimumPayoutThreshold || 200)"
          >
            <mat-icon>attach_money</mat-icon>
            Solicitar Pagamento
          </button>
        </div>

        <p class="info-text">
          <mat-icon>info</mat-icon>
          Pagamento mínimo: {{ formatCurrency(program?.minimumPayoutThreshold || 200) }}
        </p>
      </mat-card-content>
    </mat-card>

    <!-- Referrals Table -->
    <mat-card class="referrals-table-card">
      <mat-card-header>
        <mat-card-title>Suas Indicações</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        @if (referrals.length === 0) {
          <div class="empty-state">
            <mat-icon>person_add_disabled</mat-icon>
            <h3>Nenhuma indicação ainda</h3>
            <p>Comece a indicar amigos e ganhe recompensas!</p>
            <button 
              mat-raised-button 
              color="primary" 
              (click)="onInviteFriends()"
            >
              Fazer Primeira Indicação
            </button>
          </div>
        } @else {
          <table mat-table [dataSource]="referrals" class="referrals-table">
            <!-- Email Column -->
            <ng-container matColumnDef="referredEmail">
              <th mat-header-cell *matHeaderCellDef>E-mail</th>
              <td mat-cell *matCellDef="let referral">{{ referral.referredEmail }}</td>
            </ng-container>

            <!-- Status Column -->
            <ng-container matColumnDef="status">
              <th mat-header-cell *matHeaderCellDef>Status</th>
              <td mat-cell *matCellDef="let referral">
                <mat-chip [class]="getStatusClass(referral.status)">
                  {{ getStatusLabel(referral.status) }}
                </mat-chip>
              </td>
            </ng-container>

            <!-- Signed Up At Column -->
            <ng-container matColumnDef="signedUpAt">
              <th mat-header-cell *matHeaderCellDef>Data Cadastro</th>
              <td mat-cell *matCellDef="let referral">{{ formatDate(referral.signedUpAt) }}</td>
            </ng-container>

            <!-- Converted At Column -->
            <ng-container matColumnDef="convertedAt">
              <th mat-header-cell *matHeaderCellDef>Data Conversão</th>
              <td mat-cell *matCellDef="let referral">{{ formatDate(referral.convertedAt) }}</td>
            </ng-container>

            <!-- Reward Column -->
            <ng-container matColumnDef="reward">
              <th mat-header-cell *matHeaderCellDef>Recompensa</th>
              <td mat-cell *matCellDef="let referral">
                @if (referral.reward) {
                  <span class="reward-amount">
                    {{ formatCurrency(referral.reward.amount) }}
                  </span>
                } @else {
                  <span class="no-reward">-</span>
                }
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
          </table>
        }
      </mat-card-content>
    </mat-card>

    <!-- Leaderboard -->
    @if (leaderboard.length > 0) {
      <mat-card class="leaderboard-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>leaderboard</mat-icon>
            Top Indicadores
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <ol class="leaderboard-list">
            @for (leader of leaderboard; track leader.userId) {
              <li class="leaderboard-item">
                <span class="rank">{{ $index + 1 }}</span>
                <span class="name">{{ leader.userName }}</span>
                <span class="conversions">{{ leader.conversions }} conversões</span>
                <span class="earnings">{{ formatCurrency(leader.totalEarned) }}</span>
              </li>
            }
          </ol>
        </mat-card-content>
      </mat-card>
    }
  }
</div>
