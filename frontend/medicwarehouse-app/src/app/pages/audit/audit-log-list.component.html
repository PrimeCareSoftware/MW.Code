<app-navbar></app-navbar>

<div class="audit-log-container">
  <div class="page-header">
    <div class="header-content">
      <h1>Logs de Auditoria</h1>
      <p>Rastreamento completo de ações no sistema (LGPD Lei 13.709/2018)</p>
    </div>
  </div>

  <!-- Filter Section -->
  <div class="form-section">
    <div class="section-header">
      <div class="section-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/>
        </svg>
      </div>
      <div>
        <h3>Filtros de Busca</h3>
        <p>Refine sua busca nos logs de auditoria</p>
      </div>
    </div>
    <form [formGroup]="filterForm" class="filter-form">
      <div class="form-grid">
        <div class="form-group">
          <mat-label>Data Inicial</mat-label>
          <input matInput [matDatepicker]="startPicker" formControlName="startDate" class="form-control">
          <mat-datepicker-toggle matSuffix [for]="startPicker"></mat-datepicker-toggle>
          <mat-datepicker #startPicker></mat-datepicker>
        </div>

        <div class="form-group">
          <mat-label>Data Final</mat-label>
          <input matInput [matDatepicker]="endPicker" formControlName="endDate" class="form-control">
          <mat-datepicker-toggle matSuffix [for]="endPicker"></mat-datepicker-toggle>
          <mat-datepicker #endPicker></mat-datepicker>
        </div>

        <div class="form-group">
          <label for="action">Ação</label>
          <select id="action" formControlName="action" class="form-control">
            <option value="">Todas</option>
            <option *ngFor="let action of actions" [value]="action">
              {{ getActionText(action) }}
            </option>
          </select>
        </div>

        <div class="form-group">
          <label for="result">Resultado</label>
          <select id="result" formControlName="result" class="form-control">
            <option value="">Todos</option>
            <option value="SUCCESS">Sucesso</option>
            <option value="FAILED">Falha</option>
            <option value="UNAUTHORIZED">Não Autorizado</option>
            <option value="PARTIAL_SUCCESS">Sucesso Parcial</option>
          </select>
        </div>

        <div class="form-group">
          <label for="severity">Severidade</label>
          <select id="severity" formControlName="severity" class="form-control">
            <option value="">Todas</option>
            <option value="INFO">Info</option>
            <option value="WARNING">Aviso</option>
            <option value="ERROR">Erro</option>
            <option value="CRITICAL">Crítico</option>
          </select>
        </div>

        <div class="form-group">
          <label for="entityType">Tipo de Entidade</label>
          <input id="entityType" type="text" formControlName="entityType" placeholder="Ex: Patient, User" class="form-control">
        </div>
      </div>

      <div class="form-actions">
        <button type="button" class="btn btn-secondary" (click)="clearFilters()" [disabled]="loading">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
          Limpar Filtros
        </button>
        <button type="button" class="btn btn-primary" (click)="applyFilters()" [disabled]="loading">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/>
          </svg>
          Filtrar
        </button>
      </div>
    </form>
  </div>

  <!-- Loading State -->
  @if (loading) {
    <div class="loading-state">
      <span class="spinner"></span>
      <p>Carregando logs...</p>
    </div>
  }

  <!-- Error Message -->
  @if (error && !loading) {
    <div class="alert alert-error">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"/>
        <line x1="12" y1="8" x2="12" y2="12"/>
        <line x1="12" y1="16" x2="12.01" y2="16"/>
      </svg>
      <span>{{ error }}</span>
    </div>
  }

  <!-- Audit Logs Table -->
  @if (!loading && !error && auditLogs.length > 0) {
    <div class="table-section">
      <div class="section-header">
        <div class="section-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
            <line x1="3" y1="9" x2="21" y2="9"/>
            <line x1="9" y1="21" x2="9" y2="9"/>
          </svg>
        </div>
        <div>
          <h3>Registros de Auditoria</h3>
          <p>Total de {{ totalCount }} registros encontrados</p>
        </div>
      </div>
      
      <div class="table-container">
        <table mat-table [dataSource]="auditLogs" matSort class="audit-table">
          <!-- Timestamp Column -->
          <ng-container matColumnDef="timestamp">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Data/Hora</th>
            <td mat-cell *matCellDef="let log">
              <div class="timestamp-cell">
                <mat-icon class="cell-icon">schedule</mat-icon>
                {{ log.timestamp | date:'dd/MM/yyyy HH:mm:ss' }}
              </div>
            </td>
          </ng-container>

          <!-- User Column -->
          <ng-container matColumnDef="userName">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Usuário</th>
            <td mat-cell *matCellDef="let log">
              <div class="user-cell">
                <mat-icon class="cell-icon">person</mat-icon>
                <div>
                  <div class="user-name">{{ log.userName }}</div>
                  <div class="user-email">{{ log.userEmail }}</div>
                </div>
              </div>
            </td>
          </ng-container>

          <!-- Action Column -->
          <ng-container matColumnDef="action">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Ação</th>
            <td mat-cell *matCellDef="let log">
              <span class="badge" [ngClass]="getActionBadgeClass(log.action)">
                {{ getActionText(log.action) }}
              </span>
            </td>
          </ng-container>

          <!-- Entity Column -->
          <ng-container matColumnDef="entityType">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Entidade</th>
            <td mat-cell *matCellDef="let log">
              <div class="entity-cell">
                <div class="entity-type">{{ log.entityType }}</div>
                <div class="entity-name" *ngIf="log.entityDisplayName">
                  {{ log.entityDisplayName }}
                </div>
              </div>
            </td>
          </ng-container>

          <!-- Result Column -->
          <ng-container matColumnDef="result">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Resultado</th>
            <td mat-cell *matCellDef="let log">
              <div class="result-cell">
                <span class="badge" [ngClass]="getResultBadgeClass(log.result)">
                  {{ getResultText(log.result) }}
                </span>
              </div>
            </td>
          </ng-container>

          <!-- IP Address Column -->
          <ng-container matColumnDef="ipAddress">
            <th mat-header-cell *matHeaderCellDef>IP</th>
            <td mat-cell *matCellDef="let log">
              <div class="ip-cell">
                <mat-icon class="cell-icon">computer</mat-icon>
                {{ log.ipAddress }}
              </div>
            </td>
          </ng-container>

          <!-- Details Column -->
          <ng-container matColumnDef="details">
            <th mat-header-cell *matHeaderCellDef>Detalhes</th>
            <td mat-cell *matCellDef="let log">
              <button 
                type="button"
                class="btn-icon" 
                (click)="viewDetails(log)"
                matTooltip="Ver detalhes completos">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"/>
                  <line x1="12" y1="16" x2="12" y2="12"/>
                  <line x1="12" y1="8" x2="12.01" y2="8"/>
                </svg>
              </button>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr 
            mat-row 
            *matRowDef="let row; columns: displayedColumns;" 
            class="table-row"
            (click)="viewDetails(row)">
          </tr>
        </table>
      </div>

      <!-- Paginator -->
      <mat-paginator 
        [length]="totalCount"
        [pageSize]="pageSize"
        [pageSizeOptions]="[25, 50, 100]"
        (page)="onPageChange($event)"
        showFirstLastButtons>
      </mat-paginator>
    </div>
  }

  <!-- Empty State -->
  @if (!loading && !error && auditLogs.length === 0) {
    <div class="empty-state">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="11" cy="11" r="8"/>
        <line x1="21" y1="21" x2="16.65" y2="16.65"/>
        <line x1="11" y1="8" x2="11" y2="14"/>
        <line x1="8" y1="11" x2="14" y2="11"/>
      </svg>
      <h3>Nenhum log encontrado</h3>
      <p>Tente ajustar os filtros de busca</p>
    </div>
  }
</div>
