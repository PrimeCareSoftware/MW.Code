<app-navbar></app-navbar>

<div class="history-container">
  <div class="page-header">
    <div class="header-content">
      <h1>Histórico de Anamneses</h1>
      @if (patient()) {
        <p>Paciente: <strong>{{ patient()!.name }}</strong></p>
      }
    </div>
    <button class="btn btn-secondary" routerLink="/patients">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="19" y1="12" x2="5" y2="12"/>
        <polyline points="12 19 5 12 12 5"/>
      </svg>
      Voltar
    </button>
  </div>

  @if (errorMessage()) {
    <div class="alert alert-error">
      {{ errorMessage() }}
    </div>
  }

  @if (isLoading()) {
    <div class="loading-container">
      <div class="loading">Carregando histórico...</div>
    </div>
  } @else {
    @if (responses().length === 0) {
      <div class="empty-state-card">
        <div class="empty-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2"/>
            <rect x="9" y="3" width="6" height="4" rx="2"/>
            <path d="M9 12h6"/>
            <path d="M9 16h6"/>
          </svg>
        </div>
        <h3>Nenhuma anamnese registrada</h3>
        <p>Este paciente ainda não possui histórico de anamneses</p>
      </div>
    } @else {
      <div class="history-list">
        @for (response of responses(); track response.id) {
          <div class="history-card" (click)="viewDetails(response)">
            <div class="card-header">
              <div class="card-icon">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                  <polyline points="14 2 14 8 20 8"/>
                  <line x1="16" y1="13" x2="8" y2="13"/>
                  <line x1="16" y1="17" x2="8" y2="17"/>
                  <polyline points="10 9 9 9 8 9"/>
                </svg>
              </div>
              <div class="card-info">
                <h3>Anamnese - {{ formatDate(response.responseDate) }}</h3>
                <p>{{ formatDateTime(response.responseDate) }}</p>
              </div>
              <span class="badge" [ngClass]="getCompletionBadgeClass(response)">
                {{ getCompletionText(response) }}
              </span>
            </div>
            
            <div class="card-body">
              <div class="info-grid">
                <div class="info-item">
                  <span class="info-label">Respostas</span>
                  <span class="info-value">{{ getAnswerCount(response) }}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">ID do Atendimento</span>
                  <span class="info-value">{{ response.appointmentId }}</span>
                </div>
              </div>
            </div>
            
            <div class="card-footer">
              <span class="view-details">Ver detalhes →</span>
            </div>
          </div>
        }
      </div>
    }
  }
</div>

<!-- Details Modal -->
@if (selectedResponse()) {
  <div class="modal-overlay" (click)="closeDetails()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Detalhes da Anamnese</h2>
        <button class="modal-close" (click)="closeDetails()">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>
      
      <div class="modal-body">
        <div class="detail-group">
          <label>Data</label>
          <p>{{ formatDateTime(selectedResponse()!.responseDate) }}</p>
        </div>
        
        <div class="detail-group">
          <label>Status</label>
          <span class="badge" [ngClass]="getCompletionBadgeClass(selectedResponse()!)">
            {{ getCompletionText(selectedResponse()!) }}
          </span>
        </div>
        
        <div class="detail-group">
          <label>ID do Atendimento</label>
          <p>{{ selectedResponse()!.appointmentId }}</p>
        </div>
        
        <div class="answers-section">
          <h3>Respostas</h3>
          @if (selectedResponse()!.answers && selectedResponse()!.answers.length > 0) {
            <div class="answers-list">
              @for (answer of selectedResponse()!.answers; track answer.questionText) {
                <div class="answer-item">
                  <div class="answer-question">{{ answer.questionText }}</div>
                  <div class="answer-response">
                    @if (answer.booleanValue !== null && answer.booleanValue !== undefined) {
                      <span class="badge" [class.badge-success]="answer.booleanValue" [class.badge-error]="!answer.booleanValue">
                        {{ answer.booleanValue ? 'Sim' : 'Não' }}
                      </span>
                    } @else if (answer.selectedOptions && answer.selectedOptions.length > 0) {
                      <div class="selected-options">
                        @for (option of answer.selectedOptions; track option) {
                          <span class="badge badge-info">{{ option }}</span>
                        }
                      </div>
                    } @else {
                      {{ answer.answer }}
                    }
                  </div>
                </div>
              }
            </div>
          } @else {
            <p class="no-answers">Nenhuma resposta registrada</p>
          }
        </div>
      </div>
      
      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="closeDetails()">Fechar</button>
      </div>
    </div>
  </div>
}
