<app-navbar></app-navbar>

<div class="user-management-container">
  <div class="page-header">
    <div>
      <h1>Gerenciamento de Usuários</h1>
      <p>Visualize e gerencie os usuários da sua clínica</p>
    </div>
    <button class="btn btn-primary" (click)="openCreateDialog()">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
        <circle cx="9" cy="7" r="4"/>
        <line x1="19" x2="19" y1="8" y2="14"/>
        <line x1="22" x2="16" y1="11" y2="11"/>
      </svg>
      Novo Usuário
    </button>
  </div>

  @if (successMessage()) {
    <div class="alert alert-success">
      {{ successMessage() }}
    </div>
  }

  @if (isLoading()) {
    <div class="loading-state">
      <div class="spinner"></div>
      <p>Carregando usuários...</p>
    </div>
  } @else {
    @if (errorMessage()) {
      <div class="alert alert-error">
        {{ errorMessage() }}
      </div>
    }

    @if (users().length > 0) {
      <div class="users-card">
        <div class="card-header">
          <h3>Usuários da Clínica ({{ users().length }})</h3>
        </div>
        
        <div class="users-table">
          <table>
            <thead>
              <tr>
                <th>Nome de Usuário</th>
                <th>Nome Completo</th>
                <th>E-mail</th>
                <th>Perfil</th>
                <th>CRM/Especialidade</th>
                <th>Status</th>
                <th>Criado em</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody>
              @for (user of users(); track user.id) {
                <tr>
                  <td>
                    <div class="user-cell">
                      <div class="user-avatar">
                        {{ user.username.charAt(0).toUpperCase() }}
                      </div>
                      <span class="user-username">{{ user.username }}</span>
                    </div>
                  </td>
                  <td>{{ user.name || '-' }}</td>
                  <td>{{ user.email }}</td>
                  <td>
                    <span class="profile-badge">
                      {{ getRoleText(user.role) }}
                    </span>
                  </td>
                  <td>
                    @if (user.role === 'Doctor') {
                      <div class="doctor-info">
                        @if (user.professionalId) {
                          <div class="professional-id">CRM: {{ user.professionalId }}</div>
                        }
                        @if (user.specialty) {
                          <div class="specialty">{{ user.specialty }}</div>
                        }
                        @if (!user.professionalId && !user.specialty) {
                          <span>-</span>
                        }
                      </div>
                    } @else {
                      <span>-</span>
                    }
                  </td>
                  <td>
                    <span [class]="'status-badge ' + getStatusBadgeClass(user.isActive)">
                      {{ getStatusText(user.isActive) }}
                    </span>
                  </td>
                  <td>{{ user.createdAt | date: 'dd/MM/yyyy' }}</td>
                  <td>
                    <div class="action-buttons">
                      <button class="btn-icon" (click)="openEditDialog(user)" title="Editar">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                          <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                        </svg>
                      </button>
                      <button class="btn-icon" (click)="openPasswordDialog(user)" title="Alterar Senha">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                          <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                        </svg>
                      </button>
                      <button class="btn-icon" (click)="openRoleDialog(user)" title="Alterar Perfil">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                          <circle cx="12" cy="7" r="4"/>
                        </svg>
                      </button>
                      <button 
                        class="btn-icon" 
                        [class.btn-danger]="user.isActive"
                        [class.btn-success]="!user.isActive"
                        (click)="openDeactivateDialog(user)" 
                        [title]="user.isActive ? 'Desativar' : 'Ativar'"
                      >
                        @if (user.isActive) {
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <line x1="15" x2="9" y1="9" y2="15"/>
                            <line x1="9" x2="15" y1="9" y2="15"/>
                          </svg>
                        } @else {
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <polyline points="12 6 12 12 16 14"/>
                          </svg>
                        }
                      </button>
                    </div>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      </div>
    } @else {
      <div class="empty-state">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
          <circle cx="9" cy="7" r="4"/>
          <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
          <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
        </svg>
        <h3>Nenhum usuário encontrado</h3>
        <p>Ainda não há usuários cadastrados na sua clínica.</p>
        <button class="btn btn-primary" (click)="openCreateDialog()">Criar Primeiro Usuário</button>
      </div>
    }
  }

  <!-- Create User Dialog -->
  @if (showCreateDialog()) {
    <div class="modal-overlay" (click)="closeCreateDialog()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>Criar Novo Usuário</h3>
          <button class="btn-close" (click)="closeCreateDialog()">×</button>
        </div>
        
        <form [formGroup]="createUserForm" (ngSubmit)="createUser()">
          <div class="modal-body">
            <div class="form-group">
              <label for="username">Nome de Usuário *</label>
              <input 
                type="text" 
                id="username" 
                formControlName="username" 
                class="form-control"
                placeholder="Ex: joao.silva"
              />
              @if (createUserForm.get('username')?.invalid && createUserForm.get('username')?.touched) {
                <span class="error-text">Nome de usuário é obrigatório (mínimo 3 caracteres)</span>
              }
            </div>

            <div class="form-group">
              <label for="name">Nome Completo *</label>
              <input 
                type="text" 
                id="name" 
                formControlName="name" 
                class="form-control"
                placeholder="Ex: João Silva"
              />
              @if (createUserForm.get('name')?.invalid && createUserForm.get('name')?.touched) {
                <span class="error-text">Nome completo é obrigatório</span>
              }
            </div>

            <div class="form-group">
              <label for="email">E-mail *</label>
              <input 
                type="email" 
                id="email" 
                formControlName="email" 
                class="form-control"
                placeholder="Ex: joao@exemplo.com"
              />
              @if (createUserForm.get('email')?.invalid && createUserForm.get('email')?.touched) {
                <span class="error-text">E-mail válido é obrigatório</span>
              }
            </div>

            <div class="form-group">
              <label for="password">Senha *</label>
              <input 
                type="password" 
                id="password" 
                formControlName="password" 
                class="form-control"
                placeholder="Mínimo 8 caracteres"
              />
              @if (createUserForm.get('password')?.invalid && createUserForm.get('password')?.touched) {
                <span class="error-text">Senha é obrigatória (mínimo 8 caracteres)</span>
              }
            </div>

            <div class="form-group">
              <label for="phone">Telefone</label>
              <input 
                type="tel" 
                id="phone" 
                formControlName="phone" 
                class="form-control"
                placeholder="(00) 00000-0000"
              />
            </div>

            <div class="form-group">
              <label for="role">Perfil *</label>
              <select id="role" formControlName="role" class="form-control">
                @for (role of userRoles; track role) {
                  <option [value]="role">{{ getRoleText(role) }}</option>
                }
              </select>
            </div>

            <!-- Doctor-specific fields -->
            @if (isDoctorRole()) {
              <div class="form-group">
                <label for="professionalId">CRM/Registro Profissional {{ doctorFieldsConfig().professionalIdRequired ? '*' : '' }}</label>
                <input 
                  type="text" 
                  id="professionalId" 
                  formControlName="professionalId" 
                  class="form-control"
                  placeholder="Ex: CRM-123456"
                />
                @if (createUserForm.get('professionalId')?.invalid && createUserForm.get('professionalId')?.touched) {
                  <span class="error-text">CRM é obrigatório para médicos</span>
                }
              </div>

              <div class="form-group">
                <label for="specialty">Especialidade {{ doctorFieldsConfig().specialtyRequired ? '*' : '' }}</label>
                <input 
                  type="text" 
                  id="specialty" 
                  formControlName="specialty" 
                  class="form-control"
                  placeholder="Ex: Clínico Geral"
                />
                @if (createUserForm.get('specialty')?.invalid && createUserForm.get('specialty')?.touched) {
                  <span class="error-text">Especialidade é obrigatória para médicos</span>
                }
              </div>

              <div class="form-group">
                <label class="checkbox-label">
                  <input 
                    type="checkbox" 
                    formControlName="showInAppointmentScheduling"
                  />
                  <span>Exibir no agendamento de consultas</span>
                </label>
                <small class="form-text">Se marcado, este profissional aparecerá na lista de médicos disponíveis para agendamento</small>
              </div>
            }
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" (click)="closeCreateDialog()">
              Cancelar
            </button>
            <button 
              type="submit" 
              class="btn btn-primary" 
              [disabled]="createUserForm.invalid || isProcessing()"
            >
              @if (isProcessing()) {
                <span class="spinner"></span>
                <span>Criando...</span>
              } @else {
                <span>Criar Usuário</span>
              }
            </button>
          </div>
        </form>
      </div>
    </div>
  }

  <!-- Edit User Dialog -->
  @if (showEditDialog() && selectedUser()) {
    <div class="modal-overlay" (click)="closeEditDialog()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>Editar Usuário: {{ selectedUser()!.username }}</h3>
          <button class="btn-close" (click)="closeEditDialog()">×</button>
        </div>
        
        <form [formGroup]="editUserForm" (ngSubmit)="updateUser()">
          <div class="modal-body">
            <div class="form-group">
              <label for="edit-name">Nome Completo *</label>
              <input 
                type="text" 
                id="edit-name" 
                formControlName="name" 
                class="form-control"
              />
            </div>

            <div class="form-group">
              <label for="edit-email">E-mail *</label>
              <input 
                type="email" 
                id="edit-email" 
                formControlName="email" 
                class="form-control"
              />
            </div>

            <div class="form-group">
              <label for="edit-phone">Telefone</label>
              <input 
                type="tel" 
                id="edit-phone" 
                formControlName="phone" 
                class="form-control"
              />
            </div>

            <!-- Doctor-specific fields (only shown if user is a doctor) -->
            @if (isEditingDoctor()) {
              <div class="form-group">
                <label for="edit-professionalId">CRM/Registro Profissional {{ doctorFieldsConfig().professionalIdRequired ? '*' : '' }}</label>
                <input 
                  type="text" 
                  id="edit-professionalId" 
                  formControlName="professionalId" 
                  class="form-control"
                  placeholder="Ex: CRM-123456"
                />
              </div>

              <div class="form-group">
                <label for="edit-specialty">Especialidade {{ doctorFieldsConfig().specialtyRequired ? '*' : '' }}</label>
                <input 
                  type="text" 
                  id="edit-specialty" 
                  formControlName="specialty" 
                  class="form-control"
                  placeholder="Ex: Clínico Geral"
                />
              </div>

              <div class="form-group">
                <label class="checkbox-label">
                  <input 
                    type="checkbox" 
                    formControlName="showInAppointmentScheduling"
                  />
                  <span>Exibir no agendamento de consultas</span>
                </label>
                <small class="form-text">Se marcado, este profissional aparecerá na lista de médicos disponíveis para agendamento</small>
              </div>
            }
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" (click)="closeEditDialog()">
              Cancelar
            </button>
            <button 
              type="submit" 
              class="btn btn-primary" 
              [disabled]="editUserForm.invalid || isProcessing()"
            >
              @if (isProcessing()) {
                <span class="spinner"></span>
                <span>Salvando...</span>
              } @else {
                <span>Salvar Alterações</span>
              }
            </button>
          </div>
        </form>
      </div>
    </div>
  }

  <!-- Change Password Dialog -->
  @if (showPasswordDialog() && selectedUser()) {
    <div class="modal-overlay" (click)="closePasswordDialog()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>Alterar Senha: {{ selectedUser()!.username }}</h3>
          <button class="btn-close" (click)="closePasswordDialog()">×</button>
        </div>
        
        <form [formGroup]="passwordForm" (ngSubmit)="changePassword()">
          <div class="modal-body">
            <div class="form-group">
              <label for="new-password">Nova Senha *</label>
              <input 
                type="password" 
                id="new-password" 
                formControlName="newPassword" 
                class="form-control"
                placeholder="Mínimo 8 caracteres"
              />
              @if (passwordForm.get('newPassword')?.invalid && passwordForm.get('newPassword')?.touched) {
                <span class="error-text">Senha deve ter no mínimo 8 caracteres</span>
              }
            </div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" (click)="closePasswordDialog()">
              Cancelar
            </button>
            <button 
              type="submit" 
              class="btn btn-primary" 
              [disabled]="passwordForm.invalid || isProcessing()"
            >
              @if (isProcessing()) {
                <span class="spinner"></span>
                <span>Alterando...</span>
              } @else {
                <span>Alterar Senha</span>
              }
            </button>
          </div>
        </form>
      </div>
    </div>
  }

  <!-- Change Role Dialog -->
  @if (showRoleDialog() && selectedUser()) {
    <div class="modal-overlay" (click)="closeRoleDialog()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>Alterar Perfil: {{ selectedUser()!.username }}</h3>
          <button class="btn-close" (click)="closeRoleDialog()">×</button>
        </div>
        
        <form [formGroup]="roleForm" (ngSubmit)="changeRole()">
          <div class="modal-body">
            <div class="form-group">
              <label for="new-role">Novo Perfil *</label>
              <select id="new-role" formControlName="newRole" class="form-control">
                @for (role of userRoles; track role) {
                  <option [value]="role">{{ getRoleText(role) }}</option>
                }
              </select>
            </div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" (click)="closeRoleDialog()">
              Cancelar
            </button>
            <button 
              type="submit" 
              class="btn btn-primary" 
              [disabled]="roleForm.invalid || isProcessing()"
            >
              @if (isProcessing()) {
                <span class="spinner"></span>
                <span>Alterando...</span>
              } @else {
                <span>Alterar Perfil</span>
              }
            </button>
          </div>
        </form>
      </div>
    </div>
  }

  <!-- Deactivate/Activate User Dialog -->
  @if (showDeactivateDialog() && selectedUser()) {
    <div class="modal-overlay" (click)="closeDeactivateDialog()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>{{ selectedUser()!.isActive ? 'Desativar' : 'Ativar' }} Usuário</h3>
          <button class="btn-close" (click)="closeDeactivateDialog()">×</button>
        </div>
        
        <div class="modal-body">
          <p>
            Tem certeza que deseja {{ selectedUser()!.isActive ? 'desativar' : 'ativar' }} o usuário 
            <strong>{{ selectedUser()!.name }}</strong>?
          </p>
          @if (selectedUser()!.isActive) {
            <p class="warning-text">
              O usuário não poderá mais acessar o sistema até ser reativado.
            </p>
          }
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="closeDeactivateDialog()">
            Cancelar
          </button>
          <button 
            type="button" 
            [class]="selectedUser()!.isActive ? 'btn btn-danger' : 'btn btn-success'"
            (click)="toggleUserStatus()"
            [disabled]="isProcessing()"
          >
            @if (isProcessing()) {
              <span class="spinner"></span>
              <span>Processando...</span>
            } @else {
              <span>{{ selectedUser()!.isActive ? 'Desativar' : 'Ativar' }}</span>
            }
          </button>
        </div>
      </div>
    </div>
  }
</div>
