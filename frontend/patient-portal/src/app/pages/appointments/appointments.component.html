<div class="appointments-container">
  <header class="page-header">
    <button mat-icon-button routerLink="/dashboard" [matTooltip]="'Voltar ao Dashboard'">
      <mat-icon>arrow_back</mat-icon>
    </button>
    <h1>Minhas Consultas</h1>
    <button mat-icon-button (click)="retry()" [matTooltip]="'Atualizar'" *ngIf="!loading">
      <mat-icon>refresh</mat-icon>
    </button>
  </header>

  <div class="appointments-content" *ngIf="!loading; else loadingTemplate">
    <!-- Error State -->
    <div *ngIf="loadingError" class="error-banner">
      <mat-icon>error_outline</mat-icon>
      <span>Não foi possível carregar suas consultas.</span>
      <button mat-button color="primary" (click)="retry()">Tentar novamente</button>
    </div>

    <!-- Tabs for filtering -->
    <mat-tab-group (selectedIndexChange)="onTabChange($event)" [selectedIndex]="selectedTab" class="appointments-tabs">
      <mat-tab label="Todas">
        <ng-container *ngTemplateOutlet="appointmentsList"></ng-container>
      </mat-tab>
      <mat-tab label="Próximas">
        <ng-container *ngTemplateOutlet="appointmentsList"></ng-container>
      </mat-tab>
      <mat-tab label="Passadas">
        <ng-container *ngTemplateOutlet="appointmentsList"></ng-container>
      </mat-tab>
      <mat-tab label="Canceladas">
        <ng-container *ngTemplateOutlet="appointmentsList"></ng-container>
      </mat-tab>
    </mat-tab-group>

    <!-- Appointments List Template -->
    <ng-template #appointmentsList>
      <div class="appointments-list">
        <div *ngIf="filteredAppointments.length > 0; else noAppointments">
          <mat-card *ngFor="let appointment of filteredAppointments" class="appointment-card">
            <mat-card-content>
              <div class="appointment-header">
                <div class="doctor-info">
                  <div class="avatar">
                    <mat-icon>person</mat-icon>
                  </div>
                  <div>
                    <h2>{{ appointment.doctorName }}</h2>
                    <p class="specialty">
                      <mat-icon>medical_services</mat-icon>
                      {{ appointment.doctorSpecialty }}
                    </p>
                  </div>
                </div>
                <div class="appointment-date">
                  <p class="date">{{ formatDate(appointment.appointmentDate) }}</p>
                  <p class="time">{{ formatTime(appointment.startTime) }} - {{ formatTime(appointment.endTime) }}</p>
                </div>
              </div>

              <mat-divider class="divider"></mat-divider>

              <div class="appointment-details">
                <div class="detail-item">
                  <mat-icon>location_on</mat-icon>
                  <span>{{ appointment.clinicName }}</span>
                </div>
                <div class="detail-item">
                  <mat-icon>event</mat-icon>
                  <span>{{ appointment.appointmentType }}</span>
                </div>
                <div class="detail-item" *ngIf="appointment.isTelehealth">
                  <mat-icon>videocam</mat-icon>
                  <span>Telemedicina</span>
                </div>
              </div>

              <div class="appointment-footer">
                <mat-chip [class]="'status-' + getStatusColor(appointment.status)">
                  {{ appointment.status }}
                </mat-chip>
                <div class="actions" *ngIf="appointment.canCancel || appointment.canReschedule || canConfirm(appointment)">
                  <button mat-stroked-button color="accent" *ngIf="canConfirm(appointment)"
                          (click)="confirmAppointment(appointment)">
                    <mat-icon>check_circle</mat-icon>
                    Confirmar
                  </button>
                  <button mat-stroked-button color="primary" *ngIf="appointment.canReschedule"
                          (click)="rescheduleAppointment(appointment)">
                    <mat-icon>event</mat-icon>
                    Reagendar
                  </button>
                  <button mat-stroked-button color="warn" *ngIf="appointment.canCancel"
                          (click)="cancelAppointment(appointment)">
                    <mat-icon>cancel</mat-icon>
                    Cancelar
                  </button>
                </div>
              </div>

              <div class="notes" *ngIf="appointment.notes">
                <mat-icon>note</mat-icon>
                <p><strong>Observações:</strong> {{ appointment.notes }}</p>
              </div>
            </mat-card-content>
          </mat-card>
        </div>

        <ng-template #noAppointments>
          <mat-card class="empty-state">
            <mat-card-content>
              <mat-icon>event_busy</mat-icon>
              <h2>Nenhuma consulta encontrada</h2>
              <p>Você não tem consultas nesta categoria</p>
            </mat-card-content>
          </mat-card>
        </ng-template>
      </div>
    </ng-template>
  </div>

  <ng-template #loadingTemplate>
    <div class="loading-container">
      <mat-spinner diameter="64"></mat-spinner>
      <p class="loading-text">Carregando consultas...</p>
    </div>
  </ng-template>
</div>
