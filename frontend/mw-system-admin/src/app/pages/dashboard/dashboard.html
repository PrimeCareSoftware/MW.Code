<app-navbar></app-navbar>

<div class="dashboard">
      <div class="dashboard-header">
        <div class="welcome-section">
          <h1>Bom dia! üëã</h1>
          <p>Gerencie todas as cl√≠nicas e visualize m√©tricas do sistema</p>
        </div>
        <div class="header-actions">
          <button class="btn btn-primary" (click)="navigateToClinics('')">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="12" y1="5" x2="12" y2="19"/>
              <line x1="5" y1="12" x2="19" y2="12"/>
            </svg>
            Nova Cl√≠nica
          </button>
        </div>
      </div>

      @if (loading()) {
        <div class="loading">Carregando dados...</div>
      } @else if (error()) {
        <div class="error">
          <p>Erro ao carregar dados: {{ error() }}</p>
          <button (click)="loadAnalytics()" class="btn-retry">Tentar novamente</button>
        </div>
      } @else if (analytics()) {
        <!-- Phase 1: SaaS Metrics KPIs -->
        @if (saasDashboard()) {
          <div class="saas-metrics-section">
            <h2 class="section-title">M√©tricas SaaS</h2>
            <div class="kpi-grid">
              <app-kpi-card
                title="MRR (Receita Recorrente Mensal)"
                [value]="formatCurrency(saasDashboard()!.mrr)"
                [change]="saasDashboard()!.mrrGrowthMoM"
                [trend]="saasDashboard()!.mrrTrend"
                icon="üí∞"
                [clickable]="true"
              />
              <app-kpi-card
                title="ARR (Receita Anual Recorrente)"
                [value]="formatCurrency(saasDashboard()!.arr)"
                [subtitle]="'MRR √ó 12'"
                icon="üìä"
              />
              <app-kpi-card
                title="Clientes Ativos"
                [value]="saasDashboard()!.activeCustomers.toString()"
                [subtitle]="saasDashboard()!.newCustomers + ' novos este m√™s'"
                icon="üë•"
                [clickable]="true"
              />
              <app-kpi-card
                title="Taxa de Churn"
                [value]="saasDashboard()!.churnRate.toFixed(2) + '%'"
                [subtitle]="saasDashboard()!.churnedCustomers + ' cancelamentos este m√™s'"
                icon="üìâ"
              />
              <app-kpi-card
                title="ARPU (Receita M√©dia por Usu√°rio)"
                [value]="formatCurrency(saasDashboard()!.arpu)"
                icon="üíµ"
              />
              <app-kpi-card
                title="LTV / CAC"
                [value]="saasDashboard()!.ltvCacRatio.toFixed(2)"
                [subtitle]="'LTV: ' + formatCurrency(saasDashboard()!.ltv) + ' | CAC: ' + formatCurrency(saasDashboard()!.cac)"
                icon="üìà"
              />
            </div>
          </div>
        }

        <div class="analytics-grid">
          <!-- Clinics Card -->
          <div class="card stat-card stat-clinics">
            <div class="card-header">
              <h3>Cl√≠nicas</h3>
              <div class="stat-icon">
                <i class="icon">üè•</i>
              </div>
            </div>
            <div class="card-body">
              <div class="stat-content">
                <span class="stat-value">{{ analytics()!.totalClinics }}</span>
                <span class="stat-label">Cl√≠nicas Cadastradas</span>
              </div>
              <div class="stat-details">
                <span class="stat-item">
                  <span class="stat-label">Ativas:</span>
                  <span class="stat-value success">{{ analytics()!.activeClinics }}</span>
                </span>
                <span class="stat-item">
                  <span class="stat-label">Inativas:</span>
                  <span class="stat-value error">{{ analytics()!.inactiveClinics }}</span>
                </span>
              </div>
            </div>
          </div>

          <!-- Users Card -->
          <div class="card stat-card stat-users">
            <div class="card-header">
              <h3>Usu√°rios</h3>
              <div class="stat-icon">
                <i class="icon">üë•</i>
              </div>
            </div>
            <div class="card-body">
              <div class="stat-content">
                <span class="stat-value">{{ analytics()!.totalUsers }}</span>
                <span class="stat-label">Usu√°rios Cadastrados</span>
              </div>
              <div class="stat-details">
                <span class="stat-item">
                  <span class="stat-label">Ativos:</span>
                  <span class="stat-value success">{{ analytics()!.activeUsers }}</span>
                </span>
                <span class="stat-item">
                  <span class="stat-label">Inativos:</span>
                  <span class="stat-value error">{{ analytics()!.totalUsers - analytics()!.activeUsers }}</span>
                </span>
              </div>
            </div>
          </div>

          <!-- Patients Card -->
          <div class="card stat-card stat-patients">
            <div class="card-header">
              <h3>Pacientes</h3>
              <div class="stat-icon">
                <i class="icon">ü©∫</i>
              </div>
            </div>
            <div class="card-body">
              <div class="stat-content">
                <span class="stat-value">{{ analytics()!.totalPatients }}</span>
                <span class="stat-label">Pacientes Cadastrados</span>
              </div>
              <div class="stat-details">
                <span class="stat-item">Total de pacientes cadastrados no sistema</span>
              </div>
            </div>
          </div>

          <!-- Revenue Card -->
          <div class="card stat-card stat-revenue highlight">
            <div class="card-header">
              <h3>Receita Mensal Recorrente</h3>
              <div class="stat-icon">
                <i class="icon">üí∞</i>
              </div>
            </div>
            <div class="card-body">
              <div class="stat-content">
                <span class="stat-value">{{ formatCurrency(analytics()!.monthlyRecurringRevenue) }}</span>
                <span class="stat-label">MRR Total</span>
              </div>
              <div class="stat-details">
                <span class="stat-item">MRR total de todas as cl√≠nicas ativas</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Quick Access Section -->
        <div class="section quick-access-section">
          <h2>Acesso R√°pido</h2>
          <div class="quick-access-grid">
            <a class="quick-card" (click)="navigateToClinics('')">
              <div class="quick-icon clinics">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                  <polyline points="9 22 9 12 15 12 15 22"/>
                </svg>
              </div>
              <div class="quick-content">
                <h3>Cl√≠nicas</h3>
                <p>Gerenciar cl√≠nicas cadastradas</p>
              </div>
              <svg class="quick-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="9 18 15 12 9 6"/>
              </svg>
            </a>

            <a class="quick-card" (click)="navigateToPlans()">
              <div class="quick-icon plans">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="2" y="7" width="20" height="14" rx="2" ry="2"/>
                  <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/>
                </svg>
              </div>
              <div class="quick-content">
                <h3>Planos</h3>
                <p>Gerenciar planos de assinatura</p>
              </div>
              <svg class="quick-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="9 18 15 12 9 6"/>
              </svg>
            </a>

            <a class="quick-card" (click)="navigateToOwners()">
              <div class="quick-icon owners">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                  <circle cx="9" cy="7" r="4"/>
                  <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                  <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                </svg>
              </div>
              <div class="quick-content">
                <h3>Propriet√°rios</h3>
                <p>Gerenciar propriet√°rios de cl√≠nicas</p>
              </div>
              <svg class="quick-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="9 18 15 12 9 6"/>
              </svg>
            </a>

            <a class="quick-card" (click)="navigateToSubdomains()">
              <div class="quick-icon subdomains">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"/>
                  <line x1="2" y1="12" x2="22" y2="12"/>
                  <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
                </svg>
              </div>
              <div class="quick-content">
                <h3>Subdom√≠nios</h3>
                <p>Configurar subdom√≠nios personalizados</p>
              </div>
              <svg class="quick-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="9 18 15 12 9 6"/>
              </svg>
            </a>

            <div class="quick-card disabled">
              <div class="quick-icon analytics">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M3 3v18h18"/>
                  <path d="M18 17V9"/>
                  <path d="M13 17V5"/>
                  <path d="M8 17v-3"/>
                </svg>
              </div>
              <div class="quick-content">
                <h3>Analytics Avan√ßado</h3>
                <p>An√°lises e insights detalhados</p>
                <span class="coming-soon">Em breve</span>
              </div>
            </div>

            <div class="quick-card disabled">
              <div class="quick-icon reports">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                  <polyline points="14 2 14 8 20 8"/>
                  <line x1="16" y1="13" x2="8" y2="13"/>
                  <line x1="16" y1="17" x2="8" y2="17"/>
                  <polyline points="10 9 9 9 8 9"/>
                </svg>
              </div>
              <div class="quick-content">
                <h3>Relat√≥rios</h3>
                <p>Relat√≥rios e exporta√ß√µes</p>
                <span class="coming-soon">Em breve</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Subscription Status Distribution -->
        <div class="section">
          <h2>Distribui√ß√£o de Assinaturas por Status</h2>
          <div class="distribution-grid">
            @for (item of getSubscriptionStatusItems(); track item.key) {
              <div class="distribution-card">
                <div class="distribution-value">{{ item.value }}</div>
                <div class="distribution-label">{{ item.label }}</div>
              </div>
            }
          </div>
        </div>

        <!-- Subscription Plan Distribution -->
        <div class="section">
          <h2>Distribui√ß√£o de Assinaturas por Plano</h2>
          <div class="distribution-grid">
            @for (item of getSubscriptionPlanItems(); track item.key) {
              <div class="distribution-card">
                <div class="distribution-value">{{ item.value }}</div>
                <div class="distribution-label">{{ item.label }}</div>
              </div>
            }
          </div>
        </div>

        <!-- Quick Actions -->
        <div class="quick-actions">
          <h2>A√ß√µes R√°pidas</h2>
          <div class="actions-grid">
            <button class="action-btn" (click)="navigateToClinics('')">
              <span class="action-icon">üìã</span>
              <span class="action-text">Gerenciar Cl√≠nicas</span>
            </button>
            <button class="action-btn" (click)="navigateToPlans()">
              <span class="action-icon">üíé</span>
              <span class="action-text">Planos de Assinatura</span>
            </button>
            <button class="action-btn" (click)="navigateToOwners()">
              <span class="action-icon">üë§</span>
              <span class="action-text">Gerenciar Propriet√°rios</span>
            </button>
            <button class="action-btn" (click)="navigateToSubdomains()">
              <span class="action-icon">üåê</span>
              <span class="action-text">Configurar Subdom√≠nios</span>
            </button>
          </div>
        </div>
      }
    </div>
