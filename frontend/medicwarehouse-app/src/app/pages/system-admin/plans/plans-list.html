<app-navbar></app-navbar>

<div class="plans-list">
      <div class="header">
        <div>
          <h1>Gerenciar Planos de Assinatura</h1>
          <p class="subtitle">Configure os planos dispon√≠veis para as cl√≠nicas</p>
        </div>
        <button class="btn btn-primary" (click)="openCreateModal()">
          <span>‚ûï Novo Plano</span>
        </button>
      </div>

      @if (loading()) {
        <div class="loading">Carregando planos...</div>
      } @else if (error()) {
        <div class="error">
          <p>Erro: {{ error() }}</p>
          <button (click)="loadPlans()" class="btn-retry">Tentar novamente</button>
        </div>
      } @else {
        <div class="table-container">
          <table class="plans-table">
            <thead>
              <tr>
                <th>Plano</th>
                <th>Pre√ßo Mensal</th>
                <th>Pre√ßo Anual</th>
                <th>Trial (dias)</th>
                <th>Max Usu√°rios</th>
                <th>Max Pacientes</th>
                <th>Status</th>
                <th>A√ß√µes</th>
              </tr>
            </thead>
            <tbody>
              @for (plan of plans(); track plan.id) {
                <tr>
                  <td>
                    <div class="plan-info">
                      <div class="plan-name">{{ plan.name }}</div>
                      @if (plan.description) {
                        <div class="plan-desc">{{ plan.description }}</div>
                      }
                    </div>
                  </td>
                  <td>{{ formatCurrency(plan.monthlyPrice) }}</td>
                  <td>{{ formatCurrency(plan.yearlyPrice) }}</td>
                  <td>{{ plan.trialDays }} dias</td>
                  <td>{{ plan.maxUsers }}</td>
                  <td>{{ plan.maxPatients }}</td>
                  <td>
                    <span class="status-badge" [class.active]="plan.isActive" [class.inactive]="!plan.isActive">
                      {{ plan.isActive ? '‚úÖ Ativo' : 'üö´ Inativo' }}
                    </span>
                  </td>
                  <td>
                    <div class="actions">
                      <button class="btn-icon" (click)="openEditModal(plan)" title="Editar">
                        ‚úèÔ∏è
                      </button>
                      <button 
                        class="btn-icon" 
                        [class.btn-danger]="plan.isActive"
                        [class.btn-success]="!plan.isActive"
                        (click)="toggleStatus(plan.id, plan.isActive)" 
                        [title]="plan.isActive ? 'Desativar' : 'Ativar'"
                      >
                        {{ plan.isActive ? 'üö´' : '‚úÖ' }}
                      </button>
                      <button class="btn-icon btn-danger" (click)="deletePlan(plan.id)" title="Excluir">
                        üóëÔ∏è
                      </button>
                    </div>
                  </td>
                </tr>
              }
            </tbody>
          </table>

          @if (plans().length === 0) {
            <div class="empty-state">
              <p>Nenhum plano cadastrado</p>
            </div>
          }
        </div>
      }

      <!-- Create/Edit Modal -->
      @if (showModal) {
        <div class="modal-overlay" (click)="closeModal()">
          <div class="modal" (click)="$event.stopPropagation()">
            <div class="modal-header">
              <h2>{{ editingPlan ? 'Editar Plano' : 'Criar Novo Plano' }}</h2>
              <button class="btn-close" (click)="closeModal()">‚úï</button>
            </div>
            
            <form (ngSubmit)="onSubmit()" class="modal-body">
              <div class="form-group">
                <label>Nome do Plano *</label>
                <input
                  type="text"
                  [(ngModel)]="formData.name"
                  name="name"
                  required
                  placeholder="Ex: Plano B√°sico"
                />
              </div>

              <div class="form-group">
                <label>Descri√ß√£o</label>
                <textarea
                  [(ngModel)]="formData.description"
                  name="description"
                  rows="3"
                  placeholder="Descri√ß√£o opcional do plano"
                ></textarea>
              </div>

              <div class="form-grid">
                <div class="form-group">
                  <label>Pre√ßo Mensal (R$) *</label>
                  <input
                    type="number"
                    [(ngModel)]="formData.monthlyPrice"
                    name="monthlyPrice"
                    required
                    min="0"
                    step="0.01"
                    placeholder="0.00"
                  />
                </div>

                <div class="form-group">
                  <label>Pre√ßo Anual (R$) *</label>
                  <input
                    type="number"
                    [(ngModel)]="formData.yearlyPrice"
                    name="yearlyPrice"
                    required
                    min="0"
                    step="0.01"
                    placeholder="0.00"
                  />
                </div>

                <div class="form-group">
                  <label>Dias de Trial *</label>
                  <input
                    type="number"
                    [(ngModel)]="formData.trialDays"
                    name="trialDays"
                    required
                    min="0"
                    placeholder="14"
                  />
                </div>

                <div class="form-group">
                  <label>Max Usu√°rios *</label>
                  <input
                    type="number"
                    [(ngModel)]="formData.maxUsers"
                    name="maxUsers"
                    required
                    min="1"
                    placeholder="10"
                  />
                </div>

                <div class="form-group">
                  <label>Max Pacientes *</label>
                  <input
                    type="number"
                    [(ngModel)]="formData.maxPatients"
                    name="maxPatients"
                    required
                    min="1"
                    placeholder="100"
                  />
                </div>

                @if (editingPlan) {
                  <div class="form-group">
                    <label>Status</label>
                    <select [(ngModel)]="formDataUpdate.isActive" name="isActive">
                      <option [value]="true">Ativo</option>
                      <option [value]="false">Inativo</option>
                    </select>
                  </div>
                }
              </div>

              @if (modalError()) {
                <div class="error-message">{{ modalError() }}</div>
              }
            </form>

            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" (click)="closeModal()">
                Cancelar
              </button>
              <button type="button" class="btn btn-primary" (click)="onSubmit()" [disabled]="submitting()">
                @if (submitting()) {
                  <span>Salvando...</span>
                } @else {
                  <span>{{ editingPlan ? 'Salvar' : 'Criar' }}</span>
                }
              </button>
            </div>
          </div>
        </div>
      }
    </div>
