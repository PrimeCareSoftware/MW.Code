<div class="diagnostic-hypothesis-form">
      <h3>Hip√≥teses Diagn√≥sticas (CFM 1.821/2007)</h3>
      <p class="info-text">
        Registro obrigat√≥rio de hip√≥teses diagn√≥sticas com c√≥digo CID-10 conforme CFM 1.821/2007.
        √â necess√°rio ao menos uma hip√≥tese diagn√≥stica principal.
      </p>

      @if (errorMessage()) {
        <div class="alert alert-error">{{ errorMessage() }}</div>
      }
      @if (successMessage()) {
        <div class="alert alert-success">{{ successMessage() }}</div>
      }

      <!-- List of Existing Hypotheses -->
      @if (existingHypotheses().length > 0) {
        <div class="existing-hypotheses">
          <h4>Diagn√≥sticos Registrados</h4>
          @for (hypothesis of existingHypotheses(); track hypothesis.id) {
            <div class="hypothesis-item" [class.principal]="hypothesis.type === 1">
              <div class="hypothesis-header">
                <div class="hypothesis-info">
                  <span class="hypothesis-type" [class.principal]="hypothesis.type === 1">
                    {{ hypothesis.type === 1 ? '‚≠ê Principal' : 'Secund√°rio' }}
                  </span>
                  <span class="hypothesis-code">CID-10: {{ hypothesis.icd10Code }}</span>
                </div>
                <button
                  type="button"
                  class="btn-delete"
                  (click)="deleteHypothesis(hypothesis.id)"
                  [disabled]="isDeletingId() === hypothesis.id"
                  title="Excluir diagn√≥stico"
                >
                  {{ isDeletingId() === hypothesis.id ? '...' : 'üóëÔ∏è' }}
                </button>
              </div>
              <div class="hypothesis-description">{{ hypothesis.description }}</div>
              <div class="hypothesis-date">
                <small>Data: {{ hypothesis.diagnosedAt | date: 'dd/MM/yyyy' }}</small>
              </div>
            </div>
          }
        </div>
      }

      <!-- Form to Add New Hypothesis -->
      <div class="add-hypothesis-section">
        <h4>{{ editingHypothesis() ? 'Editar' : 'Adicionar' }} Diagn√≥stico</h4>
        
        <form [formGroup]="hypothesisForm" (ngSubmit)="onSubmit()">
          <div class="form-row">
            <div class="form-group col-md-8">
              <label for="description">Descri√ß√£o do Diagn√≥stico *</label>
              <textarea
                id="description"
                formControlName="description"
                rows="3"
                placeholder="Descreva a hip√≥tese diagn√≥stica..."
                [class.invalid]="isFieldInvalid('description')"
              ></textarea>
              @if (isFieldInvalid('description')) {
                <small class="error-text">Descri√ß√£o √© obrigat√≥ria (m√≠nimo 5 caracteres)</small>
              }
            </div>

            <div class="form-group col-md-4">
              <label for="type">Tipo *</label>
              <select
                id="type"
                formControlName="type"
                [class.invalid]="isFieldInvalid('type')"
              >
                <option value="">Selecione...</option>
                <option value="1">‚≠ê Principal</option>
                <option value="2">Secund√°rio</option>
              </select>
              @if (isFieldInvalid('type')) {
                <small class="error-text">Tipo √© obrigat√≥rio</small>
              }
              @if (!hasPrincipalDiagnosis() && hypothesisForm.get('type')?.value !== 'Principal') {
                <small class="warning-text">
                  ‚ö†Ô∏è √â necess√°rio ao menos um diagn√≥stico principal
                </small>
              }
            </div>
          </div>

          <div class="form-row">
            <div class="form-group col-md-6">
              <label for="icdCode">C√≥digo CID-10 *</label>
              <input
                type="text"
                id="icdCode"
                formControlName="icdCode"
                placeholder="Ex: A00, J20.9, Z99.01"
                (input)="onIcdCodeInput($event)"
                [class.invalid]="isFieldInvalid('icdCode')"
                [class.valid]="hypothesisForm.get('icdCode')?.valid && hypothesisForm.get('icdCode')?.value"
              />
              @if (isFieldInvalid('icdCode')) {
                <small class="error-text">
                  C√≥digo CID-10 inv√°lido. Formato: letra(s) seguida de n√∫meros (ex: A00, J20.9)
                </small>
              }
              @if (hypothesisForm.get('icdCode')?.valid && hypothesisForm.get('icdCode')?.value) {
                <small class="success-text">‚úì Formato v√°lido</small>
              }
              <small class="help-text">
                Formato: 1-3 letras + 2 d√≠gitos + opcional (.1 d√≠gito)
              </small>
            </div>
          </div>

          <!-- CID-10 Quick Search Helper -->
          <div class="cid-search-helper">
            <h5>üîç Busca R√°pida CID-10</h5>
            <div class="search-examples">
              <p><strong>Exemplos comuns:</strong></p>
              <div class="examples-grid">
                <button type="button" class="example-btn" (click)="fillCidExample('J06.9')">
                  J06.9 - Infec√ß√£o respirat√≥ria aguda
                </button>
                <button type="button" class="example-btn" (click)="fillCidExample('E11')">
                  E11 - Diabetes mellitus tipo 2
                </button>
                <button type="button" class="example-btn" (click)="fillCidExample('I10')">
                  I10 - Hipertens√£o essencial
                </button>
                <button type="button" class="example-btn" (click)="fillCidExample('K29.7')">
                  K29.7 - Gastrite n√£o especificada
                </button>
                <button type="button" class="example-btn" (click)="fillCidExample('M79.1')">
                  M79.1 - Mialgia
                </button>
                <button type="button" class="example-btn" (click)="fillCidExample('R51')">
                  R51 - Cefaleia
                </button>
              </div>
              <small class="help-text">
                üí° Dica: Em produ√ß√£o, integrar com base de dados CID-10 completa para busca avan√ßada
              </small>
            </div>
          </div>

          <div class="form-actions">
            @if (editingHypothesis()) {
              <button
                type="button"
                class="btn btn-secondary"
                (click)="cancelEdit()"
                [disabled]="isSaving()"
              >
                Cancelar Edi√ß√£o
              </button>
            }
            <button
              type="submit"
              class="btn btn-primary"
              [disabled]="hypothesisForm.invalid || isSaving()"
            >
              {{ isSaving() ? 'Salvando...' : (editingHypothesis() ? 'Atualizar' : 'Adicionar') }} Diagn√≥stico
            </button>
          </div>
        </form>
      </div>
    </div>
