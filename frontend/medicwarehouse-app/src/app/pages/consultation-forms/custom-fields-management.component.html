<app-navbar></app-navbar>

<div class="page-container">
  <div class="page-header">
    <div class="header-content">
      <h1 class="page-title">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="icon">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
          <polyline points="14 2 14 8 20 8"/>
          <line x1="16" y1="13" x2="8" y2="13"/>
          <line x1="16" y1="17" x2="8" y2="17"/>
        </svg>
        Gerenciar Campos Personalizados por Especialidade
      </h1>
      <p class="page-description">
        Configure campos personalizados específicos para cada tipo de especialidade médica
      </p>
    </div>
    <app-help-button 
      helpContext="custom-fields-management"
      helpText="Gerencie campos personalizados para diferentes especialidades médicas. Cada especialidade pode ter seus próprios campos específicos que serão exibidos nas telas de atendimento.">
    </app-help-button>
  </div>

  <!-- Alert Messages -->
  @if (errorMessage()) {
    <div class="alert alert-error">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"/>
        <line x1="12" y1="8" x2="12" y2="12"/>
        <line x1="12" y1="16" x2="12.01" y2="16"/>
      </svg>
      {{ errorMessage() }}
    </div>
  }

  @if (successMessage()) {
    <div class="alert alert-success">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="20 6 9 17 4 12"/>
      </svg>
      {{ successMessage() }}
    </div>
  }

  <!-- Specialty Selection -->
  @if (!selectedSpecialty()) {
    <div class="specialty-grid">
      @for (specialty of specialties(); track specialty.value) {
        <button 
          class="specialty-card"
          (click)="selectSpecialty(specialty.value)"
          type="button">
          <div class="specialty-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
            </svg>
          </div>
          <div class="specialty-info">
            <h3>{{ specialty.label }}</h3>
            <p>{{ specialty.description }}</p>
          </div>
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="chevron">
            <polyline points="9 18 15 12 9 6"/>
          </svg>
        </button>
      }
    </div>
  }

  <!-- Custom Fields Editor -->
  @if (selectedSpecialty()) {
    <div class="fields-editor">
      <div class="editor-header">
        <button 
          class="btn btn-secondary"
          (click)="backToSpecialtySelection()"
          type="button">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="19" y1="12" x2="5" y2="12"/>
            <polyline points="12 19 5 12 12 5"/>
          </svg>
          Voltar
        </button>
        <h2>
          Campos Personalizados - {{ getSelectedSpecialtyLabel() }}
        </h2>
      </div>

      <form [formGroup]="customFieldsForm" (ngSubmit)="saveConfiguration()">
        <div class="fields-list" formArrayName="fields">
          @if (fields.length === 0) {
            <div class="empty-state">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                <line x1="9" y1="9" x2="15" y2="9"/>
                <line x1="9" y1="15" x2="15" y2="15"/>
              </svg>
              <p>Nenhum campo personalizado configurado para esta especialidade.</p>
              <p class="empty-hint">Clique em "Adicionar Campo" para começar.</p>
            </div>
          }

          @for (field of fields.controls; track $index; let i = $index) {
            <div class="field-card" [formGroupName]="i">
              <div class="field-header">
                <span class="field-order">{{ i + 1 }}</span>
                <div class="field-actions">
                  <button 
                    type="button"
                    class="btn-icon"
                    (click)="moveFieldUp(i)"
                    [disabled]="i === 0"
                    title="Mover para cima">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <polyline points="18 15 12 9 6 15"/>
                    </svg>
                  </button>
                  <button 
                    type="button"
                    class="btn-icon"
                    (click)="moveFieldDown(i)"
                    [disabled]="i === fields.length - 1"
                    title="Mover para baixo">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <polyline points="6 9 12 15 18 9"/>
                    </svg>
                  </button>
                  <button 
                    type="button"
                    class="btn-icon btn-danger"
                    (click)="removeField(i)"
                    title="Remover campo">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <polyline points="3 6 5 6 21 6"/>
                      <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                    </svg>
                  </button>
                </div>
              </div>

              <div class="field-body">
                <div class="form-row">
                  <div class="form-group">
                    <label class="form-label">
                      Chave do Campo <span class="required">*</span>
                    </label>
                    <input 
                      type="text"
                      class="form-control"
                      formControlName="fieldKey"
                      placeholder="ex: peso_atual">
                    <small class="form-hint">Identificador único (sem espaços, use underscore)</small>
                  </div>

                  <div class="form-group">
                    <label class="form-label">
                      Rótulo <span class="required">*</span>
                    </label>
                    <input 
                      type="text"
                      class="form-control"
                      formControlName="label"
                      placeholder="ex: Peso Atual">
                  </div>

                  <div class="form-group">
                    <label class="form-label">
                      Tipo de Campo <span class="required">*</span>
                    </label>
                    <select class="form-control" formControlName="fieldType">
                      @for (type of fieldTypes; track type.value) {
                        <option [value]="type.value">{{ type.label }}</option>
                      }
                    </select>
                  </div>
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label class="form-label">Texto de Ajuda</label>
                    <input 
                      type="text"
                      class="form-control"
                      formControlName="helpText"
                      placeholder="Texto explicativo sobre o campo">
                  </div>

                  <div class="form-group">
                    <label class="form-label">Placeholder</label>
                    <input 
                      type="text"
                      class="form-control"
                      formControlName="placeholder"
                      placeholder="ex: Digite o peso em kg">
                  </div>

                  <div class="form-group">
                    <label class="form-label">Valor Padrão</label>
                    <input 
                      type="text"
                      class="form-control"
                      formControlName="defaultValue"
                      placeholder="Valor inicial do campo">
                  </div>
                </div>

                <div class="form-row">
                  <div class="form-group checkbox-group">
                    <label class="checkbox-label">
                      <input 
                        type="checkbox"
                        formControlName="isRequired">
                      <span>Campo obrigatório</span>
                    </label>
                  </div>
                </div>

                <!-- Options for select fields -->
                @if (needsOptions(field.get('fieldType')?.value)) {
                  <div class="options-section">
                    <label class="form-label">Opções</label>
                    @for (option of field.get('options')?.value || []; track $index; let optIndex = $index) {
                      <div class="option-row">
                        <input 
                          type="text"
                          class="form-control"
                          [value]="option"
                          (input)="onOptionInput(i, optIndex, $event)"
                          placeholder="Digite a opção">
                        <button 
                          type="button"
                          class="btn-icon btn-danger"
                          (click)="removeOption(i, optIndex)"
                          title="Remover opção">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                          </svg>
                        </button>
                      </div>
                    }
                    <button 
                      type="button"
                      class="btn btn-secondary btn-sm"
                      (click)="addOption(i)">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"/>
                        <line x1="5" y1="12" x2="19" y2="12"/>
                      </svg>
                      Adicionar Opção
                    </button>
                  </div>
                }
              </div>
            </div>
          }
        </div>

        <div class="actions-bar">
          <button 
            type="button"
            class="btn btn-secondary"
            (click)="addField()">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="12" y1="5" x2="12" y2="19"/>
              <line x1="5" y1="12" x2="19" y2="12"/>
            </svg>
            Adicionar Campo
          </button>

          <button 
            type="submit"
            class="btn btn-primary"
            [disabled]="isLoading() || customFieldsForm.invalid">
            @if (isLoading()) {
              <span class="spinner"></span>
            } @else {
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="20 6 9 17 4 12"/>
              </svg>
            }
            Salvar Configuração
          </button>
        </div>
      </form>
    </div>
  }
</div>
